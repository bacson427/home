<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HPBD_DUONG_19 | RED GALAXY EDITION</title>
    <style>
        /* --- IMPORT FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Black+Ops+One&family=Dancing+Script:wght@700&family=Quicksand:wght@600&display=swap');
        
        /* --- C·∫§U H√åNH C∆† B·∫¢N (N·ªÄN V≈® TR·ª§ ƒê·ªé) --- */
        body { margin: 0; overflow: hidden; background-color: #1a0005; font-family: 'Share Tech Mono', monospace; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        /* --- M√ÄN H√åNH ƒê·∫æM NG∆Ø·ª¢C (RED THEME) --- */
        #countdown-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a0005; /* N·ªÅn ƒë·ªè t·ªëi */
            z-index: 10000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #FF4500; /* Ch·ªØ m√†u ƒë·ªè cam */
            font-family: 'Share Tech Mono';
        }
        
        /* Hi·ªáu ·ª©ng Matrix m√†u ƒë·ªè */
        .matrix-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.2; pointer-events: none; z-index: -1;
            background-image: linear-gradient(0deg, transparent 24%, rgba(255, 50, 0, .3) 25%, rgba(255, 50, 0, .3) 26%, transparent 27%, transparent 74%, rgba(255, 50, 0, .3) 75%, rgba(255, 50, 0, .3) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(255, 50, 0, .3) 25%, rgba(255, 50, 0, .3) 26%, transparent 27%, transparent 74%, rgba(255, 50, 0, .3) 75%, rgba(255, 50, 0, .3) 76%, transparent 77%, transparent);
            background-size: 30px 30px;
        }

        #timer {
            font-size: clamp(40px, 12vw, 80px); font-weight: bold;
            text-shadow: 0 0 25px #FF4500; margin: 20px 0; /* B√≥ng ƒë·ªè cam */
            letter-spacing: 2px; color: #FFD700; /* S·ªë m√†u v√†ng cho n·ªïi */
        }
        
        .lock-title { font-size: 18px; letter-spacing: 4px; color: #ff6b6b; text-transform: uppercase; text-align: center;}
        .lock-status { color: #FF0000; animation: blink 1s infinite; margin-top: 10px; font-size: 14px; text-shadow: 0 0 10px #FF0000;}

        /* N√∫t Admin B√°nh RƒÉng (ƒê·ªè) */
        #admin-btn {
            position: fixed; bottom: 25px; right: 25px;
            width: 45px; height: 45px;
            cursor: pointer; z-index: 10001;
            opacity: 0.5; transition: all 0.5s ease;
            fill: #FF0000; filter: drop-shadow(0 0 8px #FF0000);
        }
        #admin-btn:hover { opacity: 1; transform: rotate(180deg) scale(1.1); fill: #FFD700; filter: drop-shadow(0 0 15px #FFD700);}
        #admin-btn svg { width: 100%; height: 100%; }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; z-index: 999; pointer-events: none;
        }

        /* N√∫t Cyber (T√¥ng ƒë·ªè/v√†ng) */
        .cyber-btn {
            pointer-events: auto; background: rgba(30, 0, 0, 0.7); color: #FFD700; border: 2px solid #FF4500;
            padding: 15px 40px; font-size: 16px; cursor: pointer; 
            font-family: 'Black Ops One', cursive; letter-spacing: 2px;
            box-shadow: 0 0 20px #FF4500; transition: 0.3s;
            animation: pulse 2s infinite; 
            border-radius: 50px;
            text-shadow: 0 0 10px #FF4500; text-transform: uppercase;
            backdrop-filter: blur(5px);
        }
        .cyber-btn:hover { background: #FF4500; color: #fff; box-shadow: 0 0 50px #FF4500; transform: scale(1.05); }

        /* --- 3D CUBE (T√¥ng ƒë·ªè) --- */
        #cube-container { display: none; perspective: 800px; width: 120px; height: 120px; margin-bottom: 30px;}
        #cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: spin 4s infinite linear; }
        .face {
            position: absolute; width: 116px; height: 116px;
            border: 2px solid #FF0000; background: rgba(255, 0, 0, 0.2);
            color: #FFD700; font-size: 60px; display: flex;
            justify-content: center; align-items: center;
            font-family: 'Black Ops One'; box-shadow: 0 0 25px #FF0000;
            border-radius: 15px;
        }
        .front { transform: translateZ(60px); } .back { transform: rotateY(180deg) translateZ(60px); }
        .right { transform: rotateY(90deg) translateZ(60px); } .left { transform: rotateY(-90deg) translateZ(60px); }
        .top { transform: rotateX(90deg) translateZ(60px); } .bottom { transform: rotateX(-90deg) translateZ(60px); }

        /* --- MESSAGE LAYER (V≈© tr·ª• ƒë·ªè) --- */
        #msg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* Gradient ƒë·ªè th·∫´m */
            background: radial-gradient(circle, rgba(80, 0, 20, 0.9) 0%, rgba(20, 0, 5, 0.98) 100%);
            display: none; z-index: 3000; opacity: 0;
            flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box; transition: opacity 1.5s ease-in-out;
        }
        #msg-layer.visible { opacity: 1; }

        #msg-content {
            color: #ffc2d1; /* M√†u ch·ªØ h·ªìng ph·∫•n */
            font-size: clamp(16px, 4.5vw, 20px); 
            line-height: 1.8; font-family: 'Quicksand', sans-serif; font-weight: 600;
            white-space: pre-wrap; word-wrap: break-word; 
            width: 90%; max-width: 500px; max-height: 60vh; overflow-y: auto;
            text-shadow: 0 0 2px rgba(0,0,0,0.5); 
            padding: 30px; 
            
            /* Giao di·ªán k√≠nh ƒë·ªè */
            background: rgba(100, 0, 30, 0.5); 
            border-radius: 30px; 
            border: 2px solid rgba(255, 105, 180, 0.4);
            box-shadow: 0 15px 50px rgba(50, 0, 10, 0.8), inset 0 0 20px rgba(255, 0, 50, 0.2);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        }
        
        #skip-btn { 
            margin-top: 30px; padding: 12px 40px; border: 2px solid #FFD700; 
            background: rgba(50, 0, 0, 0.5); color: #FFD700; display: none; pointer-events: auto; 
            font-weight: bold; cursor: pointer; transition: 0.3s; 
            border-radius: 50px;
            font-family: 'Share Tech Mono'; letter-spacing: 1px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        #skip-btn:hover { background: #FFD700; color: #500000; box-shadow: 0 0 35px #FFD700; transform: translateY(-3px);}

        /* --- TERMINAL (Giao di·ªán ƒê·ªè) --- */
        #virus-terminal { 
            position: absolute; top: 5%; left: 5%; width: 90%; height: 90%; 
            color: #FF4500; /* Ch·ªØ ƒë·ªè cam */
            font-family: 'Share Tech Mono'; font-size: 13px; display: none; z-index: 2001; 
            background: rgba(30, 0, 0, 0.95); /* N·ªÅn ƒë·ªè r·∫•t t·ªëi */
            padding: 20px; box-sizing: border-box; 
            line-height: 1.5; text-shadow: 0 0 8px #FF0000;
            overflow-y: auto; white-space: pre-wrap;
            border-radius: 20px;
            border: 2px solid rgba(255, 0, 0, 0.4);
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.2) inset;
        }
        #virus-terminal::-webkit-scrollbar-thumb { background: #FF4500; }

        /* --- TRANSITION OVERLAY --- */
        #transition-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFF; z-index: 9999; display: none; opacity: 0;
            flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 2s ease-in-out; pointer-events: none;
        }
        #transition-overlay.active { opacity: 1; pointer-events: auto; }

        .heart-loader { font-size: 60px; animation: heartbeat 1s infinite; margin-bottom: 20px;}
        .final-text { color: #FF1493; font-family: 'Dancing Script', cursive; font-size: 26px; font-weight: bold; }

        @keyframes spin { from { transform: rotateX(0) rotateY(0); } to { transform: rotateX(360deg) rotateY(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes heartbeat { 0% { transform: scale(1); } 25% { transform: scale(1.3); } 50% { transform: scale(1); } 75% { transform: scale(1.3); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <canvas id="c"></canvas>
    <div id="virus-terminal"></div>

    <div id="countdown-layer">
        <div class="matrix-bg"></div>
        <div class="lock-title">PROJECT: RED_GALAXY_19</div>
        <div id="timer">00:00:00</div>
        <div class="lock-status">[ SYSTEM LOCKED - RED ALERT ]</div>
        <div class="lock-status" style="font-size: 12px; color: #ff6b6b; margin-top: 5px; animation: none;">Target: 01/03/2026</div>
        
        <div id="admin-btn" onclick="adminUnlock()">
            <svg viewBox="0 0 24 24">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
        </div>
    </div>
    
    <div id="ui-layer">
        <button id="btn-start" class="cyber-btn">K√çCH HO·∫†T H·ªÜ TH·ªêNG</button>
        <div id="cube-container">
            <div id="cube">
                <div class="face front">10</div><div class="face back">10</div>
                <div class="face right">10</div><div class="face left">10</div>
                <div class="face top">10</div><div class="face bottom">10</div>
            </div>
        </div>
    </div>

    <div id="msg-layer">
        <div style="color: #FFD700; font-size: clamp(24px, 7vw, 36px); margin-bottom: 25px; font-family: 'Dancing Script'; text-align:center; text-shadow: 0 0 10px #FFD700;">üíå G·ª≠i D∆∞∆°ng</div>
        <div id="msg-content"></div>
        <button id="skip-btn" onclick="startFinale()">TI·∫æP T·ª§C >></button>
    </div>

    <div id="transition-overlay">
        <div class="heart-loader">‚ù§Ô∏è</div>
        <div class="final-text">ƒê·ª£i t·ªõ m·ªôt ch√∫t...</div>
    </div>

    <audio id="audio" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" loop></audio>

<script>
    // --- C·∫§U H√åNH ---
    const TARGET_DATE = new Date("March 1, 2026 00:00:00").getTime();
    const ADMIN_PASS = "01032007";

    // --- LOGIC ƒê·∫æM NG∆Ø·ª¢C ---
    function updateTimer() {
        const now = new Date().getTime();
        const distance = TARGET_DATE - now;
        if (distance < 0) { unlockSystem(); return; }
        const d = Math.floor(distance / (1000 * 60 * 60 * 24));
        const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((distance % (1000 * 60)) / 1000);
        document.getElementById("timer").innerText = 
            `${d<10?"0"+d:d}:${h<10?"0"+h:h}:${m<10?"0"+m:m}:${s<10?"0"+s:s}`;
    }
    let timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    function unlockSystem() {
        clearInterval(timerInterval);
        document.getElementById("countdown-layer").style.display = "none";
        document.getElementById("ui-layer").style.display = "flex"; 
        loop(); 
    }

    function adminUnlock() {
        let pass = prompt("NH·∫¨P M√É QU·∫¢N TR·ªä (RED ACCESS):");
        if (pass === ADMIN_PASS) { alert("X√ÅC NH·∫¨N: ADMIN"); unlockSystem(); } 
        else { alert("M·∫¨T KH·∫®U SAI! H·ªÜ TH·ªêNG B√ÅO ƒê·ªòNG!"); }
    }

    // --- N·ªòI DUNG TH∆Ø ---
    const LETTER = `Ch√∫c m·ª´ng sinh nh·∫≠t tu·ªïi 19, c√¥ g√°i H√† Nam xinh ƒë·∫πp! üéÇ

Ch√∫c c√¥ sinh vi√™n ƒê·∫°i h·ªçc Ph∆∞∆°ng ƒê√¥ng sang tu·ªïi m·ªõi h·ªçc t·∫≠p th·∫≠t t·ªët, lu√¥n vui v·∫ª v√† b·ªõt suy nghƒ© linh tinh nh√©.

D√π c√≥ b·∫≠n deadline th√¨ c≈©ng nh·ªõ ƒÉn u·ªëng ƒë·∫ßy ƒë·ªß (ƒë·∫∑c bi·ªát l√† ƒëi ƒÉn nem n∆∞·ªõng cho ƒë·ª° th√®m nha). üç¢

Mong r·∫±ng m·ªçi ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t s·∫Ω ƒë·∫øn v·ªõi c·∫≠u. Happy Birthday, my special girl! ‚ù§Ô∏è

-- Nguy·ªÖn B·∫Øc S∆°n --`;

    const SCRIPT = [
        { t: "K·∫æT N·ªêI V·ªÜ TINH\nQU√âT D·ªÆ LI·ªÜU...", c: "#FF4500" }, /* ƒê·ªè cam */
        { t: "T√åM TH·∫§Y M·ª§C TI√äU\nTR∆Ø∆†NG TH·ªä D∆Ø∆†NG", c: "#FF0000" }, /* ƒê·ªè t∆∞∆°i */
        { t: "CH√ÄO C√î G√ÅI\nƒêH PH∆Ø∆†NG ƒê√îNG", c: "#FF69B4" }, /* H·ªìng */
        { t: "HAPPY BIRTHDAY\nTU·ªîI 19 R·ª∞C R·ª†", c: "#FFD700" }, /* V√†ng */
        { action: "HEART_TREND" } 
    ];

    const TERMINAL_LOGS = [
        "> INITIALIZING_RED_KERNEL...", "> ACCESSING_DATABASE... [OK]", "> SEARCH: 'TRUONG_THI_DUONG'", 
        "> DOB: 01/03/2007", "> LOCATION: HA_NAM", "> STATUS: STUDENT @ PHUONG_DONG", 
        "> FAVORITE: 'NEM_NUONG' (100%)", "> LOADING_CUTENESS... 100%", 
        "> DECRYPTING: 'RED_LOVE_GIFT.EXE'", "> SYSTEM_READY.", 
        "> 3...", "> 2...", "> 1...", "> STARTING_RED_SHOW!"
    ];

    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const isMobile = window.innerWidth < 768;
    let w, h;

    const DOT_GAP = isMobile ? 4 : 3; 
    const DOT_SIZE = isMobile ? 1.5 : 1.2; 
    let state = "IDLE"; 
    let particles = [], fireworks = [], sparkles = [], spotlights = [], bgStars = [], shootingStars = [];
    let scriptIdx = 0, countdown = 10;

    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
        bgStars = [];
        for(let i=0; i<(isMobile?80:200); i++) bgStars.push({x: Math.random()*w, y: Math.random()*h, size: Math.random()*1.5, opacity: Math.random(), blinkSpeed: 0.005+Math.random()*0.02});
        spotlights = [];
        let sc = isMobile?3:5;
        // ƒê√®n chi·∫øu s√°ng t√¥ng ƒë·ªè/cam/v√†ng
        for(let i=0; i<sc; i++) spotlights.push({x: (w/(sc-1))*i, angle: -Math.PI/2, baseAngle: -Math.PI/2+(Math.random()-0.5)*0.4, speed: 0.005, width: 0.01, range: 0.15, color: `hsla(${Math.random()*40 - 20}, 100%, 70%, 0.08)`});
    }
    window.addEventListener('resize', resize);
    resize();

    class ShootingStar {
        constructor() {
            this.active=true; this.angle=Math.PI/4; this.size=Math.random()+1; this.speed=Math.random()*3+3; this.len=Math.random()*80+80;
            if(Math.random()<0.5){this.x=Math.random()*w;this.y=-this.len;}else{this.x=-this.len;this.y=Math.random()*h*0.5;}
        }
        update(){this.x+=this.speed*Math.cos(this.angle);this.y+=this.speed*Math.sin(this.angle);if(this.x>w+this.len||this.y>h+this.len)this.active=false;}
        draw(){
            let tx=this.x-this.len*Math.cos(this.angle), ty=this.y-this.len*Math.sin(this.angle);
            // Sao bƒÉng ƒëu√¥i ƒë·ªè tr·∫Øng
            let g=ctx.createLinearGradient(this.x,this.y,tx,ty); g.addColorStop(0,"#FFF"); g.addColorStop(0.5, "#FF4500"); g.addColorStop(1,"transparent");
            ctx.beginPath(); ctx.strokeStyle=g; ctx.lineWidth=2; ctx.moveTo(this.x,this.y); ctx.lineTo(tx,ty); ctx.stroke();
            ctx.beginPath(); ctx.fillStyle="white"; ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill();
        }
    }

    document.getElementById('btn-start').onclick = function() {
        this.style.display = 'none';
        document.getElementById('audio').play().catch(()=>{});
        state = "COUNTDOWN";
        document.getElementById('cube-container').style.display = 'block';
        const faces = document.querySelectorAll('.face');
        let tmr = setInterval(() => {
            countdown--; faces.forEach(f => f.innerText = countdown);
            if(countdown <= 0) { clearInterval(tmr); document.getElementById('cube-container').style.display = 'none'; runVirus(); }
        }, 1000);
    };

    function runVirus() {
        state = "VIRUS";
        const term = document.getElementById('virus-terminal');
        term.style.display = 'block';
        let lineIdx = 0, charIdx = 0, currentText = "";
        function typeLine() {
            if(lineIdx >= TERMINAL_LOGS.length) { setTimeout(() => { term.style.display = 'none'; state = "SHOW"; nextScene(); }, 1000); return; }
            let line = TERMINAL_LOGS[lineIdx];
            term.innerHTML = currentText + line.substring(0, charIdx) + "<span style='color:#FF0000; animation:blink 0.5s infinite'>_</span>";
            if(charIdx < line.length) { charIdx++; setTimeout(typeLine, 20); } 
            else { currentText += line + "<br>"; lineIdx++; charIdx = 0; term.scrollTop = term.scrollHeight; setTimeout(typeLine, 150); }
        }
        typeLine();
    }

    function nextScene() {
        if(scriptIdx >= SCRIPT.length) return;
        let s = SCRIPT[scriptIdx++];
        if(s.action === "HEART_TREND") { runHeartTrend(); return; }
        formText(s.t, s.c); setTimeout(nextScene, 6000); 
    }

    function formText(txt, color) {
        const lines = txt.split('\n');
        const tmp = document.createElement('canvas');
        const tCtx = tmp.getContext('2d');
        let fSize = Math.min(w / 6, 80);
        tCtx.font = `bold ${fSize}px Arial`;
        let maxW = 0; lines.forEach(l => maxW = Math.max(maxW, tCtx.measureText(l).width));
        tmp.width = maxW + 50; tmp.height = lines.length * fSize * 1.5;
        tCtx.font = `bold ${fSize}px Arial`; tCtx.fillStyle = 'white'; tCtx.textAlign = 'center'; tCtx.textBaseline = 'middle';
        lines.forEach((l, i) => tCtx.fillText(l, tmp.width/2, fSize + i * fSize * 1.2));
        
        const data = tCtx.getImageData(0,0, tmp.width, tmp.height).data;
        let pts = [];
        for(let y=0; y<tmp.height; y+=DOT_GAP) {
            for(let x=0; x<tmp.width; x+=DOT_GAP) {
                if(data[(y*tmp.width + x)*4 + 3] > 128) pts.push({x: (w - tmp.width)/2 + x, y: (h - tmp.height)/2 + y});
            }
        }
        while(particles.length < pts.length) particles.push({x: Math.random()*w, y: Math.random()*h, tx: Math.random()*w, ty: Math.random()*h, c: color, active: true});
        particles.forEach((p, i) => {
            if(i < pts.length) { p.tx = pts[i].x; p.ty = pts[i].y; p.c = color; p.active = true; } 
            else { p.active = false; p.tx = Math.random()*w; p.ty = Math.random()*h; }
        });
    }

    function drawDynamicBackground() {
        bgStars.forEach(s => {
            s.opacity += s.blinkSpeed; if(s.opacity > 1 || s.opacity < 0.2) s.blinkSpeed *= -1;
            ctx.fillStyle = `rgba(255, 200, 200, ${s.opacity})`; ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
        });
        if(Math.random()<0.02) shootingStars.push(new ShootingStar());
        for(let i=shootingStars.length-1; i>=0; i--) { let s=shootingStars[i]; s.update(); s.draw(); if(!s.active) shootingStars.splice(i,1); }
    }

    function runHeartTrend() {
        state = "HEART_TREND";
        let heartPts = [];
        let r = Math.min(w, h) / 35;
        for(let t=0; t<Math.PI*2; t+=0.04) {
            heartPts.push({ x: w/2 + r*16*Math.pow(Math.sin(t),3), y: h/2 - r*(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t)) });
        }
        particles.forEach((p, i) => {
            if(i < heartPts.length) { p.tx = heartPts[i].x; p.ty = heartPts[i].y; p.c = "#FF1493"; p.active = true; } 
            else { p.active = false; }
        });
        setTimeout(runMessage, 8000);
    }

    function runMessage() {
        state = "MSG";
        const layer = document.getElementById('msg-layer');
        layer.style.display = 'flex';
        setTimeout(() => layer.classList.add('visible'), 50);
        let i = 0;
        let t = setInterval(() => {
            document.getElementById('msg-content').innerText = LETTER.substring(0, i) + "_";
            if(++i > LETTER.length) { 
                clearInterval(t); 
                document.getElementById('skip-btn').style.display = 'block'; 
                document.getElementById('msg-content').innerText = LETTER; 
            }
        }, 30);
    }

    window.startFinale = function() {
        state = "FINALE";
        document.getElementById('msg-layer').style.display = 'none';
        // Ph√°o hoa t√¥ng ƒë·ªè/v√†ng/cam
        let fireworkInterval = setInterval(() => { if(fireworks.length < 8) fireworks.push({x: Math.random()*w, y: h, ty: Math.random()*h*0.5, vy: -8-Math.random()*5, c: `hsl(${Math.random()*60},100%,60%)`}); }, 500);
        formText("TU·ªîI 19\nR·ª∞C R·ª† NH√â!", "#FFD700");
        setTimeout(() => { clearInterval(fireworkInterval); goToConfession(); }, 5000); 
    }

    function goToConfession() {
        particles.forEach(p => { p.tx = w/2; p.ty = h/2; });
        const overlay = document.getElementById('transition-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => { overlay.classList.add('active'); }, 100);
        setTimeout(() => { window.location.href = "https://nguyenbacson.io.vn/miss-you/i-love-you/"; }, 2500);
    }

    function loop() {
        if(document.getElementById("countdown-layer").style.display !== "none") { requestAnimationFrame(loop); return; }
        // N·ªÅn ƒë·ªè t·ªëi v·ªõi v·ªát m·ªù ƒë·ªè
        ctx.fillStyle = "rgba(20, 0, 5, 0.25)"; ctx.fillRect(0,0,w,h);
        drawDynamicBackground();
        if(state !== "MSG" && state !== "FINALE") {
            ctx.save(); ctx.globalCompositeOperation = 'lighter';
            spotlights.forEach(s => {
                let g = ctx.createLinearGradient(s.x, h, s.x+Math.cos(s.angle)*h, h+Math.sin(s.angle)*h); g.addColorStop(0, s.color); g.addColorStop(0, "transparent"); 
                ctx.fillStyle = g; ctx.beginPath(); ctx.moveTo(s.x, h); ctx.lineTo(s.x-5, 0); ctx.lineTo(s.x+5, 0); ctx.fill(); 
            });
            ctx.restore();
        }
        particles.forEach(p => {
            p.x += (p.tx - p.x) * 0.08; p.y += (p.ty - p.y) * 0.08;
            if(p.active || state === "HEART_TREND") { ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, DOT_SIZE, 0, Math.PI*2); ctx.fill(); }
        });
        for(let i=fireworks.length-1; i>=0; i--) {
            let f = fireworks[i]; f.y += f.vy; f.vy += 0.15; ctx.fillStyle = f.c; ctx.fillRect(f.x, f.y, 3, 3);
            if(f.vy >= 0) { for(let j=0; j<40; j++) sparkles.push({x: f.x, y: f.y, vx: (Math.random()-0.5)*6, vy: (Math.random()-0.5)*6, c: f.c, l: 1}); fireworks.splice(i,1); }
        }
        for(let i=sparkles.length-1; i>=0; i--) {
            let s = sparkles[i]; s.x += s.vx; s.y += s.vy; s.l -= 0.02; if(s.l <= 0) sparkles.splice(i,1); else { ctx.fillStyle = s.c; ctx.globalAlpha = s.l; ctx.fillRect(s.x, s.y, 2, 2); ctx.globalAlpha = 1; }
        }
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
