<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sơn & [Tên Cô Ấy] - Drone Show</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;800&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* Nền trời đêm chuyển màu nhẹ */
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            font-family: 'Montserrat', sans-serif;
        }

        #canvas {
            display: block;
            /* Tăng độ tương phản để hiệu ứng neon nổi bật hơn */
            filter: contrast(1.1);
        }

        /* Lớp UI chứa nút và chữ */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            pointer-events: none; /* Để chuột bấm xuyên qua canvas */
        }

        /* Nút bắt đầu xịn xò hơn */
        #start-btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            background: transparent;
            border: 2px solid #ff4d6d;
            border-radius: 50px;
            color: #ff4d6d;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 0 15px rgba(255, 77, 109, 0.3);
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            letter-spacing: 2px;
        }

        #start-btn:hover {
            background: #ff4d6d;
            color: white;
            box-shadow: 0 0 30px rgba(255, 77, 109, 0.8);
            transform: scale(1.05);
        }

        /* Chữ tỏ tình cuối cùng */
        #confession-container {
            position: absolute;
            bottom: 15%;
            width: 100%;
            text-align: center;
            opacity: 0;
            transition: opacity 2.5s ease-in-out;
        }

        #confession-main {
            font-family: 'Dancing Script', cursive;
            font-size: 4.5rem;
            color: #ff4d6d;
            /* Hiệu ứng chữ neon phát sáng */
            text-shadow: 0 0 10px #ff4d6d, 0 0 20px #ff4d6d, 0 0 40px #ff0055;
            margin-bottom: 10px;
        }

        #confession-sub {
            font-size: 1.2rem;
            color: #ffabc7;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(255, 77, 109, 0.5);
        }

        /* Hiệu ứng nhấp nháy nhẹ cho chữ */
        .neon-pulse {
            animation: neonAnim 2s infinite alternate;
        }

        @keyframes neonAnim {
            from { text-shadow: 0 0 10px #ff4d6d, 0 0 20px #ff4d6d, 0 0 30px #ff0055; }
            to { text-shadow: 0 0 20px #ff4d6d, 0 0 30px #ff4d6d, 0 0 50px #ff0055, 0 0 70px #ff0055; }
        }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>

    <div class="ui-layer">
        <button id="start-btn">Bắt đầu Drone Show kỷ niệm ❤️</button>
        <div id="confession-container">
            <div id="confession-main" class="neon-pulse">Làm người yêu anh nhé?</div>
            <div id="confession-sub">Chàng Ngố muốn chăm sóc em chính thức từ hôm nay.</div>
        </div>
    </div>

    <audio id="bg-music" src="https://nguyenbacson.io.vn/nguyenbacson-missyou.mp3"></audio>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const music = document.getElementById('bg-music');
        const confessionContainer = document.getElementById('confession-container');

        let drones = [];
        const droneCount = 700; // Tăng số lượng drone lên cho hình dày dặn
        let showStarted = false;
        let currentShapeType = 'none';

        // Canvas full màn hình
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Class Drone với vật lý xịn hơn (Velocity & Friction)
        class Drone {
            constructor() {
                // Vị trí hiện tại
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                // Vận tốc (để tạo quán tính)
                this.vx = 0;
                this.vy = 0;
                // Mục tiêu cần đến
                this.targetX = this.x;
                this.targetY = this.y;
                
                this.size = Math.random() * 2 + 1.5; // Kích thước đa dạng hơn
                // Màu sắc neon hồng/tím
                const hue = Math.random() * 30 + 330; // Dải màu từ 330 đến 360 (hồng đậm đến đỏ nhạt)
                this.color = `hsla(${hue}, 100%, 65%, 1)`;
                
                // Thông số vật lý (Tinh chỉnh để di chuyển mượt)
                this.friction = 0.94; // Lực cản (càng gần 1 càng trơn)
                this.ease = 0.03; // Độ nhạy gia tốc (càng cao càng nhanh)
            }

            // Cập nhật vị trí theo vật lý
            update() {
                // Tính khoảng cách đến mục tiêu
                const dx = this.targetX - this.x;
                const dy = this.targetY - this.y;
                
                // Gia tốc dựa trên khoảng cách (càng xa càng nhanh)
                this.vx += dx * this.ease;
                this.vy += dy * this.ease;
                
                // Áp dụng lực cản để drone không bay quá đà mãi
                this.vx *= this.friction;
                this.vy *= this.friction;
                
                // Cập nhật vị trí
                this.x += this.vx;
                this.y += this.vy;
            }

            // Vẽ drone với hiệu ứng phát sáng (Bloom)
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                // Tạo hiệu ứng glow neon
                ctx.shadowBlur = 15; 
                ctx.shadowColor = this.color;
                ctx.fill();
                // Reset shadow để không ảnh hưởng hiệu năng
                ctx.shadowBlur = 0; 
            }
        }

        // Hàm tạo hình dáng đội hình
        function createShape(type) {
            if (currentShapeType === type) return; // Không tính toán lại nếu đang ở hình đó
            currentShapeType = type;

            let points = [];
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            // Scale dựa trên màn hình, đảm bảo không bị quá to hoặc quá nhỏ
            const scale = Math.min(canvas.width, canvas.height) / 1000; 

            if (type === 'heart') {
                const heartScale = scale * 15;
                for (let i = 0; i < droneCount; i++) {
                    // Công thức hình trái tim
                    const t = Math.PI * 2 * (i / droneCount);
                    const x = 16 * Math.pow(Math.sin(t), 3);
                    const y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                    points.push({ x: centerX + x * heartScale, y: centerY + y * heartScale });
                }
            } 
            // Kỹ thuật dùng canvas ẩn để lấy điểm ảnh từ chữ (cho SB và 28km)
            else if (type === 'SB' || type === '28km') {
                const offScreenCanvas = document.createElement('canvas');
                const offCtx = offScreenCanvas.getContext('2d');
                offScreenCanvas.width = canvas.width;
                offScreenCanvas.height = canvas.height;

                let text = type === 'SB' ? "SB" : "28km";
                let fontSize = scale * 300; // Chữ to để lấy mẫu

                offCtx.font = `900 ${fontSize}px Montserrat`;
                offCtx.fillStyle = '#ffffff';
                offCtx.textAlign = 'center';
                offCtx.textBaseline = 'middle';
                offCtx.fillText(text, offScreenCanvas.width / 2, offScreenCanvas.height / 2);

                // Quét điểm ảnh
                const imageData = offCtx.getImageData(0, 0, offScreenCanvas.width, offScreenCanvas.height).data;
                let validPoints = [];
                // Bước nhảy (step) để không lấy quá nhiều điểm, tối ưu hiệu năng
                let step = 4; 
                for (let y = 0; y < offScreenCanvas.height; y += step) {
                    for (let x = 0; x < offScreenCanvas.width; x += step) {
                        const alpha = imageData[(y * offScreenCanvas.width + x) * 4 + 3];
                        if (alpha > 128) { // Nếu điểm ảnh không trong suốt
                            validPoints.push({ x, y });
                        }
                    }
                }
                
                // Chọn ngẫu nhiên các điểm từ tập điểm hợp lệ để gán cho drone
                for(let i = 0; i < droneCount; i++) {
                    points.push(validPoints[Math.floor(Math.random() * validPoints.length)]);
                }
            }
            
            // Gán mục tiêu mới cho từng drone
            // Sắp xếp ngẫu nhiên để tạo hiệu ứng bay lộn xộn rồi mới xếp hình
            points.sort(() => Math.random() - 0.5);
            for (let i = 0; i < drones.length; i++) {
                // Nếu không đủ điểm, về tâm
                const target = points[i] || {x: centerX, y: centerY};
                drones[i].targetX = target.x;
                drones[i].targetY = target.y;
            }
        }

        // Khởi tạo đàn drone
        function initDrones() {
            drones = [];
            for (let i = 0; i < droneCount; i++) {
                drones.push(new Drone());
            }
        }

        // Vòng lặp animation chính
        function animate() {
            // Mẹo tạo vệt sáng đuôi (Trails): Không xóa sạch canvas mà phủ một lớp đen mờ lên
            ctx.fillStyle = 'rgba(10, 10, 20, 0.15)'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Cập nhật và vẽ từng drone
            drones.forEach(d => {
                d.update();
                d.draw();
            });

            // Logic timeline theo nhạc
            if (showStarted) {
                const time = music.currentTime;
                // Đoạn dạo đầu: Trái tim
                if (time > 1 && time < 10) createShape('heart');
                // Đoạn 1: Kỷ niệm Spicy Box (SB)
                if (time > 12 && time < 25) createShape('SB'); 
                // Đoạn 2: Kỷ niệm chuyến xe 28km
                if (time > 27 && time < 38) createShape('28km'); 
                // Đoạn cao trào (giây 40): Quay lại tim và hiện chữ tỏ tình
                if (time >= 40) {
                    createShape('heart');
                    confessionContainer.style.opacity = '1';
                }
            }
            requestAnimationFrame(animate);
        }

        // Xử lý nút Bắt đầu
        startBtn.addEventListener('click', () => {
            if (!showStarted) {
                showStarted = true;
                // Ẩn nút đi với hiệu ứng mờ dần
                startBtn.style.opacity = '0';
                setTimeout(() => startBtn.style.display = 'none', 500);
                music.play().catch(e => console.log("Cần tương tác để phát nhạc: ", e));
                // Bắt đầu xếp hình đầu tiên ngay lập tức để tránh bị đơ
                createShape('heart'); 
            }
        });

        // Chạy chương trình
        initDrones();
        animate();
    </script>
</body>
</html>
