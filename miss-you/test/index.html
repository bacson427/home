<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPBD & HPNY - Optimized</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;900&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Montserrat', sans-serif;
            color: white;
        }

        /* Nền tối nhẹ nhàng hơn để đỡ ngốn GPU */
        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a0b1a 0%, #000 100%);
            z-index: -1;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        #ui-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            pointer-events: none;
            z-index: 10;
        }

        .btn {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 30px;
            transition: 0.3s;
            backdrop-filter: blur(4px);
            margin-top: 20px;
            display: none;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 20px rgba(255,255,255,0.8);
        }

        #start-btn { display: block; }

        #countdown-display {
            font-size: 15vw; /* Responsive size */
            font-weight: 900;
            text-shadow: 0 0 30px #ff00de;
            display: none;
            opacity: 0.8;
        }
        
        #hidden-youtube { position: absolute; width: 0; height: 0; overflow: hidden; }
    </style>
</head>
<body>

    <div class="bg-layer"></div>
    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <button id="start-btn" class="btn">Bắt Đầu</button>
        <div id="countdown-display">10</div>
        <button id="next-phase-btn" class="btn">Tiếp Tục</button>
        <button id="final-btn" class="btn">Xem Flycam</button>
    </div>

    <div id="hidden-youtube">
        <div id="player"></div>
    </div>

    <script>
        // --- CẤU HÌNH ---
        const NAME = "Trương Thị Dương";
        const BIRTHDAY = "01/03/2007";
        const MOBILE_SCALE = window.innerWidth < 768 ? 0.6 : 1; // Giảm tải cho mobile
        
        // --- YOUTUBE API ---
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100', width: '100', videoId: 'Og25tNifNSs',
                playerVars: { 'playsinline': 1, 'controls': 0, 'loop': 1 },
            });
        }
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // --- CORE LOGIC ---
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // Tối ưu render
        let width, height;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        let state = "IDLE"; 
        let fireworks = [];
        let particles = [];
        let drones = [];

        // UI Controls
        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-phase-btn');
        const finalBtn = document.getElementById('final-btn');
        const countDisplay = document.getElementById('countdown-display');

        startBtn.onclick = () => {
            startBtn.style.display = 'none';
            if(player && typeof player.playVideo === 'function') player.playVideo();
            state = "FIREWORKS";
            launchFireworksPeriod(10000, () => {
                state = "WAITING_1";
                nextBtn.style.display = 'block';
            });
        };

        nextBtn.onclick = () => {
            nextBtn.style.display = 'none';
            state = "COUNTDOWN";
            countDisplay.style.display = 'block';
            let c = 10;
            countDisplay.innerText = c;
            
            let t = setInterval(() => {
                c--;
                if(c > 0) {
                    countDisplay.innerText = c;
                    // Bắn pháo hoa nhẹ khi đếm
                    createFirework(Math.random()*width, height/2, true); 
                } else {
                    clearInterval(t);
                    countDisplay.style.display = 'none';
                    state = "WAITING_2";
                    finalBtn.style.display = 'block';
                }
            }, 1000);
        };

        finalBtn.onclick = () => {
            finalBtn.style.display = 'none';
            startDroneSequence();
        };

        function launchFireworksPeriod(duration, callback) {
            let start = Date.now();
            let interval = setInterval(() => {
                if(Date.now() - start > duration) {
                    clearInterval(interval);
                    if(callback) callback();
                }
                if(Math.random() < 0.1) createFirework(); // Giảm tần suất bắn để đỡ lag
            }, 100); // 100ms bắn 1 lần
        }

        // --- OPTIMIZED DRONE SYSTEM ---
        function startDroneSequence() {
            state = "DRONE";
            // Tạo số lượng drone vừa phải (khoảng 600-800 thay vì 1500)
            let droneCount = window.innerWidth < 768 ? 400 : 700;
            
            for(let i=0; i<droneCount; i++) {
                drones.push({
                    x: Math.random() * width,
                    y: height + 100, // Dưới màn hình
                    tx: Math.random() * width, // Target X
                    ty: Math.random() * height,
                    color: '#fff',
                    speed: 0.03 + Math.random() * 0.02
                });
            }

            // Timeline Kịch bản
            const sequence = [
                { t: 1000, txt: "CHÚC MỪNG" },
                { t: 5000, txt: "NĂM MỚI 2026" },
                { t: 9000, shp: "HEART" },
                { t: 14000, txt: "CHÚC MỪNG" },
                { t: 18000, txt: "SINH NHẬT" },
                { t: 22000, txt: BIRTHDAY },
                { t: 26000, txt: NAME },
                { t: 32000, action: "FREE" }
            ];

            sequence.forEach(s => {
                setTimeout(() => {
                    if(s.txt) formText(s.txt);
                    if(s.shp) formShape(s.shp);
                    if(s.action) scatterDrones();
                }, s.t);
            });
        }

        // Kỹ thuật Offscreen Canvas nhỏ để quét chữ nhanh hơn
        function formText(text) {
            const size = 150; // Kích thước canvas ảo nhỏ thôi để quét cho nhanh
            const scale = width / size; 
            const offCv = document.createElement('canvas');
            offCv.width = size;
            offCv.height = Math.floor(size * (height/width));
            const ctxOff = offCv.getContext('2d');
            
            ctxOff.font = '900 30px Arial'; // Font dày dễ đọc
            ctxOff.textAlign = 'center';
            ctxOff.textBaseline = 'middle';
            ctxOff.fillStyle = '#fff';
            ctxOff.fillText(text, offCv.width/2, offCv.height/2);

            // Quét pixel
            const data = ctxOff.getImageData(0,0, offCv.width, offCv.height).data;
            let points = [];
            for(let y=0; y<offCv.height; y+=2) { // Nhảy bước 2 pixel
                for(let x=0; x<offCv.width; x+=2) {
                    if(data[(y*offCv.width + x)*4 + 3] > 128) {
                        points.push({
                            x: x * scale + (Math.random()*10), 
                            y: y * scale + (Math.random()*10)
                        });
                    }
                }
            }

            // Gán vị trí cho drone
            assignTargets(points, getRainbowColor());
        }

        function formShape(type) {
            let points = [];
            const cx = width/2, cy = height/2;
            const r = Math.min(width, height) * 0.3;
            
            if(type === "HEART") {
                for(let i=0; i<drones.length; i++) {
                    let t = (i/drones.length) * Math.PI * 2;
                    let x = 16 * Math.pow(Math.sin(t), 3);
                    let y = -(13 * Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t));
                    points.push({ x: cx + x*(r/20), y: cy + y*(r/20) });
                }
            }
            assignTargets(points, '#ff0055');
        }

        function assignTargets(points, color) {
            // Shuffle mảng drone để bay ngẫu nhiên đẹp hơn
            drones.sort(() => Math.random() - 0.5);
            
            drones.forEach((d, i) => {
                if(i < points.length) {
                    d.tx = points[i].x;
                    d.ty = points[i].y;
                    d.color = color;
                } else {
                    // Drone thừa thì bay quanh tâm
                    let angle = Math.random() * Math.PI * 2;
                    let rad = Math.min(width, height) * 0.4;
                    d.tx = width/2 + Math.cos(angle) * rad;
                    d.ty = height/2 + Math.sin(angle) * rad;
                    d.color = '#333'; // Làm mờ drone thừa
                }
            });
        }

        function scatterDrones() {
            drones.forEach(d => {
                d.tx = Math.random() * width;
                d.ty = Math.random() * height;
            });
        }

        function getRainbowColor() {
            const colors = ['#00ffff', '#ff00ff', '#ffff00', '#00ff00', '#ffffff'];
            return colors[Math.floor(Math.random()*colors.length)];
        }

        // --- PHYSICS & DRAWING ---
        function createFirework(x, y, isSpecial = false) {
            // Giới hạn số lượng hạt
            if(fireworks.length > 5) return; 
            
            fireworks.push({
                x: x || Math.random() * width,
                y: height,
                ty: y || Math.random() * height/2,
                color: getRainbowColor(),
                exploded: false
            });
        }

        function loop() {
            requestAnimationFrame(loop);
            
            // Xóa màn hình nhưng giữ lại vệt mờ (Trail)
            // Thay vì dùng fillRect alpha (nặng), dùng globalCompositeOperation nếu cần
            ctx.fillStyle = 'rgba(0,0,0,0.2)'; 
            ctx.fillRect(0,0,width,height);

            // 1. Pháo hoa
            if(state === "FIREWORKS" || state === "COUNTDOWN") {
                for(let i = fireworks.length - 1; i >= 0; i--) {
                    let fw = fireworks[i];
                    if(!fw.exploded) {
                        fw.y += (fw.ty - fw.y) * 0.05;
                        ctx.fillStyle = fw.color;
                        ctx.fillRect(fw.x, fw.y, 3, 3); // Dùng rect nhanh hơn arc
                        if(Math.abs(fw.y - fw.ty) < 5) {
                            fw.exploded = true;
                            // Tạo hạt nổ (giảm số lượng hạt xuống 30 thay vì 100)
                            for(let j=0; j<30; j++) {
                                let angle = Math.random() * Math.PI * 2;
                                let speed = Math.random() * 5;
                                particles.push({
                                    x: fw.x, y: fw.y,
                                    vx: Math.cos(angle)*speed,
                                    vy: Math.sin(angle)*speed,
                                    color: fw.color,
                                    life: 1
                                });
                            }
                        }
                    } else {
                        fireworks.splice(i, 1);
                    }
                }
            }

            // 2. Hạt nổ
            for(let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.05; // Gravity
                p.life -= 0.02;
                if(p.life <= 0) particles.splice(i, 1);
                else {
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 2, 2);
                    ctx.globalAlpha = 1;
                }
            }

            // 3. Drone
            if(state === "DRONE") {
                drones.forEach(d => {
                    d.x += (d.tx - d.x) * d.speed;
                    d.y += (d.ty - d.y) * d.speed;
                    
                    ctx.fillStyle = d.color;
                    // Vẽ hình vuông nhỏ thay vì hình tròn để tối ưu
                    ctx.fillRect(d.x, d.y, 2, 2); 
                });
            }
        }
        loop();
    </script>
</body>
</html>
