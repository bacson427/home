<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPBD & HPNY (Auto-Spawn Fix)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Montserrat:wght@400&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: #050505;
            font-family: 'Cinzel', serif;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        #ui-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            pointer-events: none;
            z-index: 10;
        }

        .btn {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6);
            color: #d4af37;
            border: 2px solid #d4af37;
            padding: 15px 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            margin-top: 20px;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            display: none;
        }

        .btn:hover {
            background: #d4af37;
            color: #000;
            box-shadow: 0 0 50px #d4af37;
        }

        .hint {
            font-family: 'Montserrat', sans-serif;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 15px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        #start-btn { display: block; }

        #countdown-display {
            font-size: 15vw;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 50px #d4af37;
            display: none;
        }

        #hidden-youtube { position: absolute; width: 0; height: 0; opacity: 0; pointer-events: none;}
    </style>
</head>
<body>

    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <button id="start-btn" class="btn">BẮT ĐẦU</button>
        <div id="hint-text" class="hint">Nhấn Space hoặc Click để bắt đầu</div>
        
        <div id="countdown-display">10</div>

        <button id="next-phase-btn" class="btn">TIẾP TỤC</button>
        <button id="final-btn" class="btn">XEM FLYCAM</button>
    </div>

    <div id="hidden-youtube"><div id="player"></div></div>

    <script>
        // --- CẤU HÌNH ---
        const CONFIG = {
            NAME: "Trương Thị Dương",
            BIRTHDAY: "01/03/2007",
            COLORS: {
                GOLD: '#FFD700',
                RED: '#FF0055',
                CYAN: '#00FFFF',
                WHITE: '#FFFFFF'
            }
        };

        // --- YOUTUBE API ---
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100', width: '100', videoId: 'Og25tNifNSs',
                playerVars: { 'playsinline': 1, 'controls': 0, 'loop': 1 }
            });
        }
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        // --- CORE SYSTEM ---
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        let state = "IDLE"; 
        let fireworks = [];
        let particles = [];
        let drones = [];
        
        // UI Elements
        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-phase-btn');
        const finalBtn = document.getElementById('final-btn');
        const countDisplay = document.getElementById('countdown-display');
        const hintText = document.getElementById('hint-text');

        // --- LOGIC ĐIỀU KHIỂN ---
        function triggerAction() {
            if (state === "IDLE") {
                state = "FIREWORKS";
                startBtn.style.display = 'none';
                hintText.style.display = 'none';
                if(player && player.playVideo) player.playVideo();
                
                // Giai đoạn 1: Pháo hoa
                launchFireworksPeriod(10000, () => {
                    state = "WAITING_1";
                    nextBtn.style.display = 'block';
                    hintText.style.display = 'block';
                    hintText.innerText = "Nhấn Space hoặc Click để tiếp tục";
                });
            } 
            else if (state === "WAITING_1") {
                state = "COUNTDOWN";
                nextBtn.style.display = 'none';
                hintText.style.display = 'none';
                
                // Giai đoạn 2: Đếm ngược
                countDisplay.style.display = 'block';
                let c = 10;
                countDisplay.innerText = c;
                let t = setInterval(() => {
                    c--;
                    if (c > 0) {
                        countDisplay.innerText = c;
                        createFirework(width/2 + (Math.random()-0.5)*width*0.5, height/2 + (Math.random()-0.5)*height*0.5);
                    } else {
                        clearInterval(t);
                        countDisplay.style.display = 'none';
                        state = "WAITING_2";
                        finalBtn.style.display = 'block';
                        hintText.style.display = 'block';
                        hintText.innerText = "Nhấn Space hoặc Click để xem Flycam";
                    }
                }, 1000);
            } 
            else if (state === "WAITING_2") {
                state = "DRONE";
                finalBtn.style.display = 'none';
                hintText.style.display = 'none';
                startDroneSequence();
            }
        }

        startBtn.onclick = triggerAction;
        nextBtn.onclick = triggerAction;
        finalBtn.onclick = triggerAction;
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') { e.preventDefault(); triggerAction(); }
        });

        // --- FIREWORKS ---
        function launchFireworksPeriod(duration, callback) {
            let start = Date.now();
            let interval = setInterval(() => {
                if(Date.now() - start > duration) {
                    clearInterval(interval);
                    if(callback) callback();
                }
                if(Math.random() < 0.1) createFirework(); 
            }, 60);
        }

        function createFirework(x, y) {
            let targetY = y || height * 0.15 + Math.random() * (height * 0.3);
            let colors = [CONFIG.COLORS.GOLD, CONFIG.COLORS.RED, CONFIG.COLORS.CYAN, CONFIG.COLORS.WHITE];
            fireworks.push({
                x: x || Math.random() * width,
                y: height,
                ty: targetY,
                color: colors[Math.floor(Math.random() * colors.length)],
                exploded: false,
                speed: 6 + Math.random() * 5
            });
        }

        // --- HỆ THỐNG DRONE THÔNG MINH (AUTO-SPAWN) ---
        
        function createDrone(x, y, color) {
            return {
                x: x || Math.random() * width,
                y: y || height + 100, // Bay từ dưới lên
                tx: Math.random() * width, // Đích đến
                ty: Math.random() * height,
                z: Math.random(), 
                color: color || CONFIG.COLORS.GOLD,
                baseColor: color || CONFIG.COLORS.GOLD,
                speed: 0.04 + Math.random() * 0.04,
                size: 2.5 // Tăng kích thước điểm sáng để chữ đậm hơn
            };
        }

        // Khởi tạo trước một lượng drone nền
        function initDrones() {
            for(let i=0; i<500; i++) {
                drones.push(createDrone());
            }
        }
        initDrones();

        function startDroneSequence() {
            const sequence = [
                { t: 1000, txt: "HAPPY", color: CONFIG.COLORS.RED },
                { t: 4000, txt: "NEW YEAR", color: CONFIG.COLORS.GOLD },
                { t: 8000, txt: "2026", color: CONFIG.COLORS.CYAN },
                { t: 12000, shp: "HEART", color: CONFIG.COLORS.RED },
                { t: 17000, txt: "CHÚC MỪNG", color: CONFIG.COLORS.RED },
                { t: 20500, txt: "SINH NHẬT", color: CONFIG.COLORS.GOLD },
                { t: 24000, txt: CONFIG.BIRTHDAY, color: CONFIG.COLORS.WHITE },
                { t: 29000, txt: CONFIG.NAME, color: CONFIG.COLORS.GOLD }, 
                { t: 36000, action: "FREE" }
            ];

            sequence.forEach(s => {
                setTimeout(() => {
                    if(s.txt) formText(s.txt, s.color);
                    if(s.shp) formShape(s.shp, s.color);
                    if(s.action) scatterDrones();
                }, s.t);
            });
        }

        // Hàm tạo chữ ĐẢM BẢO KHÔNG MẤT NÉT
        function formText(text, color) {
            const offCv = document.createElement('canvas');
            const offCtx = offCv.getContext('2d');
            
            // Dùng font cực đậm
            const fontSize = 120; 
            offCtx.font = `900 ${fontSize}px "Cinzel"`; 
            const measure = offCtx.measureText(text);
            
            offCv.width = Math.ceil(measure.width + 40);
            offCv.height = Math.ceil(fontSize * 1.5);

            offCtx.font = `900 ${fontSize}px "Cinzel"`;
            offCtx.textAlign = 'center';
            offCtx.textBaseline = 'middle';
            offCtx.fillStyle = '#fff';
            offCtx.fillText(text, offCv.width/2, offCv.height/2);

            // Tính toán tỷ lệ scale để chữ luôn to đẹp giữa màn hình
            const maxW = width * 0.9; // Chiếm 90% chiều ngang
            const maxH = height * 0.5;
            const scale = Math.min(maxW / offCv.width, maxH / offCv.height);

            const startX = (width - offCv.width * scale) / 2;
            const startY = (height - offCv.height * scale) / 2;

            const data = offCtx.getImageData(0,0, offCv.width, offCv.height).data;
            let points = [];
            
            // Bước nhảy = 3 (An toàn cho hiệu năng, nhưng bù lại bằng Size hạt to)
            let step = 3; 

            for(let y=0; y<offCv.height; y+=step) {
                for(let x=0; x<offCv.width; x+=step) {
                    // Lấy các điểm ảnh có độ trong suốt > 128
                    if(data[(y*offCv.width + x)*4 + 3] > 128) {
                        points.push({
                            x: startX + x * scale,
                            y: startY + y * scale
                        });
                    }
                }
            }

            // *** QUAN TRỌNG: TỰ ĐỘNG SINH THÊM DRONE NẾU THIẾU ***
            if (drones.length < points.length) {
                const diff = points.length - drones.length;
                for(let i=0; i<diff; i++) {
                    drones.push(createDrone(width/2, height + 100, color));
                }
            }

            assignTargets(points, color);
        }

        function formShape(type, color) {
            let points = [];
            const cx = width/2, cy = height/2;
            const size = Math.min(width, height) * 0.35; 

            if (type === "HEART") {
                // Tạo 1000 điểm cho trái tim
                for (let i = 0; i < 1000; i++) {
                    let t = (i / 1000) * Math.PI * 2;
                    let x = 16 * Math.pow(Math.sin(t), 3);
                    let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                    points.push({ x: cx + x * (size/18), y: cy + y * (size/18) });
                }
            }
            
            // Tự động sinh thêm drone nếu thiếu cho hình
            if (drones.length < points.length) {
                const diff = points.length - drones.length;
                for(let i=0; i<diff; i++) {
                    drones.push(createDrone(cx, height + 100, color));
                }
            }
            
            assignTargets(points, color);
        }

        function assignTargets(points, color) {
            // Shuffle nhẹ để drone bay tự nhiên
            // drones.sort(() => Math.random() - 0.5); // Tắt sort để tối ưu hiệu năng
            
            drones.forEach((d, i) => {
                if (i < points.length) {
                    d.tx = points[i].x;
                    d.ty = points[i].y;
                    d.baseColor = color;
                    // Khi vào vị trí, giảm tốc độ rung để chữ nét hơn
                    d.speed = 0.05 + Math.random() * 0.05; 
                } else {
                    // Drone thừa bay ra ngoài màn hình hoặc làm nền mờ
                    d.tx = Math.random() * width;
                    d.ty = Math.random() * height;
                    d.baseColor = 'rgba(0,0,0,0)'; // Ẩn drone thừa đi cho đỡ rối
                }
            });
        }

        function scatterDrones() {
            drones.forEach(d => {
                d.tx = Math.random() * width;
                d.ty = Math.random() * height;
                d.baseColor = d.color; // Hiện lại màu gốc
            });
        }

        // --- RENDER LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            // Xóa nền mờ (Trail Effect)
            ctx.fillStyle = 'rgba(5, 5, 8, 0.25)';
            ctx.fillRect(0, 0, width, height);

            // Chế độ hòa trộn màu rực rỡ (Glow)
            ctx.globalCompositeOperation = 'lighter';

            // 1. Pháo hoa
            fireworks.forEach((fw, i) => {
                if (!fw.exploded) {
                    fw.y -= fw.speed;
                    ctx.fillStyle = fw.color;
                    ctx.beginPath(); ctx.arc(fw.x, fw.y, 2.5, 0, Math.PI*2); ctx.fill();
                    if (fw.y <= fw.ty) {
                        fw.exploded = true;
                        for(let j=0; j<40; j++) {
                            let a = Math.random()*Math.PI*2, v = Math.random()*6;
                            particles.push({x: fw.x, y: fw.y, vx: Math.cos(a)*v, vy: Math.sin(a)*v, color: fw.color, life: 1.2});
                        }
                    }
                } else fireworks.splice(i, 1);
            });

            // 2. Hạt nổ
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life -= 0.025;
                if (p.life <= 0) particles.splice(i, 1);
                else {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 1.5, 0, Math.PI*2); ctx.fill();
                }
            }
            ctx.globalAlpha = 1;

            // 3. Drone Show
            if (state === "DRONE" || state.includes("WAITING")) {
                drones.forEach(d => {
                    // Di chuyển
                    d.x += (d.tx - d.x) * d.speed;
                    d.y += (d.ty - d.y) * d.speed;
                    
                    // Chỉ vẽ drone nếu nó có màu (tức là không bị ẩn)
                    if (d.baseColor !== 'rgba(0,0,0,0)') {
                         // Hiệu ứng rung nhẹ
                        let vibX = Math.sin(Date.now()*0.02 + d.z*10) * 0.3;
                        let vibY = Math.cos(Date.now()*0.02 + d.z*10) * 0.3;

                        ctx.fillStyle = d.baseColor;
                        ctx.beginPath();
                        ctx.arc(d.x + vibX, d.y + vibY, d.size, 0, Math.PI*2);
                        ctx.fill();
                    }
                });
            }

            ctx.globalCompositeOperation = 'source-over';
        }
        animate();

    </script>
</body>
</html>
