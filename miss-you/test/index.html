<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Celebration V8</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Montserrat:wght@400&family=Dancing+Script&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: #020205; /* Nền đen xanh sâu thẳm */
            font-family: 'Cinzel', serif;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        #ui-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            pointer-events: none;
            z-index: 20;
        }

        .btn {
            pointer-events: auto;
            background: linear-gradient(45deg, #d4af37, #fceabb);
            color: #000;
            border: none;
            padding: 18px 60px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 4px;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.5);
            border-radius: 50px;
            display: none;
        }

        .btn:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 20px 50px rgba(212, 175, 55, 0.8), 0 0 20px #fff;
        }

        .hint {
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 20px;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        #start-btn { display: block; }

        #countdown-display {
            font-size: 18vw;
            font-weight: 900;
            background: linear-gradient(to bottom, #FFD700, #FF8C00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 30px #d4af37);
            display: none;
        }

        #hidden-youtube { position: absolute; width: 0; height: 0; opacity: 0; pointer-events: none;}
    </style>
</head>
<body>

    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <button id="start-btn" class="btn">KHAI TIỆC</button>
        <div id="hint-text" class="hint">Nhấn Space hoặc Click để bắt đầu</div>
        <div id="countdown-display">10</div>
        <button id="next-phase-btn" class="btn">TIẾP TỤC</button>
        <button id="final-btn" class="btn">XEM FLYCAM</button>
    </div>

    <div id="hidden-youtube"><div id="player"></div></div>

    <script>
        const CONFIG = {
            NAME: "Trương Thị Dương",
            BIRTHDAY: "01/03/2007",
            COLORS: { GOLD: '#FFD700', RED: '#FF0055', CYAN: '#00FFFF', WHITE: '#FFFFFF', PINK: '#FF69B4', PURPLE: '#9400D3' }
        };

        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100', width: '100', videoId: 'Og25tNifNSs',
                playerVars: { 'playsinline': 1, 'controls': 0, 'loop': 1 }
            });
        }
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        let state = "IDLE";
        let fireworks = [], particles = [], drones = [], flowers = [], fountains = [];
        let frameCount = 0;
        let finishedSequence = false; // Biến kiểm tra kết thúc

        const startBtn = document.getElementById('start-btn'), nextBtn = document.getElementById('next-phase-btn'), finalBtn = document.getElementById('final-btn'), countDisplay = document.getElementById('countdown-display'), hintText = document.getElementById('hint-text');

        function triggerAction() {
            if (state === "IDLE") {
                state = "FIREWORKS";
                startBtn.style.display = hintText.style.display = 'none';
                if(player && player.playVideo) player.playVideo();
                launchFireworksPeriod(10000, () => {
                    state = "WAITING_1"; nextBtn.style.display = hintText.style.display = 'block'; hintText.innerText = "Sẵn sàng đếm ngược";
                });
            } else if (state === "WAITING_1") {
                state = "COUNTDOWN";
                nextBtn.style.display = hintText.style.display = 'none';
                countDisplay.style.display = 'block';
                let c = 10; countDisplay.innerText = c;
                
                // Kích hoạt hiệu ứng màn 2
                startM2Effects();

                let t = setInterval(() => {
                    c--;
                    if (c > 0) {
                        countDisplay.innerText = c;
                        // Bắn pháo hoa hình thù khi đếm
                        createShapedFirework();
                    } else {
                        clearInterval(t);
                        countDisplay.style.display = 'none';
                        state = "WAITING_2"; finalBtn.style.display = hintText.style.display = 'block'; hintText.innerText = "Màn trình diễn ánh sáng đặc biệt";
                        stopM2Effects(); // Dừng hiệu ứng màn 2
                    }
                }, 1000);
            } else if (state === "WAITING_2") {
                state = "DRONE";
                finalBtn.style.display = hintText.style.display = 'none';
                startDroneSequence();
            }
        }

        startBtn.onclick = nextBtn.onclick = finalBtn.onclick = triggerAction;
        document.addEventListener('keydown', (e) => { if (e.code === 'Space') { e.preventDefault(); triggerAction(); } });

        // --- MÀN 2: HIỆU ỨNG ĐẶC BIỆT ---
        let m2Intervals = [];
        function startM2Effects() {
             // 1. Pháo phụt (Fountains)
            m2Intervals.push(setInterval(() => {
                if(Math.random() < 0.3) createFountain();
            }, 100));

             // 2. Hoa rơi (Falling Flowers)
            m2Intervals.push(setInterval(() => {
                createFlower();
            }, 300));
        }

        function stopM2Effects() {
            m2Intervals.forEach(clearInterval);
            m2Intervals = [];
        }

        function createFountain() {
            let x = Math.random() * width;
            for(let i=0; i<5; i++) {
                fountains.push({
                    x: x + (Math.random()-0.5)*20,
                    y: height,
                    vx: (Math.random()-0.5)*2,
                    vy: -(Math.random()*10 + 5),
                    color: Math.random() > 0.5 ? CONFIG.COLORS.GOLD : '#fff',
                    life: 1, decay: 0.02 + Math.random()*0.02
                });
            }
        }

        function createFlower() {
            flowers.push({
                x: Math.random() * width,
                y: -50,
                vx: Math.random() * 2 - 1,
                vy: Math.random() * 2 + 1,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 2 - 1,
                color: [CONFIG.COLORS.PINK, CONFIG.COLORS.RED, CONFIG.COLORS.WHITE][Math.floor(Math.random()*3)],
                size: Math.random() * 5 + 3
            });
        }

        function createShapedFirework() {
             let types = ['HEART', 'STAR', 'CIRCLE'];
             let type = types[Math.floor(Math.random()*types.length)];
             createFirework(width/2 + (Math.random()-0.5)*width*0.6, height*0.3 + Math.random()*height*0.3, type);
        }


        // --- LOGIC PHÁO HOA CƠ BẢN & HÌNH THÙ ---
        function launchFireworksPeriod(duration, callback) {
            let start = Date.now();
            let interval = setInterval(() => {
                if(Date.now() - start > duration) { clearInterval(interval); if(callback) callback(); }
                if(Math.random() < 0.2) createFirework();
            }, 60);
        }

        function createFirework(x, y, shapeType = 'NORMAL') {
            let targetY = y || height * 0.1 + Math.random() * (height * 0.4);
            let colors = Object.values(CONFIG.COLORS);
            fireworks.push({
                x: x || Math.random() * width,
                y: height,
                ty: targetY,
                color: colors[Math.floor(Math.random() * colors.length)],
                exploded: false,
                speed: 8 + Math.random() * 4,
                shape: shapeType
            });
        }

        function explodeFirework(fw) {
            fw.exploded = true;
            let count = 150; 
            if(fw.shape === 'NORMAL') count = 60;

            for(let i=0; i<count; i++) {
                let vx, vy;
                let angle = (i/count) * Math.PI * 2;
                let speed = Math.random()*6 + 2;

                if(fw.shape === 'HEART') {
                    let a = angle;
                    vx = (16 * Math.pow(Math.sin(a), 3));
                    vy = -(13 * Math.cos(a) - 5 * Math.cos(2 * a) - 2 * Math.cos(3 * a) - Math.cos(4 * a));
                    speed = 0.15; 
                } else if (fw.shape === 'STAR') {
                    let r = 10 * Math.pow(Math.cos(angle*2.5), 2) + 2; 
                    vx = r * Math.cos(angle);
                    vy = r * Math.sin(angle);
                    speed = 0.2;
                } else if (fw.shape === 'CIRCLE') {
                    vx = Math.cos(angle); vy = Math.sin(angle);
                    speed = 5;
                } else {
                    vx = Math.cos(angle); vy = Math.sin(angle);
                }

                particles.push({
                    x: fw.x, y: fw.y, vx: vx*speed, vy: vy*speed, color: fw.color,
                    life: 1.5, decay: 0.01 + Math.random()*0.015, gravity: 0.08
                });
            }
        }

        // --- MÀN 3: FLYCAM & KẾT THÚC ---
        function createDrone(x, y, color) {
            return {
                x: x || Math.random() * width, y: y || height + 100,
                tx: Math.random() * width, ty: Math.random() * height,
                z: Math.random(), baseColor: color || CONFIG.COLORS.GOLD, currentColor: color || CONFIG.COLORS.GOLD,
                speed: 0.05 + Math.random() * 0.05, size: 2.5
            };
        }

        function startDroneSequence() {
            // Kịch bản câu chúc dài và kết thúc
            const sequence = [
                { t: 500, txt: "CHÚC MỪNG", color: CONFIG.COLORS.RED },
                { t: 3500, txt: "NĂM MỚI 2026", color: CONFIG.COLORS.GOLD },
                { t: 7000, txt: "BÍNH NGỌ", color: CONFIG.COLORS.CYAN },
                { t: 10000, shp: "HEART", color: CONFIG.COLORS.RED },
                { t: 14000, txt: "VÀ ĐẶC BIỆT LÀ...", color: CONFIG.COLORS.WHITE },
                { t: 17000, txt: "SINH NHẬT LẦN THỨ 19", color: CONFIG.COLORS.GOLD },
                { t: 21000, txt: CONFIG.NAME, color: CONFIG.COLORS.RED, font: 'Dancing Script' }, // Tên dùng font viết tay
                { t: 25000, txt: CONFIG.BIRTHDAY, color: CONFIG.COLORS.WHITE },
                { t: 29000, txt: "LUÔN XINH ĐẸP & HẠNH PHÚC", color: CONFIG.COLORS.PINK },
                // KẾT THÚC
                { t: 35000, txt: "THE END", color: CONFIG.COLORS.GOLD, isEnd: true } 
            ];

            sequence.forEach(s => {
                setTimeout(() => {
                    if(s.txt) formText(s.txt, s.color, s.font || 'Cinzel');
                    if(s.shp) formShape(s.shp, s.color);
                    if(s.isEnd) {
                        finishedSequence = true; // Đánh dấu đã kết thúc
                    } else {
                        finishedSequence = false;
                    }
                }, s.t);
            });
        }

        function formText(text, color, fontName) {
            const offCv = document.createElement('canvas'); const offCtx = offCv.getContext('2d');
            const fontSize = 150; offCtx.font = `900 ${fontSize}px "${fontName}"`;
            const measure = offCtx.measureText(text);
            offCv.width = Math.ceil(measure.width + 50); offCv.height = Math.ceil(fontSize * 2);
            offCtx.font = `900 ${fontSize}px "${fontName}"`; offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';
            offCtx.fillStyle = '#fff'; offCtx.fillText(text, offCv.width/2, offCv.height/2);

            const maxW = width * 0.95; const maxH = height * 0.7;
            const scale = Math.min(maxW / offCv.width, maxH / offCv.height);
            const startX = (width - offCv.width * scale) / 2; const startY = (height - offCv.height * scale) / 2;

            const data = offCtx.getImageData(0,0, offCv.width, offCv.height).data;
            let points = []; let step = 3;
            for(let y=0; y<offCv.height; y+=step) { for(let x=0; x<offCv.width; x+=step) {
                    if(data[(y*offCv.width + x)*4 + 3] > 128) points.push({ x: startX + x * scale, y: startY + y * scale });
            }}
            ensureDrones(points.length); assignTargets(points, color);
        }

        function formShape(type, color) {
            let points = []; const cx = width/2, cy = height/2; const size = Math.min(width, height) * 0.35;
            if (type === "HEART") { for (let i = 0; i < 1200; i++) { let t = (i / 1200) * Math.PI * 2;
                    points.push({ x: cx + 16*Math.pow(Math.sin(t),3)*(size/18), y: cy - (13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t))*(size/18) }); }}
            ensureDrones(points.length); assignTargets(points, color);
        }

        function ensureDrones(count) {
            if (drones.length < count) { for(let i=0; i<count - drones.length; i++) drones.push(createDrone(width/2, height + 100)); }
        }
        function assignTargets(points, color) {
            drones.forEach((d, i) => {
                if (i < points.length) { d.tx = points[i].x; d.ty = points[i].y; d.baseColor = color; } 
                else { d.tx = width/2 + (Math.random()-0.5)*width*2; d.ty = height + 500; d.baseColor = 'transparent'; }
            });
        }

        // --- RENDER LOOP CHÍNH ---
        function animate() {
            requestAnimationFrame(animate); frameCount++;
            ctx.fillStyle = 'rgba(2, 2, 5, 0.25)'; ctx.fillRect(0, 0, width, height);

            // Vẽ các lớp nền Màn 2
            if(state === "COUNTDOWN") {
                flowers.forEach((f,i) => { f.y += f.vy; f.x += Math.sin(frameCount*0.02)*0.5; f.rotation += f.rotationSpeed;
                    if(f.y > height) flowers.splice(i,1); else drawFlower(f); });
                fountains.forEach((p,i) => { p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= p.decay;
                    if(p.life<=0) fountains.splice(i,1); else { ctx.globalAlpha = p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,2,2); ctx.globalAlpha=1; } });
            }

            ctx.globalCompositeOperation = 'lighter';

            if (state !== "DRONE") {
                fireworks.forEach((fw, i) => {
                    if (!fw.exploded) { fw.y -= fw.speed; ctx.fillStyle = fw.color; ctx.beginPath(); ctx.arc(fw.x, fw.y, 3, 0, Math.PI*2); ctx.fill();
                        if (fw.y <= fw.ty) explodeFirework(fw); } else fireworks.splice(i, 1); });
                particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.life -= p.decay;
                    if (p.life <= 0) particles.splice(i, 1); else { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill(); } });
            }

            if (state === "DRONE") {
                fireworks = []; particles = []; fountains = []; flowers = []; // Dọn dẹp
                
                // Logic nhấp nháy cho THE END
                let flashColor = CONFIG.COLORS.GOLD;
                if(finishedSequence) {
                    let colors = Object.values(CONFIG.COLORS);
                    flashColor = colors[Math.floor(frameCount / 15) % colors.length]; // Đổi màu mỗi 15 frame
                }

                drones.forEach(d => {
                    d.x += (d.tx - d.x) * d.speed; d.y += (d.ty - d.y) * d.speed;
                    if (d.baseColor !== 'transparent') {
                        d.currentColor = finishedSequence ? flashColor : d.baseColor;
                        let vib = finishedSequence ? 0 : Math.sin(frameCount*0.05 + d.z)*0.5; // Nếu kết thúc thì đứng im
                        
                        ctx.fillStyle = d.currentColor;
                        ctx.beginPath(); ctx.arc(d.x + vib, d.y + vib, d.size, 0, Math.PI*2); ctx.fill();
                        if(finishedSequence && Math.random() < 0.1) { ctx.fillStyle='#fff'; ctx.fillRect(d.x,d.y,2,2)} // Lấp lánh thêm
                    }
                });
            }
            ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1;
        }
        
        function drawFlower(f) {
            ctx.save(); ctx.translate(f.x, f.y); ctx.rotate(f.rotation * Math.PI/180);
            ctx.fillStyle = f.color; ctx.beginPath();
            for(let i=0; i<5; i++) { ctx.ellipse(0, f.size/2, f.size/2, f.size, i*(Math.PI*2/5), 0, Math.PI*2); }
            ctx.fill(); ctx.restore();
        }

        animate();
    </script>
</body>
</html>
