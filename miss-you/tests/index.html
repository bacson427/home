<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HPBD & HPNY (V18 Stable 3D)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Montserrat:wght@800&family=Dancing+Script:wght@700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Cinzel', serif;
            touch-action: none;
        }

        .galaxy-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            z-index: 0;
        }
        
        .stars {
            width: 1px; height: 1px;
            background: transparent;
            box-shadow: 1744px 122px #FFF , 134px 1321px #FFF , 92px 859px #FFF;
            animation: animStar 100s linear infinite;
        }
        
        @keyframes animStar { from { transform: translateY(0px); } to { transform: translateY(-2000px); } }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: none; z-index: 100;
        }

        .btn {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.05);
            color: #d4af37; border: 1px solid rgba(212, 175, 55, 0.5);
            padding: 15px 40px; font-size: 18px;
            cursor: wait; transition: all 0.5s;
            text-transform: uppercase; letter-spacing: 4px;
            font-family: 'Cinzel', serif; font-weight: 900;
            margin-top: 30px; border-radius: 30px; 
            backdrop-filter: blur(4px);
            opacity: 0.5;
        }

        .btn.ready { 
            cursor: pointer; opacity: 1; 
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            animation: pulse 3s infinite;
        }
        .btn.ready:hover { background: rgba(255, 215, 0, 0.2); transform: scale(1.05); color: #fff; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 50% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }

        .hint { font-family: 'Montserrat', sans-serif; font-size: 11px; color: rgba(255, 255, 255, 0.4); margin-top: 20px; letter-spacing: 2px; text-transform: uppercase; }
        #loading-text { margin-top: 15px; font-size: 12px; color: #d4af37; font-family: 'Montserrat', sans-serif; }

        #countdown-display { display: none; } /* Ẩn div cũ */
        #hidden-youtube { position: absolute; width: 0; height: 0; opacity: 0; pointer-events: none;}
    </style>
</head>
<body>

    <div class="galaxy-bg">
        <div id="stars"></div>
    </div>
    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <button id="start-btn" class="btn">LOADING...</button>
        <div id="loading-text">Đang tối ưu hệ thống 3D...</div>
        <div id="hint-text" class="hint" style="display:none">Nhấn Space hoặc Chạm để bắt đầu</div>
        <button id="next-phase-btn" class="btn ready" style="display:none">TIẾP TỤC</button>
        <button id="final-btn" class="btn ready" style="display:none">XEM FLYCAM</button>
    </div>

    <div id="hidden-youtube"><div id="player"></div></div>

    <script>
        const CONFIG = {
            NAME: "Trương Thị Dương",
            BIRTHDAY: "01/03/2007",
            COLORS: {
                GOLD: { h: 48, s: 100, l: 60 },
                RED: { h: 350, s: 100, l: 60 },
                CYAN: { h: 190, s: 100, l: 70 },
                WHITE: { h: 0, s: 0, l: 100 },
                PINK: { h: 320, s: 100, l: 70 }
            }
        };

        const isMobile = window.innerWidth < 768;
        const PARTICLE_SIZE = isMobile ? 3 : 2.5;
        // Tăng bước nhảy quét lên 5 để giảm tải (fix lag)
        const SCAN_STEP = isMobile ? 5 : 4; 

        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100', width: '100', videoId: 'Og25tNifNSs',
                playerVars: { 'playsinline': 1, 'controls': 0, 'loop': 1 }
            });
        }
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: true });
        let width, height;

        document.fonts.ready.then(function () {
            const btn = document.getElementById('start-btn');
            const loadTxt = document.getElementById('loading-text');
            const hint = document.getElementById('hint-text');
            btn.innerText = "KHAI TIỆC"; btn.classList.add('ready');
            loadTxt.style.display = 'none'; hint.style.display = 'block';
            btn.onclick = triggerAction;
        });

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        let state = "IDLE"; 
        let fireworks = [], particles = [], drones = [];
        let countdown3DParticles = [];
        let globalHue = 0;
        let isFinale = false;
        let countdownVal = 10;
        let countdownRotation = 0;
        let countdownTimer = null;

        const startBtn = document.getElementById('start-btn'), nextBtn = document.getElementById('next-phase-btn'), finalBtn = document.getElementById('final-btn'), hintText = document.getElementById('hint-text');

        function triggerAction() {
            if(!startBtn.classList.contains('ready') && state === "IDLE") return;
            
            if (state === "IDLE") {
                state = "FIREWORKS";
                startBtn.style.display = hintText.style.display = 'none';
                if(player && player.playVideo) player.playVideo();
                
                launchFireworksPeriod(12000, () => { 
                    state = "WAITING_1"; nextBtn.style.display = hintText.style.display = 'block'; hintText.innerText = "Sẵn sàng đếm ngược";
                });
            } else if (state === "WAITING_1") {
                state = "COUNTDOWN";
                nextBtn.style.display = hintText.style.display = 'none';
                countdownVal = 10;
                init3DNumber(countdownVal);

                if(countdownTimer) clearInterval(countdownTimer);
                countdownTimer = setInterval(() => {
                    countdownVal--;
                    if (countdownVal > 0) { 
                        explode3DNumber();
                        setTimeout(() => { if(state === "COUNTDOWN") init3DNumber(countdownVal); }, 200);
                        
                        if(countdownVal % 2 == 0) createShapedFirework();
                        // Giảm số lượng pháo hoa phụ để tập trung tài nguyên cho 3D
                        if(Math.random() < 0.5) createFirework(Math.random()*width, height*0.3);
                    } 
                    else { 
                        clearInterval(countdownTimer); 
                        state = "WAITING_2"; 
                        finalBtn.style.display = hintText.style.display = 'block'; 
                        hintText.innerText = "Kích hoạt Flycam"; 
                        countdown3DParticles = []; 
                    }
                }, 1200);
            } else if (state === "WAITING_2") {
                state = "DRONE"; finalBtn.style.display = hintText.style.display = 'none'; startDroneSequence();
            }
        }

        nextBtn.onclick = finalBtn.onclick = triggerAction;
        document.addEventListener('keydown', (e) => { if (e.code === 'Space') { e.preventDefault(); triggerAction(); } });

        // --- OPTIMIZED 3D COUNTDOWN ---
        function init3DNumber(num) {
            countdown3DParticles = [];
            const text = num.toString();
            const offCv = document.createElement('canvas');
            const offCtx = offCv.getContext('2d');
            const fontSize = 200;
            offCtx.font = `900 ${fontSize}px "Cinzel"`;
            const measure = offCtx.measureText(text);
            offCv.width = Math.ceil(measure.width + 20); offCv.height = Math.ceil(fontSize * 1.5);
            offCtx.font = `900 ${fontSize}px "Cinzel"`;
            offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';
            offCtx.fillStyle = '#fff';
            offCtx.fillText(text, offCv.width/2, offCv.height/2);
            
            const data = offCtx.getImageData(0,0, offCv.width, offCv.height).data;
            // Dùng bước nhảy SCAN_STEP đã cấu hình (lớn hơn bản cũ)
            const step = SCAN_STEP; 
            
            for(let y=0; y<offCv.height; y+=step) {
                for(let x=0; x<offCv.width; x+=step) {
                    if(data[(y*offCv.width + x)*4 + 3] > 100) {
                        // FIX LAG: Thay vì tạo vòng lặp Z, chỉ tạo 1 hạt có Z ngẫu nhiên
                        // Điều này giảm số lượng hạt đi 5 lần -> Hết lag
                        let randomZ = (Math.random() - 0.5) * 40; 
                        
                        countdown3DParticles.push({
                            x: (x - offCv.width/2) * 2,
                            y: (y - offCv.height/2) * 2,
                            z: randomZ,
                            ox: (x - offCv.width/2) * 2,
                            oy: (y - offCv.height/2) * 2,
                            oz: randomZ,
                            color: CONFIG.COLORS.GOLD,
                            size: 2.5
                        });
                    }
                }
            }
        }

        function explode3DNumber() {
            countdown3DParticles.forEach(p => {
                p.vx = (Math.random()-0.5) * 30;
                p.vy = (Math.random()-0.5) * 30;
                p.vz = (Math.random()-0.5) * 30;
                p.exploding = true;
            });
        }

        function render3DCountdown() {
            if(countdown3DParticles.length === 0) return;
            const cx = width/2;
            const cy = height/2;
            countdownRotation += 0.03;

            // FIX LAG: Bỏ dòng sort (sắp xếp) gây nặng máy
            // countdown3DParticles.sort(...) -> DELETE

            ctx.save();
            ctx.translate(cx, cy);

            countdown3DParticles.forEach((p) => {
                if(p.exploding) {
                    p.ox += p.vx; p.oy += p.vy; p.oz += p.vz;
                    p.vx *= 0.95; p.vy *= 0.95; p.vz *= 0.95;
                }

                let x1 = p.ox * Math.cos(countdownRotation) - p.oz * Math.sin(countdownRotation);
                let z1 = p.oz * Math.cos(countdownRotation) + p.ox * Math.sin(countdownRotation);
                let y1 = p.oy;

                let scale = 400 / (400 + z1);
                let x2d = x1 * scale;
                let y2d = y1 * scale;
                
                if(scale > 0) {
                    // Dùng fillRect thay vì arc để tối ưu
                    ctx.fillStyle = `hsla(${p.color.h}, ${p.color.s}%, ${p.color.l}%, ${scale})`;
                    let s = p.size * scale;
                    ctx.fillRect(x2d - s/2, y2d - s/2, s, s);
                }
            });
            
            // Vẽ vòng hào quang đơn giản hơn
            ctx.strokeStyle = 'rgba(212, 175, 55, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(0, 0, 160 * Math.cos(countdownRotation*0.5), 160, countdownRotation, 0, Math.PI*2);
            ctx.stroke();

            ctx.restore();
        }

        // --- FIREWORKS ---
        function launchFireworksPeriod(duration, callback) {
            let start = Date.now();
            let interval = setInterval(() => {
                if(Date.now() - start > duration) { clearInterval(interval); if(callback) callback(); }
                if(Math.random() < 0.3) createFirework(); 
            }, 100);
        }

        function createFirework(x, y, shape = 'NORMAL') {
            let colors = ['#FFD700', '#FF0055', '#00FFFF', '#FFFFFF'];
            fireworks.push({ x: x || Math.random() * width, y: height, ty: y || height * 0.15 + Math.random() * (height * 0.3), color: colors[Math.floor(Math.random() * colors.length)], exploded: false, speed: 4 + Math.random() * 3, shape: shape });
        }
        
        function createShapedFirework() {
             let types = ['HEART', 'STAR', 'CIRCLE'];
             createFirework(width/2 + (Math.random()-0.5)*width*0.5, height*0.3, types[Math.floor(Math.random()*types.length)]);
        }

        function explodeFirework(fw) {
            fw.exploded = true;
            let count = fw.shape === 'NORMAL' ? 40 : 80;
            for(let i=0; i<count; i++) {
                let angle = (i/count) * Math.PI * 2, speed = Math.random() * 3 + 1, vx, vy;
                if (fw.shape === 'HEART') { vx = (16 * Math.pow(Math.sin(angle), 3)); vy = -(13 * Math.cos(angle) - 5 * Math.cos(2 * angle) - 2 * Math.cos(3 * angle) - Math.cos(4 * angle)); speed = 0.1; }
                else if (fw.shape === 'STAR') { let r = 10 * Math.pow(Math.cos(angle*2.5), 2) + 2; vx = r * Math.cos(angle); vy = r * Math.sin(angle); speed = 0.15; }
                else { vx = Math.cos(angle); vy = Math.sin(angle); }
                particles.push({ x: fw.x, y: fw.y, vx: vx * speed, vy: vy * speed, color: fw.color, life: 1.5, decay: 0.015, gravity: 0.04 });
            }
        }

        // --- DRONE ---
        function createDrone(x, y) {
            return {
                x: x || Math.random() * width, y: y || height + 100, tx: Math.random() * width, ty: Math.random() * height, 
                z: Math.random(), baseHsl: {h:50, s:100, l:50}, colorMode: 'static', 
                speed: 0.02 + Math.random() * 0.02, 
                size: PARTICLE_SIZE 
            };
        }

        function startDroneSequence() {
            const sequence = [
                { t: 500, txt: "CHÚC MỪNG", color: CONFIG.COLORS.RED, mode: 'shift' },
                { t: 6500, txt: "NĂM MỚI 2026", color: CONFIG.COLORS.GOLD, mode: 'shift' },
                { t: 12500, txt: "BÍNH NGỌ", color: CONFIG.COLORS.CYAN, mode: 'static' },
                { t: 18500, shp: "HEART", color: CONFIG.COLORS.RED, mode: 'shift' },
                { t: 24500, txt: "XINH ĐẸP & HẠNH PHÚC", color: CONFIG.COLORS.WHITE, mode: 'glitter' },
                { t: 31500, txt: "SINH NHẬT TUỔI 19", color: CONFIG.COLORS.GOLD, mode: 'shift' },
                { t: 38500, txt: CONFIG.NAME, color: CONFIG.COLORS.PINK, font: 'Dancing Script', mode: 'rainbow' },
                { t: 45500, txt: CONFIG.BIRTHDAY, color: CONFIG.COLORS.WHITE, mode: 'static' },
                { t: 52500, txt: "THE END", color: CONFIG.COLORS.GOLD, isEnd: true, mode: 'rainbow' }
            ];

            sequence.forEach(s => {
                setTimeout(() => {
                    if(s.txt) formText(s.txt, s.color, s.font || 'Cinzel', s.mode);
                    if(s.shp) formShape(s.shp, s.color, s.mode);
                    isFinale = !!s.isEnd;
                }, s.t);
            });
        }

        function formText(text, hslColor, fontName, mode) {
            const offCv = document.createElement('canvas');
            const offCtx = offCv.getContext('2d');
            const fontSize = 100; 
            offCtx.font = `900 ${fontSize}px "${fontName}"`; 
            const measure = offCtx.measureText(text);
            offCv.width = Math.ceil(measure.width + 20); offCv.height = Math.ceil(fontSize * 1.5);
            offCtx.font = `900 ${fontSize}px "${fontName}"`;
            offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';
            offCtx.fillStyle = '#fff';
            offCtx.fillText(text, offCv.width/2, offCv.height/2);

            const scale = Math.min(width * 0.9 / offCv.width, height * 0.6 / offCv.height);
            const startX = (width - offCv.width * scale) / 2;
            const startY = (height - offCv.height * scale) / 2;

            const data = offCtx.getImageData(0,0, offCv.width, offCv.height).data;
            let points = [];
            
            for(let y=0; y<offCv.height; y+=SCAN_STEP) {
                for(let x=0; x<offCv.width; x+=SCAN_STEP) {
                    if(data[(y*offCv.width + x)*4 + 3] > 50) {
                        points.push({ x: startX + x * scale, y: startY + y * scale });
                    }
                }
            }
            updateDrones(points, hslColor, mode);
        }

        function formShape(type, hslColor, mode) {
            let points = [], cx = width/2, cy = height/2, size = Math.min(width, height) * 0.35; 
            let count = isMobile ? 800 : 1500;
            if (type === "HEART") {
                for (let i = 0; i < count; i++) {
                    let t = (i / count) * Math.PI * 2;
                    let x = 16 * Math.pow(Math.sin(t), 3);
                    let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                    points.push({ x: cx + x * (size/18), y: cy + y * (size/18) });
                }
            }
            updateDrones(points, hslColor, mode);
        }

        function updateDrones(points, hslColor, mode) {
            const MAX_DRONES = isMobile ? 1800 : 3000;
            if (points.length > MAX_DRONES) points = points.filter(() => Math.random() > (1 - MAX_DRONES/points.length));

            while(drones.length < points.length) drones.push(createDrone(width/2, height + 100));
            drones.forEach(d => d.targetAlpha = 0); 
            points.forEach((p, i) => {
                if(drones[i]) {
                    drones[i].tx = p.x; drones[i].ty = p.y;
                    drones[i].baseHsl = hslColor; drones[i].colorMode = mode;
                    drones[i].targetAlpha = 1; 
                }
            });
            for(let i = points.length; i < drones.length; i++) {
                drones[i].tx = width/2 + (Math.random()-0.5)*width*1.5;
                drones[i].ty = height + 200;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, width, height); 
            globalHue += 0.5;

            if (state === "COUNTDOWN") {
                render3DCountdown();
            }

            if (isFinale && Math.random() < 0.05) { createFirework(Math.random()*width, height*0.5); }

            if (state !== "DRONE" || isFinale) {
                ctx.globalCompositeOperation = 'lighter';
                fireworks.forEach((fw, i) => {
                    if (!fw.exploded) {
                        fw.y -= fw.speed;
                        ctx.fillStyle = fw.color; ctx.beginPath(); ctx.arc(fw.x, fw.y, 3, 0, Math.PI*2); ctx.fill();
                        if (fw.y <= fw.ty) explodeFirework(fw);
                    } else fireworks.splice(i, 1);
                });
                particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.life -= p.decay;
                    if (p.life <= 0) particles.splice(i, 1);
                    else { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, 2, 2); }
                });
                ctx.globalAlpha = 1;
            }

            if (state === "DRONE") {
                ctx.globalCompositeOperation = 'lighter'; 
                drones.forEach(d => {
                    d.x += (d.tx - d.x) * d.speed; d.y += (d.ty - d.y) * d.speed;
                    let h = d.baseHsl.h, s = d.baseHsl.s, l = d.baseHsl.l;
                    if (d.colorMode === 'shift') { h = h + Math.sin(globalHue * 0.05) * 20; } 
                    else if (d.colorMode === 'rainbow') { h = (d.x / width * 360 + globalHue * 2) % 360; }
                    else if (d.colorMode === 'glitter') { if(Math.random() < 0.05) l = 100; }

                    if (d.targetAlpha !== 0 || d.y < height) {
                        let dx = (d.x + 0.5) << 0;
                        let dy = (d.y + 0.5) << 0;
                        ctx.fillStyle = `hsl(${h}, ${s}%, ${l}%)`;
                        ctx.fillRect(dx, dy, d.size, d.size);
                    }
                });
            }
            ctx.globalCompositeOperation = 'source-over';
        }
        
        const starContainer = document.getElementById('stars');
        let boxShadowVal = '';
        for(let i=0; i<200; i++) boxShadowVal += `${Math.random()*2000}px ${Math.random()*2000}px #FFF, `;
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `.stars { box-shadow: ${boxShadowVal.slice(0,-2)}; }`;
        document.head.appendChild(styleSheet);
        
        animate();
    </script>
</body>
</html>
