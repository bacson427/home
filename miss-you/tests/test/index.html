<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HPBD & HPNY (V2.1 Audio Reactive)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Montserrat:wght@800&family=Dancing+Script:wght@700&display=swap');

        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Cinzel', serif; touch-action: none; }
        .galaxy-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); z-index: 0; }
        .stars { width: 1px; height: 1px; background: transparent; animation: animStar 100s linear infinite; }
        @keyframes animStar { from { transform: translateY(0px); } to { transform: translateY(-2000px); } }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: none; z-index: 100; }
        .btn { pointer-events: auto; background: rgba(255, 255, 255, 0.05); color: #d4af37; border: 1px solid rgba(212, 175, 55, 0.5); padding: 15px 40px; font-size: 18px; cursor: wait; transition: all 0.5s; text-transform: uppercase; letter-spacing: 4px; font-family: 'Cinzel', serif; font-weight: 900; margin-top: 30px; border-radius: 30px; backdrop-filter: blur(4px); opacity: 0.5; }
        .btn.ready { cursor: pointer; opacity: 1; border-color: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); animation: pulse 3s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 50% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }
        #letter-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #8B0000; color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 200; font-family: 'Arial', sans-serif; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 2s ease-in-out; }
        #letter-content { max-width: 600px; text-align: center; font-size: clamp(16px, 4vw, 24px); line-height: 1.6; }
        .typing-cursor { display: inline-block; width: 2px; height: 1em; background-color: white; animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="galaxy-bg"><div id="stars" class="stars"></div></div>
    <canvas id="mainCanvas"></canvas>
    <div id="ui-layer">
        <button id="start-btn" class="btn">ƒêANG N·∫†P...</button>
        <button id="next-phase-btn" class="btn ready" style="display:none">TI·∫æP T·ª§C</button>
    </div>
    <div id="letter-container">
        <div id="letter-content"></div>
        <div id="letter-signature" style="margin-top:30px; font-family:'Dancing Script'; font-size: 22px; opacity:0; transition: 1s;"></div>
    </div>
    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" crossorigin="anonymous" loop></audio>

    <script>
        const CONFIG = {
            NAME: "Tr∆∞∆°ng Th·ªã D∆∞∆°ng",
            DRONE_SPEED: 0.02, // Ch·∫≠m l·∫°i cho m∆∞·ª£t
            SEQUENCE_DELAY: 8000 // K√©o d√†i m·ªói hi·ªáu ·ª©ng
        };

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const music = document.getElementById('bg-music');
        let width, height, audioCtx, analyser, dataArray;
        let volBoost = 1;

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(music);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        document.fonts.ready.then(() => {
            const btn = document.getElementById('start-btn');
            btn.innerText = "KHAI TI·ªÜC"; btn.classList.add('ready');
            btn.onclick = triggerAction;
        });

        let state = "IDLE", fireworks = [], particles = [], drones = [], globalHue = 0;

        function triggerAction() {
            if (state === "IDLE") {
                state = "FIREWORKS";
                document.getElementById('start-btn').style.display = 'none';
                if(!audioCtx) initAudio();
                music.play();
                setTimeout(() => { state = "WAITING"; document.getElementById('next-phase-btn').style.display = 'block'; }, 8000);
            } else if (state === "WAITING") {
                state = "COUNTDOWN";
                document.getElementById('next-phase-btn').style.display = 'none';
                startCountdown();
            }
        }

        function createFirework(x, y) {
            // N·ªï to hay b√© d·ª±a tr√™n volBoost (s√≥ng nh·∫°c)
            fireworks.push({ x: x || Math.random() * width, y: height, ty: y || height * 0.2, color: `hsl(${Math.random()*360}, 100%, 60%)`, exploded: false, boost: volBoost });
        }

        function explode(fw) {
            fw.exploded = true;
            let count = 30 + (fw.boost * 40); // Nh·∫°c to n·ªï nhi·ªÅu h·∫°t h∆°n
            for(let i=0; i<count; i++) {
                let angle = (i/count) * Math.PI * 2, speed = (Math.random() * 3 + 2) * fw.boost;
                particles.push({ x: fw.x, y: fw.y, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed, color: fw.color, life: 1, decay: 0.015 });
            }
        }

        function startCountdown() {
            let count = 10;
            let timer = setInterval(() => {
                if(count <= 0) { clearInterval(timer); startDroneShow(); }
                else { createFirework(width/2, height/2); count--; }
            }, 1000);
        }

        function startDroneShow() {
            state = "DRONE";
            const sequence = [
                { txt: "üéâ CH√öC M·ª™NG üéâ" },
                { txt: "üåü NƒÇM M·ªöI 2026 üåü" },
                { txt: "üê¥ B√çNH NG·ªå üê¥" },
                { txt: "üíù VALENTINE üåπ" },
                { txt: "üíê PH·ª§ N·ªÆ 8/3 üå∑" },
                { shp: "HEART" },
                { txt: "üçÄ HPBD TU·ªîI 19 üê∑" },
                { txt: CONFIG.NAME },
                { txt: "‚ù§Ô∏è M√ÉI XINH ƒê·∫∏P NH√â ‚ù§Ô∏è", isEnd: true }
            ];

            sequence.forEach((s, i) => {
                setTimeout(() => {
                    if(s.txt) formText(s.txt);
                    if(s.shp) formShape();
                    if(s.isEnd) setTimeout(startLetter, CONFIG.SEQUENCE_DELAY);
                }, i * CONFIG.SEQUENCE_DELAY);
            });
        }

        function formText(text) {
            const tempCv = document.createElement('canvas');
            const tempCtx = tempCv.getContext('2d');
            let fSize = width < 600 ? 40 : 80;
            tempCtx.font = `900 ${fSize}px "Cinzel"`;
            tempCv.width = tempCtx.measureText(text).width + 20; tempCv.height = fSize * 2;
            tempCtx.font = `900 ${fSize}px "Cinzel"`; tempCtx.textAlign = 'center'; tempCtx.textBaseline = 'middle';
            tempCtx.fillStyle = '#fff'; tempCtx.fillText(text, tempCv.width/2, tempCv.height/2);
            
            let data = tempCtx.getImageData(0,0, tempCv.width, tempCv.height).data, pts = [];
            let step = width < 600 ? 4 : 3;
            for(let y=0; y<tempCv.height; y+=step) {
                for(let x=0; x<tempCv.width; x+=step) {
                    if(data[(y*tempCv.width+x)*4+3] > 128) pts.push({ x: (width-tempCv.width)/2 + x, y: (height-tempCv.height)/2 + y });
                }
            }
            updateDrones(pts);
        }

        function formShape() {
            let pts = [], cx = width/2, cy = height/2, size = Math.min(width, height)*0.35;
            for(let i=0; i<800; i++) {
                let t = (i/800)*Math.PI*2;
                let x = 16*Math.pow(Math.sin(t), 3), y = -(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t));
                pts.push({ x: cx + x*(size/20), y: cy + y*(size/20) });
            }
            updateDrones(pts);
        }

        function updateDrones(pts) {
            while(drones.length < pts.length) drones.push({ x: width/2, y: height, tx: width/2, ty: height });
            pts.forEach((p, i) => { drones[i].tx = p.x; drones[i].ty = p.y; });
            for(let i=pts.length; i<drones.length; i++) drones[i].ty = height + 100;
        }

        function startLetter() {
            state = "LETTER";
            const container = document.getElementById('letter-container');
            container.style.display = 'flex';
            setTimeout(() => { 
                container.style.opacity = '1'; 
                let idx = 0, txt = "D∆∞∆°ng ∆°i, h√¥m nay l√† ng√†y 01/03/2026... Ch√∫c c·∫≠u m√£i xinh ƒë·∫πp v√† tha l·ªói cho t·ªõ nh√©!";
                let itv = setInterval(() => {
                    document.getElementById('letter-content').innerHTML = txt.slice(0, idx) + '<span class="typing-cursor"></span>';
                    if(idx++ >= txt.length) { 
                        clearInterval(itv);
                        document.getElementById('letter-signature').innerHTML = "K√Ω t√™n: Nguy·ªÖn B·∫Øc S∆°n";
                        document.getElementById('letter-signature').style.opacity = 1;
                    }
                }, 70).catch(e => console.log(e));
            }, 1000);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(state === "LETTER") return;
            ctx.clearRect(0,0,width,height);
            
            if(analyser) {
                analyser.getByteFrequencyData(dataArray);
                let avg = dataArray.reduce((a,b)=>a+b)/dataArray.length;
                volBoost = 0.8 + (avg/128); // H·ªá s·ªë n·ªï theo nh·∫°c
            }

            fireworks.forEach((fw, i) => {
                if(!fw.exploded) {
                    fw.y -= 6;
                    ctx.fillStyle = fw.color; ctx.fillRect(fw.x, fw.y, 3, 3);
                    if(fw.y <= fw.ty) explode(fw);
                } else fireworks.splice(i, 1);
            });

            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.life -= p.decay;
                if(p.life <= 0) particles.splice(i, 1);
                else { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 2, 2); }
            });

            if(state === "DRONE") {
                ctx.globalAlpha = 1;
                drones.forEach(d => {
                    d.x += (d.tx - d.x) * CONFIG.DRONE_SPEED;
                    d.y += (d.ty - d.y) * CONFIG.DRONE_SPEED;
                    ctx.fillStyle = `hsl(${(d.x/width)*360}, 100%, 70%)`;
                    ctx.fillRect(d.x, d.y, 2.5, 2.5);
                });
            }
        }

        let stars = document.getElementById('stars'), sCss = '';
        for(let i=0; i<150; i++) sCss += `${Math.random()*2000}px ${Math.random()*2000}px #FFF, `;
        stars.style.boxShadow = sCss.slice(0,-2);
        
        animate();
    </script>
</body>
</html>
