<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G·ª≠i D∆∞∆°ng - V4.0 Monumental</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Dancing+Script:wght@700&family=Montserrat:wght@800&display=swap');
        
        body { margin: 0; overflow: hidden; background-color: #050505; touch-action: none; }
        
        /* Hi·ªáu ·ª©ng rung m√†n h√¨nh */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }
        .shaking { animation: shake 0.5s; animation-iteration-count: 1; }

        .galaxy-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111 0%, #000 100%); z-index: 0;
        }
        
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; filter: contrast(1.2) brightness(1.2); }

        #ui-layer {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: none; z-index: 100;
        }

        .btn {
            pointer-events: auto; background: rgba(0,0,0,0.6);
            color: #d4af37; border: 2px solid #d4af37;
            padding: 20px 50px; font-size: 20px; cursor: pointer;
            text-transform: uppercase; letter-spacing: 5px; font-family: 'Cinzel', serif;
            font-weight: 900; margin-top: 30px; border-radius: 50px; 
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
            transition: all 0.3s;
        }
        .btn:hover { background: #d4af37; color: #000; box-shadow: 0 0 50px rgba(212, 175, 55, 0.8); transform: scale(1.1); }

        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95); color: #fff; display: none;
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 200; font-family: 'Montserrat', sans-serif; padding: 20px; box-sizing: border-box;
            opacity: 0; transition: opacity 2s ease-in-out;
        }
        #letter-content { max-width: 700px; text-align: center; font-size: clamp(16px, 4vw, 22px); line-height: 1.8; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        #letter-signature { margin-top: 40px; font-size: clamp(22px, 5vw, 30px); font-family: 'Dancing Script', cursive; color: #ffd700; opacity: 0; transition: opacity 1.5s; }
    </style>
</head>
<body>
    <div class="galaxy-bg" id="bg-layer"></div>
    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <button id="start-btn" class="btn">KHAI TI·ªÜC</button>
        <div style="color: #666; margin-top: 10px; font-family: sans-serif; font-size: 10px;">L∆∞u √Ω: B·∫≠t √¢m thanh l·ªõn</div>
    </div>

    <div id="letter-container">
        <div id="letter-content"></div>
        <div id="letter-signature"></div>
    </div>

    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" crossorigin="anonymous" loop></audio>

<script>
    // --- C·∫§U H√åNH ---
    const CONFIG = {
        NAME: "Tr∆∞∆°ng Th·ªã D∆∞∆°ng",
        PARTICLE_COUNT_MOBILE: 800,
        PARTICLE_COUNT_PC: 2000,
        DRONE_SIZE: 2.5
    };

    const isMobile = window.innerWidth < 768;
    const TOTAL_DRONES = isMobile ? CONFIG.PARTICLE_COUNT_MOBILE : CONFIG.PARTICLE_COUNT_PC;

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { alpha: false }); // T·∫Øt alpha ƒë·ªÉ t·ªëi ∆∞u render n·ªÅn ƒëen
    const music = document.getElementById('bg-music');
    const bgLayer = document.getElementById('bg-layer');
    
    let width, height, cx, cy;
    let drones = [];
    let fireworks = [];
    let particles = [];
    
    // Audio stuff
    let audioCtx, analyser, dataArray;
    let bassScale = 1;

    // --- KH·ªûI T·∫†O ---
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        cx = width / 2; cy = height / 2;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- H·ªÜ TH·ªêNG V·∫¨T L√ù DRONE (SWARM PHYSICS) ---
    class Drone {
        constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * 2;
            this.vy = (Math.random() - 0.5) * 2;
            this.tx = this.x; // Target X
            this.ty = this.y; // Target Y
            this.color = `hsl(${Math.random()*360}, 100%, 50%)`;
            this.size = Math.random() * CONFIG.DRONE_SIZE + 1;
            this.noiseOffset = Math.random() * 1000;
        }

        update(mode) {
            // L·ª±c h√∫t v·ªÅ ƒë√≠ch (Steering behavior)
            let dx = this.tx - this.x;
            let dy = this.ty - this.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            // Hi·ªáu ·ª©ng "N·ªï" khi chuy·ªÉn c·∫£nh: N·∫øu m·ª•c ti√™u qu√° xa, tƒÉng t·ªëc c·ª±c ƒë·∫°i
            let speed = dist > 100 ? (Math.random() * 0.15 + 0.05) : (Math.random() * 0.05 + 0.01);
            
            // Th√™m nhi·ªÖu lo·∫°n (Noise) ƒë·ªÉ kh√¥ng bay th·∫≥ng h√†ng
            this.noiseOffset += 0.01;
            let noiseX = Math.sin(this.noiseOffset) * 2; 
            let noiseY = Math.cos(this.noiseOffset) * 2;

            if (mode === 'SCATTER') {
                // Ch·∫ø ƒë·ªô bay lo·∫°n x·∫°
                this.vx += (Math.random() - 0.5) * 0.5;
                this.vy += (Math.random() - 0.5) * 0.5;
            } else {
                // Ch·∫ø ƒë·ªô bay v·ªÅ ƒë√≠ch (c√≥ qu√°n t√≠nh)
                this.vx += (dx * speed - this.vx) * 0.1;
                this.vy += (dy * speed - this.vy) * 0.1;
                
                // Rung l·∫Øc nh·∫π theo nh·∫°c
                if (bassScale > 1.2) {
                    this.x += (Math.random()-0.5) * 3;
                    this.y += (Math.random()-0.5) * 3;
                }
            }

            // C·∫≠p nh·∫≠t v·ªã tr√≠
            this.x += this.vx + noiseX * 0.1;
            this.y += this.vy + noiseY * 0.1;
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.size * bassScale, this.size * bassScale);
        }
    }

    // Kh·ªüi t·∫°o drone pool
    for(let i=0; i<TOTAL_DRONES; i++) drones.push(new Drone());

    // --- H·ªÜ TH·ªêNG PH√ÅO HOA V·∫¨T L√ù ---
    class Firework {
        constructor(x, targetY, type) {
            this.x = x; this.y = height;
            this.ty = targetY;
            this.type = type; // 'SHELL', 'WILLOW', 'CROSS'
            this.color = `hsl(${Math.random()*360}, 100%, 60%)`;
            this.speed = Math.random() * 3 + 12; // B·∫Øn nhanh
            this.angle = -Math.PI / 2 + (Math.random() - 0.5) * 0.2; // H∆°i nghi√™ng ng·∫´u nhi√™n
            this.vx = Math.cos(this.angle) * 2;
            this.vy = Math.sin(this.angle) * this.speed;
            this.exploded = false;
        }

        update() {
            this.vy *= 0.96; // Tr·ªçng l·ª±c/L·ª±c c·∫£n
            this.x += this.vx;
            this.y -= this.vy;
            
            // V·∫Ω ƒëu√¥i
            ctx.globalAlpha = 0.3;
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, 3, 10);
            ctx.globalAlpha = 1;

            if (this.vy < 2 || this.y <= this.ty) this.explode();
        }

        explode() {
            this.exploded = true;
            // Rung m√†n h√¨nh n·∫øu n·ªï to
            if(Math.random() > 0.5) document.body.classList.add('shaking');
            setTimeout(() => document.body.classList.remove('shaking'), 500);

            let pCount = isMobile ? 50 : 100;
            if(this.type === 'WILLOW') pCount *= 1.5;

            for(let i=0; i<pCount; i++) {
                particles.push(new Particle(this.x, this.y, this.color, this.type));
            }
        }
    }

    class Particle {
        constructor(x, y, color, type) {
            this.x = x; this.y = y;
            let angle = Math.random() * Math.PI * 2;
            // T·ªëc ƒë·ªô n·ªï ng·∫´u nhi√™n m·∫°nh
            let speed = Math.random() * (type === 'WILLOW' ? 3 : 6) * bassScale; 
            
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.color = color;
            this.alpha = 1;
            this.decay = Math.random() * 0.015 + 0.005;
            this.gravity = type === 'WILLOW' ? 0.03 : 0.05; // Willow r∆°i ch·∫≠m h∆°n
            this.type = type;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += this.gravity;
            this.vx *= 0.95; // L·ª±c c·∫£n kh√¥ng kh√≠
            this.vy *= 0.95;
            this.alpha -= this.decay;
        }

        draw() {
            ctx.globalAlpha = this.alpha;
            ctx.fillStyle = this.color;
            // Hi·ªáu ·ª©ng l·∫•p l√°nh cho Willow
            if(this.type === 'WILLOW' && Math.random() > 0.8) ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.type === 'WILLOW' ? 1.5 : 2, 0, Math.PI*2);
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    // --- X·ª¨ L√ù TEXT & H√åNH ·∫¢NH ---
    function getPointsFromText(text, font, size) {
        const offCv = document.createElement('canvas');
        const offCtx = offCv.getContext('2d');
        offCtx.font = `900 ${size}px "${font}"`;
        const m = offCtx.measureText(text);
        offCv.width = m.width + 50; offCv.height = size * 1.5;
        
        offCtx.font = `900 ${size}px "${font}"`;
        offCtx.fillStyle = '#fff';
        offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';
        offCtx.fillText(text, offCv.width/2, offCv.height/2);
        
        return scanCanvas(offCv);
    }

    function getPointsFromShape(type) {
        const offCv = document.createElement('canvas');
        const offCtx = offCv.getContext('2d');
        let s = Math.min(width, height) * 0.7;
        offCv.width = s; offCv.height = s;
        offCtx.fillStyle = '#fff';
        offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';

        if(type === 'CAKE_HEART') {
            let emojiSize = s/2.5;
            offCtx.font = `${emojiSize}px Arial`;
            offCtx.fillText("üéÇ", s*0.25, s/2);
            offCtx.fillText("‚ù§Ô∏è", s*0.75, s/2);
        }
        
        return scanCanvas(offCv);
    }

    function scanCanvas(cv) {
        const data = cv.getContext('2d').getImageData(0,0, cv.width, cv.height).data;
        let points = [];
        let step = isMobile ? 4 : 3; // Qu√©t d√†y h∆°n
        // T√≠nh t·ªâ l·ªá scale ƒë·ªÉ fit m√†n h√¨nh
        let scale = Math.min(width * 0.9 / cv.width, height * 0.6 / cv.height);

        for(let y=0; y<cv.height; y+=step) {
            for(let x=0; x<cv.width; x+=step) {
                if(data[(y*cv.width + x)*4 + 3] > 128) {
                    // Th√™m ch√∫t ng·∫´u nhi√™n v√†o v·ªã tr√≠ ƒë√≠ch ƒë·ªÉ drone kh√¥ng ƒë·ª©ng qu√° th·∫≥ng h√†ng
                    let jitter = 2; 
                    points.push({
                        x: (width - cv.width * scale)/2 + x * scale + (Math.random()-0.5)*jitter,
                        y: (height - cv.height * scale)/2 + y * scale + (Math.random()-0.5)*jitter
                    });
                }
            }
        }
        return points;
    }

    // --- TIMELINE ƒêI·ªÄU KHI·ªÇN ---
    let timeline = [
        { t: 0, action: 'FIREWORKS', duration: 8000 },
        { t: 9000, type: 'text', val: "S·∫¥N S√ÄNG CH∆ØA?", color: 60 },
        { t: 14000, type: 'text', val: "3", color: 0 },
        { t: 15000, type: 'text', val: "2", color: 0 },
        { t: 16000, type: 'text', val: "1", color: 0 },
        { t: 17000, type: 'text', val: "HAPPY BIRTHDAY", color: 50 },
        { t: 24000, type: 'text', val: "TR∆Ø∆†NG TH·ªä D∆Ø∆†NG", font: "Dancing Script", color: 320 },
        { t: 32000, type: 'text', val: "CH√öC M·ª™NG NƒÇM M·ªöI 2026", color: 45 },
        { t: 40000, type: 'text', val: "XU√ÇN B√çNH NG·ªå", color: 180 },
        { t: 48000, type: 'text', val: "HAPPY VALENTINE", color: 300 },
        { t: 56000, type: 'text', val: "QU·ªêC T·∫æ PH·ª§ N·ªÆ 8/3", color: 350 },
        { t: 64000, type: 'text', val: "TU·ªîI 19 R·ª∞C R·ª†", color: 200 },
        { t: 72000, type: 'shape', val: "CAKE_HEART", color: 50 },
        { t: 82000, action: 'LETTER' }
    ];

    let startTime;
    let isRunning = false;

    function startShow() {
        // Setup Audio
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const src = audioCtx.createMediaElementSource(music);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        src.connect(analyser);
        analyser.connect(audioCtx.destination);
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        music.play();
        document.getElementById('ui-layer').style.display = 'none';
        
        startTime = Date.now();
        isRunning = true;
        loop();
        
        // Timer qu·∫£n l√Ω s·ª± ki·ªán
        timeline.forEach(event => {
            setTimeout(() => {
                if(event.action === 'FIREWORKS') {
                    launchFireworks(event.duration);
                } else if (event.action === 'LETTER') {
                    showLetter();
                } else {
                    scatterDrones(); // T·∫°o hi·ªáu ·ª©ng n·ªï tr∆∞·ªõc khi x·∫øp h√¨nh
                    setTimeout(() => {
                        let pts;
                        if(event.type === 'text') {
                            let fSize = isMobile ? 60 : 100;
                            pts = getPointsFromText(event.val, event.font || 'Cinzel', fSize);
                        } else {
                            pts = getPointsFromShape(event.val);
                        }
                        
                        // Assign targets randomly to avoid lines
                        pts.sort(() => Math.random() - 0.5);
                        
                        drones.forEach((d, i) => {
                            if(pts[i]) {
                                d.tx = pts[i].x; d.ty = pts[i].y;
                                d.color = `hsl(${event.color + Math.random()*30}, 100%, 60%)`;
                            } else {
                                // Drone th·ª´a th√¨ bay v√≤ng quanh
                                d.tx = width/2 + Math.cos(i)*width; 
                                d.ty = height/2 + Math.sin(i)*height;
                            }
                        });
                        
                        // B·∫Øn ph√°o hoa ƒÉn m·ª´ng khi ƒë·ªïi ch·ªØ
                        for(let k=0; k<5; k++) setTimeout(() => createRandomFirework(), k*200);
                        
                    }, 500); // ƒê·ª£i 0.5s cho drone n·ªï ra xa
                }
            }, event.t);
        });
    }

    function launchFireworks(duration) {
        let end = Date.now() + duration;
        let int = setInterval(() => {
            if(Date.now() > end) clearInterval(int);
            createRandomFirework();
        }, 300);
    }

    function createRandomFirework() {
        let types = ['SHELL', 'SHELL', 'WILLOW', 'SHELL'];
        let type = types[Math.floor(Math.random()*types.length)];
        let x = Math.random() * width * 0.8 + width * 0.1;
        let y = height * 0.2 + Math.random() * height * 0.3;
        fireworks.push(new Firework(x, y, type));
    }

    function scatterDrones() {
        drones.forEach(d => {
            // ƒê·∫©y t·∫•t c·∫£ drone ra xa t√¢m ho·∫∑c h∆∞·ªõng ng·∫´u nhi√™n
            d.vx = (Math.random() - 0.5) * 20; 
            d.vy = (Math.random() - 0.5) * 20;
        });
    }

    // --- LOOP CH√çNH ---
    function loop() {
        requestAnimationFrame(loop);
        
        // Ph√¢n t√≠ch nh·∫°c
        if(analyser) {
            analyser.getByteFrequencyData(dataArray);
            let sum = 0; 
            for(let i=0; i<10; i++) sum += dataArray[i];
            bassScale = 0.8 + (sum / 10 / 255) * 1.5; // Scale t·ª´ 0.8 ƒë·∫øn 2.3
        }

        // V·∫Ω n·ªÅn m·ªù ƒë·ªÉ t·∫°o trail
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
        ctx.fillRect(0, 0, width, height);

        // Update Fireworks
        for(let i = fireworks.length - 1; i >= 0; i--) {
            fireworks[i].update();
            if(fireworks[i].exploded) fireworks.splice(i, 1);
        }

        // Update Particles
        for(let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            particles[i].draw();
            if(particles[i].alpha <= 0) particles.splice(i, 1);
        }

        // Update Drones
        ctx.globalCompositeOperation = 'lighter'; // C·ªông h∆∞·ªüng √°nh s√°ng
        drones.forEach(d => {
            d.update();
            d.draw();
        });
        ctx.globalCompositeOperation = 'source-over';
    }

    // --- M√ÄN T√ÇM TH∆Ø ---
    function showLetter() {
        const letterDiv = document.getElementById('letter-container');
        const content = document.getElementById('letter-content');
        const sig = document.getElementById('letter-signature');
        
        letterDiv.style.display = 'flex';
        setTimeout(() => letterDiv.style.opacity = '1', 100);
        
        let text = "D∆∞∆°ng ∆°i, h√¥m nay l√† ng√†y 01/03/2026, c·∫≠u tr√≤n 19 tu·ªïi. T·ªõ ch√∫c c·∫≠u ng√†y c√†ng xinh ƒë·∫πp, h·ªçc gi·ªèi v√† s·ªõm ƒë·∫°t ƒë∆∞·ª£c m·ªçi ∆∞·ªõc m∆°. Xin l·ªói v√¨ nh·ªØng l√∫c t·ªõ \"tr·∫ª tr√¢u\" l√†m c·∫≠u bu·ªìn. Mong c·∫≠u b·ªè qua v√† ch√∫ng ta c√πng ƒë√≥n m·ªôt nƒÉm m·ªõi r·ª±c r·ª° nh√©. C·∫£m ∆°n c·∫≠u v√¨ ƒë√£ xu·∫•t hi·ªán trong cu·ªôc ƒë·ªùi t·ªõ!";
        let i = 0;
        content.innerHTML = "";
        
        let typeInt = setInterval(() => {
            content.innerHTML += text.charAt(i);
            i++;
            if(i >= text.length) {
                clearInterval(typeInt);
                setTimeout(() => {
                    sig.innerHTML = "Nguy·ªÖn B·∫Øc S∆°n<br>‚ù§Ô∏è";
                    sig.style.opacity = '1';
                }, 1000);
            }
        }, 50);
    }

    document.getElementById('start-btn').onclick = startShow;

</script>
</body>
</html>
