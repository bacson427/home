<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HPBD Trương Thị Dương</title>
    <style>
        /* Dùng font đơn giản, nét dày để dễ đọc nhất trên mobile */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Roboto+Mono:wght@700&display=swap');
        
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; }
        
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: none; z-index: 100;
        }

        .btn {
            pointer-events: auto; background: #ffd700;
            color: #000; border: none;
            padding: 15px 40px; font-size: 16px; cursor: pointer; 
            font-family: 'Montserrat', sans-serif; font-weight: 900; 
            border-radius: 50px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        #loading-text { color: #ffd700; font-family: 'Montserrat', sans-serif; margin-bottom: 20px; }

        /* Màn tâm thư */
        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); 
            display: none; justify-content: center; align-items: center; 
            z-index: 200; opacity: 0; transition: opacity 1s ease;
            padding: 20px; box-sizing: border-box;
        }
        
        #letter-content { 
            color: #fff; font-family: 'Roboto Mono', monospace;
            font-size: 16px; line-height: 1.6; text-align: justify;
            max-width: 600px; border: 1px solid #ffd700; padding: 20px;
            background: #111;
        }
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="loading-text">ĐANG TẢI...</div>
        <button id="start-btn" class="btn" style="display:none">BẮT ĐẦU</button>
    </div>

    <div id="letter-container">
        <div id="letter-content"></div>
    </div>

    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" loop crossorigin="anonymous"></audio>

<script>
    const CONFIG = {
        NAME: "TRƯƠNG THỊ DƯƠNG",
        // Bảng màu rực rỡ
        COLORS: [
            '#FFD700', // Vàng
            '#FF0055', // Đỏ hồng
            '#00FFFF', // Xanh Cyan
            '#FFFFFF'  // Trắng
        ]
    };

    const isMobile = window.innerWidth < 768;
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    // CẤU HÌNH DRONE ĐỂ DỄ ĐỌC
    // Mobile thì điểm ảnh to hơn chút, thưa hơn chút để không bị dính cục
    const PARTICLE_STEP = isMobile ? 5 : 3; 
    const DRONE_SIZE = isMobile ? 2.5 : 2; 

    let state = "IDLE";
    let drones = [];
    let fireworks = [];
    let particles = []; // Hạt nổ pháo hoa

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- KHỞI TẠO ---
    window.onload = () => {
        document.getElementById('loading-text').style.display = 'none';
        const btn = document.getElementById('start-btn');
        btn.style.display = 'block';
        
        btn.onclick = () => {
            btn.style.display = 'none';
            // Thử phát nhạc
            const audio = document.getElementById('bg-music');
            audio.play().catch(e => console.log("Cần chạm để phát nhạc"));
            
            // Vào thẳng show luôn cho nhanh
            startShow();
        };
    };

    function startShow() {
        state = "RUNNING";
        let timeline = 0;
        
        // Kịch bản hiển thị (Thời gian + Nội dung)
        const script = [
            // Tách dòng để dễ đọc
            { text: "GỬI ĐẾN", color: "#FFFFFF" },
            { text: CONFIG.NAME, color: "#FF0055" }, // Tên riêng 1 dòng
            { text: "CHÚC MỪNG", color: "#FFD700" },
            { text: "NĂM MỚI 2026", color: "#00FFFF" },
            { text: "XUÂN BÍNH NGỌ", color: "#FFD700" },
            { text: "HAPPY", color: "#FF0055" },
            { text: "VALENTINE", color: "#FF0055" },
            { text: "QUỐC TẾ", color: "#FFFFFF" },
            { text: "PHỤ NỮ 8/3", color: "#FF0055" },
            { text: "SINH NHẬT", color: "#FFD700" },
            { text: "TUỔI 19", color: "#00FFFF" },
            { shape: "HEART", color: "#FF0055" }, // Hình tim
            { action: "LETTER" }
        ];

        let index = 0;

        function nextScene() {
            if(index >= script.length) return;
            
            let scene = script[index];
            index++;

            if(scene.action === "LETTER") {
                showLetter();
                return;
            }

            // Xử lý hiển thị
            if(scene.shape === "HEART") {
                formHeart(scene.color);
            } else {
                formText(scene.text, scene.color);
            }

            // Bắn pháo hoa phụ họa
            shootFirework();

            // Chuyển cảnh sau 5 giây
            setTimeout(nextScene, 5000);
        }

        nextScene();
    }

    // --- XỬ LÝ TEXT THÀNH DRONE (RẤT QUAN TRỌNG) ---
    function formText(text, color) {
        // 1. Vẽ chữ lên canvas ẩn
        const offCv = document.createElement('canvas');
        const offCtx = offCv.getContext('2d');
        
        // Font size to, nét dày
        let fontSize = isMobile ? 80 : 150; 
        offCtx.font = `900 ${fontSize}px "Montserrat"`; // Dùng Montserrat 900 cho dày
        
        let measure = offCtx.measureText(text);
        offCv.width = measure.width + 20; 
        offCv.height = fontSize * 1.5;

        offCtx.font = `900 ${fontSize}px "Montserrat"`;
        offCtx.fillStyle = '#fff';
        offCtx.textBaseline = 'middle';
        offCtx.textAlign = 'center';
        offCtx.fillText(text, offCv.width/2, offCv.height/2);

        // 2. Quét điểm ảnh
        let points = [];
        let data = offCtx.getImageData(0, 0, offCv.width, offCv.height).data;
        
        // Tính toán tỷ lệ scale để chữ vừa khít chiều ngang màn hình
        // Trừ đi 20px lề mỗi bên
        let maxW = width - 40; 
        let scale = Math.min(maxW / offCv.width, (height/2) / offCv.height);
        
        let startX = (width - offCv.width * scale) / 2;
        let startY = (height - offCv.height * scale) / 2;

        for(let y = 0; y < offCv.height; y += PARTICLE_STEP) {
            for(let x = 0; x < offCv.width; x += PARTICLE_STEP) {
                if(data[(y * offCv.width + x) * 4 + 3] > 128) {
                    points.push({
                        x: startX + x * scale,
                        y: startY + y * scale
                    });
                }
            }
        }

        updateDronesTargets(points, color);
    }

    function formHeart(color) {
        let points = [];
        let cx = width/2;
        let cy = height/2;
        let size = Math.min(width, height) * 0.35; // Kích thước tim
        
        // Công thức hình tim toán học
        let count = isMobile ? 400 : 800;
        for(let i=0; i<count; i++) {
            let t = (i/count) * Math.PI * 2;
            let x = 16 * Math.pow(Math.sin(t), 3);
            let y = -(13 * Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t));
            
            points.push({
                x: cx + x * (size/20),
                y: cy + y * (size/20)
            });
        }
        updateDronesTargets(points, color);
    }

    function updateDronesTargets(points, color) {
        // Shuffle points để bay ngẫu nhiên đẹp mắt
        points.sort(() => Math.random() - 0.5);

        // Điều chỉnh số lượng drone
        if(drones.length < points.length) {
            let add = points.length - drones.length;
            for(let i=0; i<add; i++) {
                drones.push({
                    x: Math.random() * width,
                    y: height + 100, // Bay từ dưới lên
                    tx: width/2, ty: height/2,
                    color: color
                });
            }
        }

        // Gán mục tiêu
        drones.forEach((d, i) => {
            if(i < points.length) {
                d.tx = points[i].x;
                d.ty = points[i].y;
                d.color = color;
            } else {
                // Drone thừa thì ẩn đi (bay ra ngoài)
                d.tx = Math.random() * width;
                d.ty = -100;
            }
        });
    }

    // --- PHÁO HOA CƠ BẢN ---
    function shootFirework() {
        let x = Math.random() * width;
        // Bắn cao lên trên (target y nhỏ)
        let ty = Math.random() * (height * 0.4); 
        
        fireworks.push({
            x: x, y: height,
            tx: x, ty: ty,
            vx: 0, vy: -15, // Bay nhanh
            color: CONFIG.COLORS[Math.floor(Math.random()*CONFIG.COLORS.length)],
            state: "RISE"
        });
    }

    function explode(fw) {
        let count = 50;
        for(let i=0; i<count; i++) {
            let angle = Math.random() * Math.PI * 2;
            let speed = Math.random() * 5;
            particles.push({
                x: fw.x, y: fw.y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                color: fw.color,
                life: 1.0
            });
        }
    }

    // --- HIỆN THƯ ---
    function showLetter() {
        const letterDiv = document.getElementById('letter-container');
        const contentDiv = document.getElementById('letter-content');
        letterDiv.style.display = 'flex';
        
        // Hiệu ứng Fade in
        setTimeout(() => { letterDiv.style.opacity = 1; }, 100);

        let text = "Dương ơi, hôm nay là ngày 01/03/2026, cậu tròn 19 tuổi. Tớ chúc cậu ngày càng xinh đẹp, học giỏi, sớm đạt được những ước mơ. Xin lỗi vì thời gian qua đã làm cậu buồn. Năm mới tớ mong cậu bỏ qua cho sự \"trẻ trâu\" của tớ nhé. Cảm ơn cậu! \n\n- Nguyễn Bắc Sơn -";
        
        let idx = 0;
        let timer = setInterval(() => {
            contentDiv.innerText = text.substring(0, idx);
            idx++;
            if(idx > text.length) clearInterval(timer);
        }, 50);
    }

    // --- RENDER LOOP ---
    function animate() {
        requestAnimationFrame(animate);

        // Xóa sạch màn hình (Không dùng mờ đuôi để tránh nhòe chữ)
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, width, height);

        if(state === "IDLE") return;

        // 1. Cập nhật Drone (QUAN TRỌNG: BAY MƯỢT VÀ DỪNG CHUẨN)
        ctx.fillStyle = "#fff";
        drones.forEach(d => {
            // Easing: Di chuyển 10% khoảng cách mỗi khung hình
            // Giúp drone bay nhanh lúc đầu và chậm dần khi đến đích
            d.x += (d.tx - d.x) * 0.1;
            d.y += (d.ty - d.y) * 0.1;
            
            ctx.fillStyle = d.color;
            ctx.fillRect(d.x, d.y, DRONE_SIZE, DRONE_SIZE);
        });

        // 2. Cập nhật Pháo hoa
        for(let i=fireworks.length-1; i>=0; i--) {
            let fw = fireworks[i];
            fw.y += fw.vy;
            fw.vy += 0.2; // Trọng lực

            ctx.fillStyle = fw.color;
            ctx.fillRect(fw.x, fw.y, 3, 3);

            if(fw.vy >= 0) { // Đạt đỉnh
                explode(fw);
                fireworks.splice(i, 1);
            }
        }

        // 3. Cập nhật Hạt nổ
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.02;

            if(p.life <= 0) {
                particles.splice(i, 1);
            } else {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 2, 2);
                ctx.globalAlpha = 1;
            }
        }
    }
    
    animate();

</script>
</body>
</html>
