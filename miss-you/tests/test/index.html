<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday Tr∆∞∆°ng Th·ªã D∆∞∆°ng</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Playball&family=Montserrat:wght@900&display=swap');
        
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: 'Cinzel', serif; touch-action: none; }
        
        /* N·ªÅn tr·ªùi ƒë√™m s√¢u th·∫≥m */
        .galaxy-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at bottom, #121a25 0%, #000000 100%); z-index: 0;
        }
        
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: none; z-index: 100;
        }

        .btn {
            pointer-events: auto; background: rgba(255, 215, 0, 0.15);
            color: #ffd700; border: 2px solid #ffd700;
            padding: 18px 50px; font-size: 18px; cursor: pointer; 
            transition: all 0.4s ease-out;
            text-transform: uppercase; letter-spacing: 4px; font-family: 'Montserrat', sans-serif;
            font-weight: 900; margin-top: 30px; border-radius: 50px; 
            backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
        }
        
        .btn:hover { 
            background: #ffd700; color: #000;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
        }

        .hint { 
            font-family: 'Montserrat', sans-serif; font-size: 11px; 
            color: rgba(255, 255, 255, 0.6); margin-top: 25px; 
            letter-spacing: 2px; text-transform: uppercase; text-align: center; 
        }

        #loading-text { font-size: 16px; color: #d4af37; letter-spacing: 3px; font-weight: bold; }

        /* M√†n t√¢m th∆∞ - Thi·∫øt k·∫ø trang tr·ªçng */
        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); 
            display: none; justify-content: center; align-items: center; 
            z-index: 200; opacity: 0; transition: opacity 2s ease;
        }
        
        #letter-card {
            width: 85%; max-width: 700px;
            padding: 50px;
            background: linear-gradient(135deg, rgba(20,20,25,0.95), rgba(10,10,10,0.95));
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 15px;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.15);
            text-align: center;
            position: relative;
        }
        
        /* Trang tr√≠ g√≥c thi·ªáp */
        #letter-card::before, #letter-card::after {
            content: '‚ú®'; position: absolute; font-size: 30px;
        }
        #letter-card::before { top: 10px; left: 10px; }
        #letter-card::after { bottom: 10px; right: 10px; }

        #letter-header {
            color: #ffd700; font-family: 'Cinzel', serif; font-size: 24px;
            margin-bottom: 20px; border-bottom: 1px solid rgba(255,215,0,0.3);
            padding-bottom: 10px;
        }

        #letter-content { 
            color: #eee; font-family: 'Montserrat', sans-serif;
            font-size: clamp(16px, 3vw, 19px); line-height: 1.8; 
            font-weight: 500; text-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        
        #letter-signature { 
            font-family: 'Playball', cursive; 
            font-size: clamp(24px, 4vw, 32px); 
            color: #ffd700; margin-top: 30px;
        }

        .cursor { display: inline-block; width: 3px; height: 1em; background: #ffd700; animation: blink 1s infinite; margin-left: 5px; }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body>
    <div class="galaxy-bg"></div>
    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="loading-text">ƒêANG N·∫†P D·ªÆ LI·ªÜU...</div>
        <button id="start-btn" class="btn" style="display:none">B·∫ÆT ƒê·∫¶U BU·ªîI TI·ªÜC</button>
        <div id="hint-text" class="hint" style="display:none">ƒêeo tai nghe v√† tƒÉng √¢m l∆∞·ª£ng nh√©</div>
        <button id="next-btn" class="btn" style="display:none">K√çCH HO·∫†T DRONE SHOW</button>
    </div>

    <div id="letter-container">
        <div id="letter-card">
            <div id="letter-header">TH∆Ø G·ª¨I D∆Ø∆†NG</div>
            <div id="letter-content"></div>
            <div id="letter-signature"></div>
        </div>
    </div>

    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" loop crossorigin="anonymous"></audio>

<script>
    // --- C·∫§U H√åNH ---
    const CONFIG = {
        NAME: "TR∆Ø∆†NG TH·ªä D∆Ø∆†NG",
        COLORS: {
            GOLD: { h: 45, s: 100, l: 50 }, // V√†ng ƒë·∫≠m
            RED: { h: 350, s: 100, l: 60 },
            PINK: { h: 320, s: 100, l: 75 },
            BLUE: { h: 220, s: 100, l: 65 },
            WHITE: { h: 0, s: 0, l: 100 }
        }
    };

    // --- VARIABLES ---
    const isMobile = window.innerWidth < 768;
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { alpha: false }); 
    let width, height;
    
    // T·ªêI ∆ØU HI·ªÇN TH·ªä (QUAN TR·ªåNG)
    // Gi·∫£m s·ªë n√†y xu·ªëng ƒë·ªÉ drone d√†y h∆°n (Mobile: 4, PC: 2 l√† r·∫•t d√†y)
    const PARTICLE_DENSITY = isMobile ? 3.5 : 2; 
    // TƒÉng k√≠ch th∆∞·ªõc h·∫°t ƒë·ªÉ d·ªÖ nh√¨n h∆°n
    const DRONE_SIZE = isMobile ? 2.2 : 2.0;
    // T·ªëc ƒë·ªô bay (nh·ªè = ch·∫≠m, m∆∞·ª£t)
    const DRONE_SPEED = 0.025;
    
    let state = "LOAD"; 
    let fireworks = [], particles = [], drones = [], shockwaves = [];
    let audioCtx, analyser, dataArray;
    let time = 0; 

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    const rand = (min, max) => Math.random() * (max - min) + min;

    // --- AUDIO ---
    function initAudio() {
        if(audioCtx) return;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const el = document.getElementById('bg-music');
            const src = audioCtx.createMediaElementSource(el);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 128; // TƒÉng ƒë·ªô nh·∫°y
            src.connect(analyser);
            analyser.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            el.play();
        } catch(e) { console.log("Audio Error:", e); }
    }

    function getBass() {
        if(!analyser) return 0;
        analyser.getByteFrequencyData(dataArray);
        let sum = 0; 
        for(let i=0; i<8; i++) sum += dataArray[i];
        return sum / 8; 
    }

    // --- UI LOGIC ---
    window.onload = () => {
        document.getElementById('loading-text').style.display = 'none';
        const btn = document.getElementById('start-btn');
        btn.style.display = 'block';
        document.getElementById('hint-text').style.display = 'block';

        btn.onclick = () => {
            initAudio();
            btn.style.display = 'none';
            document.getElementById('hint-text').style.display = 'none';
            state = "FIREWORKS";
            launchOpeningFireworks();
        };

        document.getElementById('next-btn').onclick = () => {
            document.getElementById('next-btn').style.display = 'none';
            startCountdown();
        };
    };

    // --- PH·∫¶N 1: PH√ÅO HOA KHAI M·∫†C (ƒê√É CH·ªàNH ƒê·ªò CAO) ---
    function launchOpeningFireworks() {
        let duration = 8000;
        let start = Date.now();
        
        let loop = setInterval(() => {
            if(Date.now() - start > duration) {
                clearInterval(loop);
                document.getElementById('next-btn').style.display = 'block';
                return;
            }
            // ty (target y) th·∫•p -> b·∫Øn cao (g·∫ßn ƒë·ªânh m√†n h√¨nh)
            // height*0.1 l√† ƒë·ªânh, height*0.4 l√† gi·ªØa
            createRocket(rand(width*0.1, width*0.9), height, rand(width*0.1, width*0.9), rand(height*0.05, height*0.35));
        }, 600);
    }

    // --- PH·∫¶N 2: ƒê·∫æM NG∆Ø·ª¢C ---
    function startCountdown() {
        state = "COUNTDOWN";
        let count = 10;
        
        let cdInterval = setInterval(() => {
            createShockwave(width/2, height/2); 
            count--;
            
            // Ph√°o hoa ph·ª• h·ªça khi ƒë·∫øm
            if(count > 0 && count % 2 === 0) {
                 createRocket(width*0.2, height, width*0.2, height*0.2, "STAR");
                 createRocket(width*0.8, height, width*0.8, height*0.2, "STAR");
            }

            if(count < 0) {
                clearInterval(cdInterval);
                state = "TRANSITION";
                setTimeout(startDroneShow, 1000);
            }
        }, 1000);

        window.currentCountdown = 10;
        let numInterval = setInterval(() => {
            window.currentCountdown--;
            if(window.currentCountdown < 0) clearInterval(numInterval);
        }, 1000);
    }

    // --- PH·∫¶N 3: DRONE SHOW (K√âO D√ÄI TH·ªúI GIAN) ---
    function startDroneShow() {
        state = "DRONE";
        
        // Th·ªùi gian ch·ªù gi·ªØa c√°c c·∫£nh (ms) - ƒê√£ tƒÉng l√™n 12s
        const STEP = 12000; 
        
        const script = [
            // M√†n 1: X√°c ƒë·ªãnh ng∆∞·ªùi nh·∫≠n r√µ r√†ng
            { t: 0, text: "G·ª¨I ƒê·∫æN", color: CONFIG.COLORS.WHITE },
            { t: STEP * 0.8, text: CONFIG.NAME, color: CONFIG.COLORS.PINK, font: "Montserrat" },
            
            // M√†n 2: L·ªùi ch√∫c
            { t: STEP * 1.8, text: "CH√öC M·ª™NG", color: CONFIG.COLORS.RED },
            { t: STEP * 2.8, text: "NƒÇM M·ªöI 2026", color: CONFIG.COLORS.GOLD },
            { t: STEP * 3.8, text: "XU√ÇN B√çNH NG·ªå", color: CONFIG.COLORS.BLUE },
            
            // M√†n 3: S·ª± ki·ªán
            { t: STEP * 4.8, text: "HAPPY VALENTINE", color: CONFIG.COLORS.PINK },
            { t: STEP * 5.8, text: "QU·ªêC T·∫æ PH·ª§ N·ªÆ 8/3", color: CONFIG.COLORS.RED },
            
            // M√†n 4: Sinh nh·∫≠t
            { t: STEP * 6.8, text: "SINH NH·∫¨T VUI V·∫∫", color: CONFIG.COLORS.GOLD },
            { t: STEP * 7.8, text: "TU·ªîI 19 R·ª∞C R·ª†", color: CONFIG.COLORS.BLUE },
            
            // M√†n 5: H√¨nh ·∫£nh b√°nh v√† tim
            { t: STEP * 8.8, type: "IMAGE", color: CONFIG.COLORS.GOLD }, 
            
            // K·∫øt th√∫c
            { t: STEP * 10, action: "END" }
        ];

        let baseTime = Date.now();
        
        script.forEach(scene => {
            setTimeout(() => {
                if(scene.action === "END") {
                    showLetter();
                    return;
                }
                
                // Hi·ªáu ·ª©ng "Bung l·ª•a" tr∆∞·ªõc khi x·∫øp h√¨nh m·ªõi
                scatterDrones();

                if(scene.type === "IMAGE") {
                    formImageShape();
                } else {
                    formText(scene.text, scene.color, scene.font || "Cinzel");
                }
                
                // B·∫Øn ph√°o hoa t·∫ßm cao ƒë·ªÉ kh√¥ng che ch·ªØ
                setTimeout(() => {
                    createRocket(width*0.1, height, width*0.15, height*0.15, "HEART");
                    createRocket(width*0.9, height, width*0.85, height*0.15, "HEART");
                }, 1000);

            }, scene.t);
        });
    }

    // --- LOGIC V·∫¨T L√ù ---

    function createRocket(x, y, tx, ty, shape="CIRCLE") {
        fireworks.push({
            x: x, y: y, tx: tx, ty: ty,
            vx: (tx - x) * 0.015,
            // TƒÉng v·∫≠n t·ªëc ban ƒë·∫ßu ƒë·ªÉ b·∫Øn cao h∆°n (s·ªë √¢m c√†ng l·ªõn c√†ng nhanh)
            vy: -rand(18, 22), 
            color: `hsl(${rand(0, 360)}, 100%, 70%)`,
            shape: shape,
            state: "FLY"
        });
    }

    function createExplosion(x, y, color, shape) {
        let count = isMobile ? 80 : 150; // TƒÉng s·ªë l∆∞·ª£ng h·∫°t n·ªï
        let bass = getBass();
        let power = 1 + (bass/200); 

        for(let i=0; i<count; i++) {
            let angle = rand(0, Math.PI*2);
            let speed = rand(2, 6) * power; // N·ªï to h∆°n
            let p = {
                x: x, y: y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                color: color,
                alpha: 1,
                decay: rand(0.008, 0.02), // H·∫°t t·ªìn t·∫°i l√¢u h∆°n
                gravity: 0.08
            };

            if(shape === "HEART") {
                let t = rand(0, Math.PI*2);
                p.vx = (16 * Math.pow(Math.sin(t), 3)) * 0.15 * power;
                p.vy = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * 0.15 * power;
            } else if (shape === "STAR") {
                let a = (i/count) * Math.PI * 4; // Sao 5 c√°nh xo√°y
                p.vx += Math.cos(a) * speed * 0.5;
                p.vy += Math.sin(a) * speed * 0.5;
            }

            particles.push(p);
        }
        createShockwave(x, y);
    }

    function createShockwave(x, y) {
        shockwaves.push({ x: x, y: y, r: 0, alpha: 0.8 });
    }

    // --- DRONE LOGIC (C·ª∞C M·ªäN) ---
    function updateDrones() {
        let bass = getBass();
        // ƒê·ªô rung ƒë·ªông c·ªßa drone khi ƒë·ª©ng y√™n (Th·ªü)
        let hover = (Math.sin(time * 0.05) * 1.5) + (bass/255 * 3);

        drones.forEach(d => {
            let dx = d.tx - d.x;
            let dy = d.ty - d.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            // Easing function (l√†m m∆∞·ª£t chuy·ªÉn ƒë·ªông)
            let moveFactor = DRONE_SPEED;
            if(dist > 100) moveFactor *= 2; // Xa th√¨ bay nhanh h∆°n ch√∫t
            
            d.vx = dx * moveFactor; 
            d.vy = dy * moveFactor;

            // Perlin noise gi·∫£ l·∫≠p (bay l∆∞·ª£n t·ª± nhi√™n)
            d.x += d.vx + Math.cos(time * 0.02 + d.offset) * 0.5;
            d.y += d.vy + Math.sin(time * 0.02 + d.offset) * 0.5;

            // Hi·ªáu ·ª©ng Hover khi ƒë√£ v√†o v·ªã tr√≠
            if(dist < 10) {
                d.y += Math.sin(time * 0.1 + d.x * 0.01) * 0.5; // S√≥ng l∆∞·ª£n
            }

            // V·∫Ω Drone
            ctx.fillStyle = d.color;
            // Hi·ªáu ·ª©ng l·∫•p l√°nh ng·∫´u nhi√™n
            if(Math.random() > 0.98) ctx.fillStyle = '#fff'; 
            
            ctx.fillRect(d.x, d.y, d.size, d.size);
        });
    }

    function formText(text, colorObj, fontName) {
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d');
        
        let fSize = isMobile ? 60 : 120;
        // T·ª± ƒë·ªông scale font n·∫øu t√™n qu√° d√†i
        if(text.length > 8) fSize = fSize * 0.8;
        if(text.length > 12) fSize = fSize * 0.6;

        offCtx.font = `900 ${fSize}px "${fontName}"`;
        let measure = offCtx.measureText(text);
        offCanvas.width = measure.width + 60;
        offCanvas.height = fSize * 2.5;
        
        offCtx.font = `900 ${fSize}px "${fontName}"`;
        offCtx.fillStyle = '#fff';
        offCtx.textBaseline = 'middle';
        offCtx.textAlign = 'center';
        // Th√™m Stroke (vi·ªÅn) ƒë·ªÉ ch·ªØ d√†y h∆°n
        offCtx.lineWidth = 2;
        offCtx.strokeStyle = '#fff';
        offCtx.strokeText(text, offCanvas.width/2, offCanvas.height/2);
        offCtx.fillText(text, offCanvas.width/2, offCanvas.height/2);

        scanPixelsAndAssign(offCanvas, colorObj);
    }

    function formImageShape() {
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d');
        let s = Math.min(width, height) * 0.7; // H√¨nh to
        offCanvas.width = s; offCanvas.height = s;
        
        offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';
        
        let fontSize = s * 0.4;
        offCtx.font = `${fontSize}px Arial`;
        offCtx.fillStyle = "#fff";
        // V·∫Ω s√°t nhau
        offCtx.fillText("üéÇ‚ù§Ô∏è", s/2, s/2);

        scanPixelsAndAssign(offCanvas, CONFIG.COLORS.GOLD);
    }

    function scanPixelsAndAssign(sourceCanvas, colorObj) {
        let imgData = sourceCanvas.getContext('2d').getImageData(0,0, sourceCanvas.width, sourceCanvas.height).data;
        let points = [];
        
        let scale = Math.min(width * 0.85 / sourceCanvas.width, height * 0.5 / sourceCanvas.height);
        let startX = (width - sourceCanvas.width * scale) / 2;
        let startY = (height - sourceCanvas.height * scale) / 2;

        for(let y=0; y<sourceCanvas.height; y+=PARTICLE_DENSITY) {
            for(let x=0; x<sourceCanvas.width; x+=PARTICLE_DENSITY) {
                if(imgData[(y*sourceCanvas.width + x)*4 + 3] > 128) {
                    points.push({
                        x: startX + x * scale,
                        y: startY + y * scale
                    });
                }
            }
        }

        // T·∫°o th√™m drone n·∫øu thi·∫øu
        if(drones.length < points.length) {
            let needed = points.length - drones.length;
            for(let i=0; i<needed; i++) {
                drones.push({
                    x: Math.random() * width, 
                    y: height + 200, 
                    tx: width/2, ty: height/2,
                    vx: 0, vy: 0,
                    size: DRONE_SIZE,
                    offset: Math.random() * 100,
                    color: '#fff'
                });
            }
        }

        points.sort(() => Math.random() - 0.5);

        drones.forEach((d, i) => {
            if(i < points.length) {
                d.tx = points[i].x;
                d.ty = points[i].y;
                let h = colorObj.h + (d.tx / width) * 40; // Gradient m√†u ngang
                d.color = `hsl(${h}, ${colorObj.s}%, ${colorObj.l}%)`;
            } else {
                // Drone th·ª´a bay ·∫©n ƒëi
                d.tx = Math.random() * width;
                d.ty = height + 200;
                d.color = 'transparent';
            }
        });
    }

    function scatterDrones() {
        drones.forEach(d => {
            d.vx = (Math.random()-0.5) * 30; // Gi·∫≠t m·∫°nh m·ªôt c√°i
            d.vy = (Math.random()-0.5) * 30;
        });
    }

    // --- M√ÄN CU·ªêI: T√ÇM TH∆Ø ---
    function showLetter() {
        state = "LETTER";
        document.getElementById('letter-container').style.display = 'flex';
        setTimeout(() => { document.getElementById('letter-container').style.opacity = 1; }, 100);

        const content = "D∆∞∆°ng ∆°i, h√¥m nay l√† ng√†y 01/03/2026, c·∫≠u c≈©ng tr√≤n 19 tu·ªïi. T·ªõ ch√∫c c·∫≠u ng√†y c√†ng xinh ƒë·∫πp, h·ªçc gi·ªèi, ƒë·∫°t ƒë∆∞·ª£c k·∫øt qu·∫£ cao trong h·ªçc t·∫≠p, s·ªõm ƒë·∫°t ƒë∆∞·ª£c nh·ªØng ∆∞·ªõc m∆° m√† c·∫≠u ƒë√£ t·ª´ng mong ∆∞·ªõc. T·ªõ c≈©ng xin l·ªói, th·ªùi gian v·ª´a qua ƒë√£ l√†m c·∫≠u ph·∫£i bu·ªìn, gi·∫≠n, ch√°n gh√©t t·ªõ. Th√¥i c≈©ng ƒë√£ qua nƒÉm m·ªõi t·ªõ mong r·∫±ng c·∫≠u c√≥ th·ªÉ kh√¥ng ƒë·ªÉ b·ª•ng ƒë·∫øn t√≠nh c√°ch \"tr·∫ª tr√¢u\" c·ªßa t·ªõ. T·ªõ c·∫£m ∆°n c·∫≠u!";
        
const el = document.getElementById('letter-content');
        let idx = 0;
        
        let typeInt = setInterval(() => {
            el.innerHTML = content.substring(0, idx) + '<span class="cursor"></span>';
            idx++;
            if(idx > content.length) {
                clearInterval(typeInt);
                el.innerHTML = content; 
                setTimeout(() => {
                    document.getElementById('letter-signature').innerHTML = "Ng∆∞·ªùi g·ª≠i: Nguy·ªÖn B·∫Øc S∆°n<br>‚ù§Ô∏è";
                }, 1000);
            }
        }, 50); // T·ªëc ƒë·ªô g√µ ch·ªØ
    }

    // --- MAIN LOOP ---
    function animate() {
        requestAnimationFrame(animate);
        time++;

        // X√≥a m√†n h√¨nh m·ªù ƒëu√¥i
        ctx.fillStyle = 'rgba(2, 2, 5, 0.25)'; 
        ctx.fillRect(0, 0, width, height);

        ctx.globalCompositeOperation = 'lighter';

        // 1. Render Ph√°o hoa
        for(let i = fireworks.length - 1; i >= 0; i--) {
            let fw = fireworks[i];
            if(fw.state === "FLY") {
                fw.x += fw.vx;
                fw.y += fw.vy;
                fw.vy += 0.15; // Gravity
                
                ctx.beginPath(); ctx.arc(fw.x, fw.y, 2.5, 0, Math.PI*2); 
                ctx.fillStyle = fw.color; ctx.fill();

                if(fw.vy >= 0 || fw.y <= fw.ty) {
                    createExplosion(fw.x, fw.y, fw.color, fw.shape);
                    fireworks.splice(i, 1);
                }
            }
        }

        // 2. Render H·∫°t n·ªï
        for(let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy;
            p.vy += p.gravity;
            p.vx *= 0.96; p.vy *= 0.96; 
            p.alpha -= p.decay;

            if(p.alpha <= 0) {
                particles.splice(i, 1);
            } else {
                ctx.globalAlpha = p.alpha;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 2, 2);
            }
        }

        // 3. Render Shockwaves
        ctx.lineWidth = 3;
        for(let i = shockwaves.length - 1; i >= 0; i--) {
            let s = shockwaves[i];
            s.r += 6;
            s.alpha -= 0.04;
            if(s.alpha <= 0) {
                shockwaves.splice(i, 1);
            } else {
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
                ctx.strokeStyle = `rgba(255, 215, 0, ${s.alpha})`;
                ctx.stroke();
            }
        }
        ctx.globalAlpha = 1;

        // 4. Render Countdown
        if(state === "COUNTDOWN") {
            ctx.fillStyle = "#fff";
            ctx.font = "bold 180px Cinzel";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            // Hi·ªáu ·ª©ng rung nh·∫π khi ƒë·∫øm
            let shakeX = (Math.random()-0.5) * 5;
            let shakeY = (Math.random()-0.5) * 5;
            ctx.fillText(window.currentCountdown || "", width/2 + shakeX, height/2 + shakeY);
        }

        // 5. Render Drones
        if(state === "DRONE") {
            updateDrones();
        }

        ctx.globalCompositeOperation = 'source-over';
    }

    animate();

</script>
</body>
</html>