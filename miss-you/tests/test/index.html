<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HPBD Dương Ultimate Show</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Montserrat:wght@800&family=Dancing+Script:wght@700&display=swap');

body {
    margin: 0;
    overflow: hidden;
    background: #000;
    font-family: Cinzel;
}

canvas { position: fixed; top: 0; left: 0; }

#ui {
    position: fixed; inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
}

button {
    padding: 14px 40px;
    background: rgba(255,215,0,.1);
    border: 1px solid gold;
    color: gold;
    font-size: 18px;
    border-radius: 30px;
    cursor: pointer;
    font-weight: 900;
}

#letter {
    position: fixed;
    inset: 0;
    background: #8b0000;
    color: white;
    display: none;
    padding: 30px;
    font-family: Montserrat;
    z-index: 999;
}
</style>
</head>

<body>

<canvas id="cv"></canvas>

<div id="ui">
<button id="start">KHAI TIỆC</button>
</div>

<div id="letter">
<div id="letterText"></div>
<div id="sign"></div>
</div>

<audio id="music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3"></audio>

<script>
// ================= CONFIG =================
const CONFIG = {
NAME:"TRƯƠNG THỊ DƯƠNG",
LETTER:"Dương ơi, hôm nay cậu tròn 19 tuổi. Tớ chúc cậu luôn xinh đẹp, học giỏi và đạt được mọi ước mơ. Tớ xin lỗi vì đã làm cậu buồn. Mong năm mới cậu luôn vui vẻ và hạnh phúc.",
};

// ================ CANVAS ==================
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
let W,H;
function resize(){W=cv.width=innerWidth;H=cv.height=innerHeight;}
resize(); addEventListener("resize",resize);

const isMobile = W < 768;

// ================ AUDIO ==================
const music = document.getElementById("music");
const AC = new AudioContext();
const src = AC.createMediaElementSource(music);
const analyser = AC.createAnalyser();
src.connect(analyser);
analyser.connect(AC.destination);
analyser.fftSize = 256;
const data = new Uint8Array(analyser.frequencyBinCount);
let beat = 0;

// ================ DRONE ==================
let drones = [];
let droneSpeed = isMobile ? 0.012 : 0.02;

// ================ FIREWORK =================
let fireworks = [], particles = [];

// ================ TEXT DRONE ===============
function makeTextPoints(text){
    const c = document.createElement("canvas");
    const cctx = c.getContext("2d");
    let size = Math.min(W/10, isMobile?40:80);
    cctx.font = "900 "+size+"px Cinzel";
    let w = cctx.measureText(text).width+20;
    c.width=w; c.height=size*1.5;
    cctx.font = "900 "+size+"px Cinzel";
    cctx.fillStyle="white";
    cctx.textAlign="center";
    cctx.textBaseline="middle";
    cctx.fillText(text,w/2,size/1.5);

    let img = cctx.getImageData(0,0,w,c.height).data;
    let pts=[];
    let step = isMobile?5:3;
    for(let y=0;y<c.height;y+=step){
        for(let x=0;x<w;x+=step){
            if(img[(y*w+x)*4+3]>100){
                pts.push({x:(W-w)/2+x,y:(H-c.height)/2+y});
            }
        }
    }
    return pts;
}

function setDrones(points){
    while(drones.length<points.length)
        drones.push({x:W/2,y:H+100,tx:0,ty:0});
    points.forEach((p,i)=>{
        drones[i].tx=p.x;
        drones[i].ty=p.y;
    });
}

// ================ SHAPES ===================
function cakeHeart(){
    let pts=[];
    let cx=W/2, cy=H/2;
    let r=Math.min(W,H)*0.25;

    // cake circle
    for(let i=0;i<600;i++){
        let a=Math.random()*Math.PI*2;
        pts.push({x:cx+Math.cos(a)*r, y:cy+Math.sin(a)*r});
    }

    // heart
    for(let i=0;i<800;i++){
        let t=i/800*Math.PI*2;
        let x=16*Math.pow(Math.sin(t),3);
        let y=-(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t));
        pts.push({x:cx+x*r/30, y:cy-r+y*r/30});
    }

    setDrones(pts);
}

// ================ FIREWORKS =================
function fire(x,y){
    fireworks.push({x,y,ty:H*0.2+Math.random()*H*0.3,ex:false});
}
function explode(f){
    f.ex=true;
    let count = 30 + beat*0.4;
    for(let i=0;i<count;i++){
        let a=i/count*Math.PI*2;
        let s=Math.random()*3;
        particles.push({x:f.x,y:f.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1});
    }
}

// ================ LETTER ==================
function showLetter(){
    document.getElementById("letter").style.display="block";
    let t=CONFIG.LETTER;
    let el=document.getElementById("letterText");
    let i=0;
    let timer=setInterval(()=>{
        el.innerHTML=t.slice(0,i++);
        if(i>t.length){
            clearInterval(timer);
            document.getElementById("sign").innerHTML="Người gửi: NGUYỄN BẮC SƠN<br>Người nhận: "+CONFIG.NAME;
        }
    },50);
}

// ================ ANIMATE =================
function loop(){
requestAnimationFrame(loop);
ctx.clearRect(0,0,W,H);

// audio beat
analyser.getByteFrequencyData(data);
beat = data.reduce((a,b)=>a+b)/data.length;

// fireworks
if(Math.random()<0.05) fire(Math.random()*W,H);

fireworks.forEach((f,i)=>{
    if(!f.ex){
        f.y-=5;
        if(f.y<f.ty) explode(f);
        ctx.fillStyle="gold";
        ctx.fillRect(f.x,f.y,2,2);
    }else fireworks.splice(i,1);
});

particles.forEach((p,i)=>{
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.life-=0.02;
    if(p.life<0) particles.splice(i,1);
    else{
        ctx.globalAlpha=p.life;
        ctx.fillStyle="hsl("+Math.random()*360+",100%,60%)";
        ctx.fillRect(p.x,p.y,2,2);
    }
});
ctx.globalAlpha=1;

// drones
drones.forEach(d=>{
    d.x+=(d.tx-d.x)*droneSpeed;
    d.y+=(d.ty-d.y)*droneSpeed;
    ctx.fillStyle="white";
    ctx.fillRect(d.x,d.y,2,2);
});
}
loop();

// ================ SHOW SEQUENCE =============
document.getElementById("start").onclick=async ()=>{
    await AC.resume();
    music.play();

    setDrones(makeTextPoints("HAPPY BIRTHDAY DƯƠNG"));
    setTimeout(()=>setDrones(makeTextPoints("CHÚC MỪNG SINH NHẬT TUỔI 19")),6000);
    setTimeout(()=>cakeHeart(),14000);
    setTimeout(()=>showLetter(),22000);
};
</script>

</body>
</html>