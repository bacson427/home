<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HPBD Trương Thị Dương (V7 Final)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Roboto+Mono:wght@700&display=swap');
        
        body { margin: 0; overflow: hidden; background-color: #050505; touch-action: none; }
        
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: none; z-index: 100;
        }

        .btn {
            pointer-events: auto; background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #000; border: none;
            padding: 18px 50px; font-size: 18px; cursor: pointer; 
            font-family: 'Montserrat', sans-serif; font-weight: 900; 
            border-radius: 50px; box-shadow: 0 0 30px rgba(255, 170, 0, 0.5);
            transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        
        #loading-text { color: #ffd700; font-family: 'Montserrat', sans-serif; margin-bottom: 20px; font-weight: bold; letter-spacing: 2px; }

        /* Màn tâm thư */
        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.96); 
            display: none; justify-content: center; align-items: center; 
            z-index: 200; opacity: 0; transition: opacity 1.5s ease;
            padding: 20px; box-sizing: border-box;
        }
        
        #letter-content { 
            color: #fff; font-family: 'Roboto Mono', monospace;
            font-size: clamp(14px, 4vw, 17px); line-height: 1.8; text-align: justify;
            max-width: 650px; border: 2px solid #ffd700; padding: 30px;
            background: #111; box-shadow: 0 0 50px rgba(255, 215, 0, 0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="loading-text">ĐANG TẢI DỮ LIỆU...</div>
        <button id="start-btn" class="btn" style="display:none">KHAI TIỆC NGAY</button>
    </div>

    <div id="letter-container">
        <div id="letter-content"></div>
    </div>

    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" loop crossorigin="anonymous"></audio>

<script>
    const CONFIG = {
        NAME: "TRƯƠNG THỊ DƯƠNG",
        COLORS: ['#FFD700', '#FF1493', '#00FFFF', '#FFFFFF', '#FF4500']
    };

    const isMobile = window.innerWidth < 768;
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    // --- CẤU HÌNH TINH CHỈNH ---
    const PARTICLE_STEP = isMobile ? 5 : 3; 
    const DRONE_SIZE = isMobile ? 2.5 : 2; 
    // Tốc độ Drone: Càng nhỏ càng chậm (0.05 là chậm vừa phải)
    const DRONE_SPEED = 0.05; 

    let state = "IDLE";
    let drones = [];
    let fireworks = [];
    let particles = []; 
    let fireworkInterval = null;

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    window.onload = () => {
        document.getElementById('loading-text').style.display = 'none';
        const btn = document.getElementById('start-btn');
        btn.style.display = 'block';
        
        btn.onclick = () => {
            btn.style.display = 'none';
            const audio = document.getElementById('bg-music');
            audio.play().catch(e => console.log("Cần chạm để phát nhạc"));
            startShow();
        };
    };

    function startShow() {
        state = "RUNNING";
        
        // Bắt đầu bắn pháo hoa liên tục (Mỗi 600ms bắn 1 quả)
        fireworkInterval = setInterval(() => {
            // Bắn ngẫu nhiên 1 hoặc 2 quả cùng lúc cho dày
            shootFirework();
            if(Math.random() > 0.5) shootFirework();
        }, 600);

        // Kịch bản (Mỗi cảnh 10 giây)
        const script = [
            { text: "GỬI ĐẾN", color: "#FFFFFF" },
            { text: CONFIG.NAME, color: "#FF1493" }, 
            { text: "CHÚC MỪNG", color: "#FFD700" },
            { text: "NĂM MỚI 2026", color: "#00FFFF" },
            { text: "XUÂN BÍNH NGỌ", color: "#FF4500" },
            { text: "HAPPY", color: "#FF1493" },
            { text: "VALENTINE", color: "#FF1493" },
            { text: "QUỐC TẾ", color: "#FFFFFF" },
            { text: "PHỤ NỮ 8/3", color: "#FF1493" },
            { text: "SINH NHẬT", color: "#FFD700" },
            { text: "TUỔI 19", color: "#00FFFF" },
            { shape: "HEART", color: "#FF1493" }, 
            { action: "LETTER" }
        ];

        let index = 0;

        function nextScene() {
            if(index >= script.length) return;
            
            let scene = script[index];
            index++;

            if(scene.action === "LETTER") {
                clearInterval(fireworkInterval); // Dừng pháo hoa để đọc thư
                showLetter();
                return;
            }

            if(scene.shape === "HEART") formHeart(scene.color);
            else formText(scene.text, scene.color);

            // Thời gian chờ mỗi cảnh: 10000ms = 10 giây
            setTimeout(nextScene, 10000);
        }

        nextScene();
    }

    // --- TEXT TO DRONE ---
    function formText(text, color) {
        const offCv = document.createElement('canvas');
        const offCtx = offCv.getContext('2d');
        let fontSize = isMobile ? 70 : 140; 
        
        offCtx.font = `900 ${fontSize}px "Montserrat"`;
        let measure = offCtx.measureText(text);
        offCv.width = measure.width + 30; 
        offCv.height = fontSize * 1.5;

        offCtx.font = `900 ${fontSize}px "Montserrat"`;
        offCtx.fillStyle = '#fff';
        offCtx.textBaseline = 'middle';
        offCtx.textAlign = 'center';
        offCtx.fillText(text, offCv.width/2, offCv.height/2);

        processPoints(offCv, color);
    }

    function formHeart(color) {
        let points = [];
        let cx = width/2, cy = height/2;
        let size = Math.min(width, height) * 0.4; 
        let count = isMobile ? 500 : 900;

        for(let i=0; i<count; i++) {
            let t = (i/count) * Math.PI * 2;
            let x = 16 * Math.pow(Math.sin(t), 3);
            let y = -(13 * Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t));
            points.push({ x: cx + x * (size/20), y: cy + y * (size/20) });
        }
        updateDronesTargets(points, color);
    }

    function processPoints(offCv, color) {
        let points = [];
        let data = offCv.getContext('2d').getImageData(0, 0, offCv.width, offCv.height).data;
        let maxW = width - 20; 
        let scale = Math.min(maxW / offCv.width, (height/2) / offCv.height);
        let startX = (width - offCv.width * scale) / 2;
        let startY = (height - offCv.height * scale) / 2;

        for(let y = 0; y < offCv.height; y += PARTICLE_STEP) {
            for(let x = 0; x < offCv.width; x += PARTICLE_STEP) {
                if(data[(y * offCv.width + x) * 4 + 3] > 128) {
                    points.push({ x: startX + x * scale, y: startY + y * scale });
                }
            }
        }
        updateDronesTargets(points, color);
    }

    function updateDronesTargets(points, color) {
        points.sort(() => Math.random() - 0.5);
        if(drones.length < points.length) {
            let add = points.length - drones.length;
            for(let i=0; i<add; i++) {
                drones.push({
                    x: Math.random() * width, y: height + 50,
                    tx: width/2, ty: height/2,
                    color: color
                });
            }
        }
        drones.forEach((d, i) => {
            if(i < points.length) {
                d.tx = points[i].x; d.ty = points[i].y; d.color = color;
            } else {
                d.tx = Math.random() * width; d.ty = -100; // Bay biến mất
            }
        });
    }

    // --- PHÁO HOA LIÊN TỤC ---
    function shootFirework() {
        let x = Math.random() * width;
        // Bắn cao hơn (chỉ nổ ở 1/3 trên màn hình)
        let ty = Math.random() * (height * 0.35); 
        fireworks.push({
            x: x, y: height, tx: x, ty: ty,
            vx: 0, vy: -Math.random()*3 - 12, // Tốc độ bắn lên
            color: CONFIG.COLORS[Math.floor(Math.random()*CONFIG.COLORS.length)],
            state: "RISE"
        });
    }

    function explode(fw) {
        let count = 40;
        for(let i=0; i<count; i++) {
            let angle = Math.random() * Math.PI * 2;
            let speed = Math.random() * 4 + 1;
            particles.push({
                x: fw.x, y: fw.y,
                vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
                color: fw.color, life: 1.2, gravity: 0.1
            });
        }
    }

    // --- TÂM THƯ ---
    function showLetter() {
        const letterDiv = document.getElementById('letter-container');
        const contentDiv = document.getElementById('letter-content');
        letterDiv.style.display = 'flex';
        setTimeout(() => { letterDiv.style.opacity = 1; }, 100);

        let text = "Dương ơi, hôm nay 01/03/2026, cậu tròn 19 tuổi. Tớ chúc cậu ngày càng xinh đẹp, học giỏi, sớm đạt được mọi ước mơ. Xin lỗi vì những lúc trẻ con làm cậu buồn. Năm mới mong cậu bỏ qua cho tớ nhé. Cảm ơn cậu rất nhiều! \n\n- Nguyễn Bắc Sơn -";
        
        let idx = 0;
        let timer = setInterval(() => {
            contentDiv.innerText = text.substring(0, idx);
            idx++;
            if(idx > text.length) clearInterval(timer);
        }, 60);
    }

    // --- ANIMATION LOOP ---
    function animate() {
        requestAnimationFrame(animate);
        
        // Vẽ nền đen mờ nhẹ để tạo vệt đuôi pháo hoa (nhưng drone vẫn rõ)
        ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
        ctx.fillRect(0, 0, width, height);

        if(state === "IDLE") return;

        // 1. DRONE (Ưu tiên vẽ rõ nhất)
        drones.forEach(d => {
            // Bay chậm và êm (Easing)
            d.x += (d.tx - d.x) * DRONE_SPEED;
            d.y += (d.ty - d.y) * DRONE_SPEED;
            
            // Vẽ Drone sáng rực, không bị mờ bởi nền
            ctx.fillStyle = d.color;
            ctx.fillRect(d.x, d.y, DRONE_SIZE, DRONE_SIZE);
        });

        // 2. PHÁO HOA
        for(let i=fireworks.length-1; i>=0; i--) {
            let fw = fireworks[i];
            fw.y += fw.vy; fw.vy += 0.2;
            
            ctx.fillStyle = fw.color;
            ctx.fillRect(fw.x, fw.y, 3, 3);

            if(fw.vy >= 0 || fw.y <= fw.ty) {
                explode(fw);
                fireworks.splice(i, 1);
            }
        }

        // 3. HẠT NỔ
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy; p.vy += p.gravity;
            p.life -= 0.02;

            if(p.life <= 0) particles.splice(i, 1);
            else {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 2, 2);
                ctx.globalAlpha = 1;
            }
        }
    }
    
    animate();
</script>
</body>
</html>
