<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HPBD & HPNY - Audio Reactive V3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Dancing+Script:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Cinzel', serif; touch-action: none; }
        .galaxy-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); z-index: 0; }
        #stars { width: 1px; height: 1px; background: transparent; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: none; z-index: 100; }
        .btn { pointer-events: auto; background: rgba(255, 255, 255, 0.05); color: #d4af37; border: 1px solid rgba(212, 175, 55, 0.5); padding: 15px 40px; font-size: 18px; cursor: pointer; transition: all 0.5s; text-transform: uppercase; letter-spacing: 4px; border-radius: 30px; backdrop-filter: blur(4px); }
        .btn:hover { background: rgba(255, 215, 0, 0.2); transform: scale(1.05); color: #fff; border-color: #ffd700; }
        #letter-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #8B0000; color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 200; font-family: 'Arial', sans-serif; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 2s ease-in-out; }
        #letter-content { max-width: 600px; text-align: center; font-size: clamp(16px, 4vw, 24px); line-height: 1.6; }
        .typing-cursor { display: inline-block; width: 2px; height: 1em; background-color: white; animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        #letter-signature { margin-top: 30px; font-size: clamp(18px, 5vw, 22px); font-family: 'Dancing Script', cursive; opacity: 0; transition: opacity 1.5s; text-align: center; }
    </style>
</head>
<body>
    <div class="galaxy-bg"><div id="stars"></div></div>
    <canvas id="mainCanvas"></canvas>
    <div id="ui-layer">
        <button id="start-btn" class="btn">KHAI TI·ªÜC</button>
        <p style="color: #d4af37; margin-top: 10px; font-size: 10px;" id="status-text">Ch·∫°m ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫°c v√† ph√°o hoa</p>
    </div>
    <div id="letter-container">
        <div id="letter-content"></div>
        <div id="letter-signature"></div>
    </div>
    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" crossorigin="anonymous"></audio>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const music = document.getElementById('bg-music');
    let width, height, audioCtx, analyser, dataArray;
    let state = "IDLE", drones = [], fireworks = [], particles = [], globalHue = 0;
    let currentVol = 0;

    const isMobile = window.innerWidth < 768;
    const DRONE_SPEED = 0.025; // Ch·∫≠m v√† m∆∞·ª£t h∆°n
    const SCAN_STEP = isMobile ? 6 : 4;

    function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    // Kh·ªüi t·∫°o Audio Analyzer
    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaElementSource(music);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
    }

    document.getElementById('start-btn').onclick = function() {
        if (!audioCtx) initAudio();
        this.style.display = document.getElementById('status-text').style.display = 'none';
        music.play();
        state = "FIREWORKS";
        startDroneSequence();
    };

    function createFirework(x, y) {
        // K√≠ch th∆∞·ªõc n·ªï ph·ª• thu·ªôc v√†o c∆∞·ªùng ƒë·ªô √¢m thanh t·∫°i th·ªùi ƒëi·ªÉm b·∫Øn
        const power = (currentVol / 255) * 1.5 + 0.5;
        fireworks.push({
            x: x || Math.random() * width,
            y: height,
            ty: y || height * (0.1 + Math.random() * 0.3),
            color: `hsl(${Math.random() * 360}, 100%, 60%)`,
            exploded: false,
            speed: 4,
            power: power
        });
    }

    function explode(fw) {
        fw.exploded = true;
        // S·ªë l∆∞·ª£ng h·∫°t t·ªâ l·ªá v·ªõi √¢m l∆∞·ª£ng nh·∫°c
        const count = Math.floor(40 + (currentVol / 255) * 60);
        for(let i=0; i<count; i++) {
            const angle = (i/count) * Math.PI * 2;
            const speed = (Math.random() * 3 + 2) * fw.power;
            particles.push({
                x: fw.x, y: fw.y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                color: fw.color,
                life: 1.0,
                decay: 0.015
            });
        }
    }

    function startDroneSequence() {
        const sequence = [
            { t: 2000, txt: "WELCOME D∆Ø∆†NG", color: {h:48,s:100,l:60}, mode: 'shift' },
            { t: 10000, txt: "üéâCH√öC M·ª™NGüéä", color: {h:0,s:100,l:60}, mode: 'shift' },
            { t: 18000, txt: "üåüNƒÇM M·ªöI 2026üî•", color: {h:48,s:100,l:60}, mode: 'shift' },
            { t: 26000, txt: "üê¥B√çNH NG·ªåüê¥", color: {h:190,s:100,l:70}, mode: 'static' },
            { t: 34000, txt: "üíùHAPPY VALENTINEüåπ", color: {h:320,s:100,l:70}, mode: 'shift' },
            { t: 42000, txt: "üíêQU·ªêC T·∫æ PH·ª§ N·ªÆ 8/3üå∑", color: {h:0,s:100,l:60}, mode: 'rainbow' },
            { t: 50000, shp: "HEART", color: {h:350,s:100,l:60} },
            { t: 58000, txt: "üçÄHPBD TU·ªîI 19üê∑", color: {h:48,s:100,l:60} },
            { t: 66000, action: "startLetter" }
        ];

        sequence.forEach(s => {
            setTimeout(() => {
                if(s.txt) formText(s.txt, s.color, s.mode);
                if(s.shp) formShape(s.shp, s.color);
                if(s.action === "startLetter") startLetter();
            }, s.t);
        });
    }

    function formText(text, hsl, mode) {
        const offCv = document.createElement('canvas');
        const offCtx = offCv.getContext('2d');
        let fSize = isMobile ? 40 : 80;
        offCtx.font = `900 ${fSize}px "Cinzel"`;
        const m = offCtx.measureText(text);
        offCv.width = m.width + 40; offCv.height = fSize * 2;
        offCtx.font = `900 ${fSize}px "Cinzel"`;
        offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';
        offCtx.fillStyle = 'white';
        offCtx.fillText(text, offCv.width/2, offCv.height/2);

        const data = offCtx.getImageData(0,0, offCv.width, offCv.height).data;
        const pts = [];
        const scale = Math.min(width*0.9/offCv.width, height*0.6/offCv.height);
        for(let y=0; y<offCv.height; y+=SCAN_STEP) {
            for(let x=0; x<offCv.width; x+=SCAN_STEP) {
                if(data[(y*offCv.width + x)*4 + 3] > 128) {
                    pts.push({ x: (width - offCv.width*scale)/2 + x*scale, y: (height - offCv.height*scale)/2 + y*scale });
                }
            }
        }
        updateDrones(pts, hsl, mode);
    }

    function formShape(type, hsl) {
        const pts = [], cx = width/2, cy = height/2, size = Math.min(width, height)*0.4;
        for(let i=0; i<800; i++) {
            let t = (i/800)*Math.PI*2;
            let x = 16*Math.pow(Math.sin(t),3);
            let y = -(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t));
            pts.push({ x: cx + x*(size/30), y: cy + y*(size/30) });
        }
        updateDrones(pts, hsl, 'shift');
    }

    function updateDrones(pts, hsl, mode) {
        while(drones.length < pts.length) drones.push({ x: width/2, y: height+50, tx: width/2, ty: height, color: hsl, mode: mode });
        pts.forEach((p, i) => {
            drones[i].tx = p.x; drones[i].ty = p.y;
            drones[i].color = hsl; drones[i].mode = mode;
        });
        for(let i=pts.length; i<drones.length; i++) drones[i].ty = height + 500;
    }

    function startLetter() {
        state = "LETTER"; drones = [];
        const container = document.getElementById('letter-container');
        container.style.display = 'flex';
        setTimeout(() => {
            container.style.opacity = '1';
            typeLetter();
        }, 100);
    }

    function typeLetter() {
        const text = "D∆∞∆°ng ∆°i, h√¥m nay l√† ng√†y 01/03/2026, c·∫≠u c≈©ng tr√≤n 19 tu·ªïi. T·ªõ ch√∫c c·∫≠u ng√†y c√†ng xinh ƒë·∫πp, h·ªçc gi·ªèi, ƒë·∫°t ƒë∆∞·ª£c k·∫øt qu·∫£ cao trong h·ªçc t·∫≠p, s·ªõm ƒë·∫°t ƒë∆∞·ª£c nh·ªØng ∆∞·ªõc m∆° m√† c·∫≠u ƒë√£ t·ª´ng mong ∆∞·ªõc. T·ªõ c≈©ng xin l·ªói, th·ªùi gian v·ª´a qua ƒë√£ l√†m c·∫≠u ph·∫£i bu·ªìn, gi·∫≠n, ch√°n gh√©t t·ªõ. Th√¥i c≈©ng ƒë√£ qua nƒÉm m·ªõi t·ªõ mong r·∫±ng c·∫≠u c√≥ th·ªÉ kh√¥ng ƒë·ªÉ b·ª•ng ƒë·∫øn t√≠nh c√°ch \" tr·∫ª tr√¢u \" c·ªßa t·ªõ. T·ªõ c·∫£m ∆°n c·∫≠u!";
        let i = 0;
        const interval = setInterval(() => {
            document.getElementById('letter-content').innerHTML = text.substring(0, i) + '<span class="typing-cursor">|</span>';
            i++;
            if(i > text.length) {
                clearInterval(interval);
                document.getElementById('letter-signature').innerHTML = "Ng∆∞·ªùi g·ª≠i: NGUY·ªÑN B·∫ÆC S∆†N<br>Ng∆∞·ªùi nh·∫≠n: TR∆Ø∆†NG TH·ªä D∆Ø∆†NG";
                document.getElementById('letter-signature').style.opacity = '1';
            }
        }, 60);
    }

    function animate() {
        requestAnimationFrame(animate);
        if(state === "LETTER") return;

        // L·∫•y d·ªØ li·ªáu √¢m thanh
        if(analyser) {
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            currentVol = sum / dataArray.length; // ƒê·ªô l·ªõn trung b√¨nh
        }

        // Hi·ªáu ·ª©ng Motion Blur nh·∫π
        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.fillRect(0,0,width,height);

        ctx.globalCompositeOperation = 'lighter';
        
        // T·ª± ƒë·ªông b·∫Øn ph√°o hoa theo nh·ªãp bass (√¢m l∆∞·ª£ng cao)
        if(state === "FIREWORKS" && currentVol > 80 && Math.random() < 0.05) {
            createFirework();
        }

        fireworks.forEach((fw, i) => {
            fw.y -= fw.speed;
            ctx.fillStyle = fw.color;
            ctx.beginPath(); ctx.arc(fw.x, fw.y, 2, 0, Math.PI*2); ctx.fill();
            if(fw.y <= fw.ty) { explode(fw); fireworks.splice(i, 1); }
        });

        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.life -= p.decay;
            if(p.life <= 0) particles.splice(i, 1);
            else {
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                ctx.fillRect(p.x, p.y, 2, 2);
            }
        });

        drones.forEach(d => {
            // T·ªëc ƒë·ªô bay ch·∫≠m r√£i, m∆∞·ª£t m√†
            d.x += (d.tx - d.x) * DRONE_SPEED;
            d.y += (d.ty - d.y) * DRONE_SPEED;
            let h = d.color.h;
            if(d.mode === 'rainbow') h = (globalHue + d.x/2) % 360;
            ctx.fillStyle = `hsl(${h}, 100%, ${60 + (currentVol/10)}%)`;
            if(d.y < height + 100) ctx.fillRect(d.x, d.y, 2, 2);
        });

        globalHue += 1;
        ctx.globalAlpha = 1;
        ctx.globalCompositeOperation = 'source-over';
    }

    // T·∫°o sao n·ªÅn
    const sBox = document.getElementById('stars');
    let sCss = '';
    for(let i=0; i<150; i++) sCss += `${Math.random()*2000}px ${Math.random()*2000}px #FFF, `;
    sBox.style.boxShadow = sCss.slice(0,-2);

    animate();
</script>
</body>
</html>
