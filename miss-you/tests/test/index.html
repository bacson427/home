<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HPBD & HPNY (V21 Visualizer Edition)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Montserrat:wght@800&family=Dancing+Script:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Cinzel', serif; touch-action: none; }
        .galaxy-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); z-index: 0; }
        .stars { width: 1px; height: 1px; background: transparent; animation: animStar 100s linear infinite; }
        @keyframes animStar { from { transform: translateY(0px); } to { transform: translateY(-2000px); } }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: none; z-index: 100; }
        .btn { pointer-events: auto; background: rgba(255, 255, 255, 0.05); color: #d4af37; border: 1px solid rgba(212, 175, 55, 0.5); padding: 15px 40px; font-size: 18px; cursor: pointer; transition: all 0.5s; text-transform: uppercase; letter-spacing: 4px; font-family: 'Cinzel', serif; font-weight: 900; margin-top: 30px; border-radius: 30px; backdrop-filter: blur(4px); }
        .btn.ready { border-color: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); animation: pulse 3s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 50% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }
        .hint { font-family: 'Montserrat', sans-serif; font-size: 11px; color: rgba(255, 255, 255, 0.4); margin-top: 20px; letter-spacing: 2px; text-transform: uppercase; }
        #letter-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #8B0000; color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 200; font-family: 'Arial', sans-serif; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 2s ease-in-out; }
        #letter-content { max-width: 600px; text-align: center; font-size: clamp(16px, 4vw, 22px); line-height: 1.6; }
        .typing-cursor { display: inline-block; width: 2px; height: 1em; background-color: white; animation: blink 1s infinite; vertical-align: middle; margin-left: 2px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        #letter-signature { margin-top: 30px; font-size: clamp(18px, 5vw, 22px); font-family: 'Dancing Script', cursive; opacity: 0; transition: opacity 1.5s; text-align: center; }
    </style>
</head>
<body>
    <div class="galaxy-bg"><div id="stars" class="stars"></div></div>
    <canvas id="mainCanvas"></canvas>
    <div id="ui-layer">
        <button id="start-btn" class="btn ready">KHAI TI·ªÜC</button>
        <div id="hint-text" class="hint">B·∫•m ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√¨nh di·ªÖn √¢m thanh & √°nh s√°ng</div>
        <button id="next-phase-btn" class="btn ready" style="display:none">LET'S GO</button>
    </div>
    <div id="letter-container"><div id="letter-content"></div><div id="letter-signature"></div></div>
    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" crossorigin="anonymous" loop></audio>

    <script>
        const CONFIG = {
            NAME: "Tr∆∞∆°ng Th·ªã D∆∞∆°ng",
            BIRTHDAY: "01/03/2007",
            COLORS: { GOLD: { h: 48, s: 100, l: 60 }, RED: { h: 350, s: 100, l: 60 }, CYAN: { h: 190, s: 100, l: 70 }, WHITE: { h: 0, s: 0, l: 100 }, PINK: { h: 320, s: 100, l: 70 } }
        };

        const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d'), music = document.getElementById('bg-music');
        let width, height, audioCtx, analyser, dataArray, state = "IDLE", globalHue = 0;
        let fireworks = [], particles = [], drones = [], shockwaves = [];
        const isMobile = window.innerWidth < 768;

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        // Kh·ªüi t·∫°o Audio Analyzer
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(music);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        document.getElementById('start-btn').onclick = function() {
            initAudio();
            state = "FIREWORKS";
            this.style.display = document.getElementById('hint-text').style.display = 'none';
            music.play();
            launchFireworksPeriod(10000, () => {
                state = "WAITING_1";
                const nxt = document.getElementById('next-phase-btn');
                nxt.style.display = 'block';
                document.getElementById('hint-text').style.display = 'block';
                document.getElementById('hint-text').innerText = "B·∫•m ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c";
            });
        };

        document.getElementById('next-phase-btn').onclick = function() {
            if (state === "WAITING_1") {
                state = "COUNTDOWN";
                this.style.display = document.getElementById('hint-text').style.display = 'none';
                let cv = 10;
                let timer = setInterval(() => {
                    cv--;
                    if(cv > 0) shockwaves.push({ r: 0, alpha: 1, speed: 8, val: cv });
                    else { clearInterval(timer); startTransition(); }
                }, 1000);
            }
        };

        function startTransition() {
            state = "TRANSITION";
            setTimeout(() => { state = "DRONE"; startDroneSequence(); }, 3000);
        }

        function createFirework(x, y) {
            // L·∫•y d·ªØ li·ªáu √¢m thanh ƒë·ªÉ quy·∫øt ƒë·ªãnh ƒë·ªô cao v√† m√†u s·∫Øc
            let vol = 0;
            if (dataArray) {
                analyser.getByteFrequencyData(dataArray);
                vol = dataArray[10] / 255; // L·∫•y v√πng mid-bass
            }
            let colors = ['#FFD700', '#FF0055', '#00FFFF', '#FFFFFF', '#FF69B4'];
            fireworks.push({
                x: x || Math.random() * width, y: height,
                ty: y || height * (0.1 + Math.random() * 0.4),
                color: colors[Math.floor(Math.random() * colors.length)],
                exploded: false, speed: 4 + vol * 5
            });
        }

        function explode(fw) {
            fw.exploded = true;
            analyser.getByteFrequencyData(dataArray);
            let bass = dataArray[2] / 255; // L·∫•y l·ª±c bass ƒë·ªÉ t·∫°o ƒë·ªô l·ªõn v·ª• n·ªï
            let count = isMobile ? (30 + bass * 40) : (60 + bass * 100);
            for(let i=0; i<count; i++) {
                let angle = (i/count) * Math.PI * 2, speed = (Math.random() * 3 + 2) * (1 + bass);
                particles.push({ x: fw.x, y: fw.y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, color: fw.color, life: 1, decay: 0.015 + Math.random()*0.01, gravity: 0.06 });
            }
        }

        function startDroneSequence() {
            const seq = [
                { t: 0, txt: "üéâ CH√ÄO NƒÇM M·ªöI 2026 üéä", color: CONFIG.COLORS.GOLD },
                { t: 7000, txt: "üê¥ B√çNH NG·ªå AN KHANG üê¥", color: CONFIG.COLORS.RED },
                { t: 14000, txt: "üíù HAPPY VALENTINE üåπ", color: CONFIG.COLORS.PINK },
                { t: 21000, txt: "üíê QU·ªêC T·∫æ PH·ª§ N·ªÆ 8/3 üå∑", color: CONFIG.COLORS.CYAN },
                { t: 28000, shp: "HEART", color: CONFIG.COLORS.RED },
                { t: 35000, txt: "üçÄ HPBD TU·ªîI 19 - D∆Ø∆†NG üçÄ", color: CONFIG.COLORS.GOLD },
                { t: 43000, txt: "‚ù§Ô∏è SINH NH·∫¨T VUI V·∫∫ NH√â ‚ù§Ô∏è", color: CONFIG.COLORS.PINK, isEnd: true },
                { t: 52000, action: "letter" }
            ];
            seq.forEach(s => setTimeout(() => {
                if(s.txt) formText(s.txt, s.color);
                if(s.shp) formShape(s.shp, s.color);
                if(s.action === "letter") startLetter();
            }, s.t));
        }

        function updateDrones(points, hsl) {
            // T·ªëc ƒë·ªô 0.02 gi√∫p drone bay ch·∫≠m v√† m∆∞·ª£t h∆°n
            while(drones.length < points.length) drones.push({ x: width/2, y: height+50, tx: width/2, ty: height, speed: 0.02 + Math.random()*0.01, size: isMobile?3:2.5 });
            points.forEach((p, i) => { if(drones[i]) { drones[i].tx = p.x; drones[i].ty = p.y; drones[i].hsl = hsl; } });
            for(let i=points.length; i<drones.length; i++) drones[i].ty = height + 500;
        }

        function animate() {
            requestAnimationFrame(animate);
            if(state === "LETTER") return;
            ctx.clearRect(0, 0, width, height);
            if(dataArray) analyser.getByteFrequencyData(dataArray);

            // V·∫Ω ph√°o hoa & h·∫°t
            ctx.globalCompositeOperation = 'lighter';
            fireworks.forEach((fw, i) => {
                if(!fw.exploded) {
                    fw.y -= fw.speed;
                    ctx.fillStyle = fw.color; ctx.beginPath(); ctx.arc(fw.x, fw.y, 2, 0, 7); ctx.fill();
                    if(fw.y <= fw.ty) explode(fw);
                } else fireworks.splice(i, 1);
            });
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.life -= p.decay;
                if(p.life <= 0) particles.splice(i, 1);
                else { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, 2, 2); }
            });

            // V·∫Ω Drone (L∆∞·ªõt ch·∫≠m)
            if(state === "DRONE") {
                drones.forEach(d => {
                    d.x += (d.tx - d.x) * d.speed; d.y += (d.ty - d.y) * d.speed;
                    ctx.fillStyle = `hsl(${d.hsl.h}, ${d.hsl.s}%, ${d.hsl.l}%)`;
                    if(d.y < height + 100) ctx.fillRect(d.x, d.y, d.size, d.size);
                });
            }

            // V·∫Ω Transition Text (C√¢n ƒë·ªëi m√†n h√¨nh)
            if(state === "TRANSITION") {
                ctx.save();
                ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
                ctx.font = `900 ${Math.min(width*0.08, 60)}px Cinzel`;
                ctx.shadowBlur = 15; ctx.shadowColor = 'gold';
                ctx.fillText("WELCOME D∆Ø∆†NG", width/2, height/2);
                ctx.restore();
            }

            // V·∫Ω Countdown
            shockwaves.forEach((s, i) => {
                s.r += s.speed; s.alpha -= 0.015;
                if(s.alpha <= 0) shockwaves.splice(i, 1);
                else {
                    ctx.strokeStyle = `rgba(255,215,0,${s.alpha})`; ctx.beginPath(); ctx.arc(width/2, height/2, s.r, 0, 7); ctx.stroke();
                    ctx.fillStyle = `rgba(255,255,255,${s.alpha})`; ctx.font = '900 80px Cinzel'; ctx.textAlign='center'; ctx.fillText(s.val, width/2, height/2+30);
                }
            });
            ctx.globalAlpha = 1; ctx.globalCompositeOperation = 'source-over';
        }

        // C√°c h√†m ph·ª• tr·ª£ v·∫Ω text/shape gi·ªØ nguy√™n logic t·ªëi ∆∞u
        function formText(text, hsl) {
            const tempCv = document.createElement('canvas'), tempCtx = tempCv.getContext('2d');
            let fSize = isMobile ? 40 : 70;
            tempCtx.font = `900 ${fSize}px Cinzel`;
            const m = tempCtx.measureText(text);
            tempCv.width = m.width + 50; tempCv.height = fSize * 2;
            tempCtx.font = `900 ${fSize}px Cinzel`; tempCtx.textAlign = 'center'; tempCtx.textBaseline = 'middle';
            tempCtx.fillStyle = 'white'; tempCtx.fillText(text, tempCv.width/2, tempCv.height/2);
            const data = tempCtx.getImageData(0,0, tempCv.width, tempCv.height).data;
            let pts = [], step = isMobile ? 5 : 4;
            for(let y=0; y<tempCv.height; y+=step) {
                for(let x=0; x<tempCv.width; x+=step) {
                    if(data[(y*tempCv.width+x)*4+3] > 128) pts.push({ x: (width-tempCv.width)/2 + x, y: (height-tempCv.height)/2 + y });
                }
            }
            updateDrones(pts, hsl);
        }

        function formShape(type, hsl) {
            let pts = [], count = isMobile?600:1200, size = Math.min(width, height)*0.03;
            for(let i=0; i<count; i++) {
                let t = (i/count)*Math.PI*2;
                let x = 16 * Math.pow(Math.sin(t), 3), y = -(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t));
                pts.push({ x: width/2 + x*size, y: height/2 + y*size });
            }
            updateDrones(pts, hsl);
        }

        function launchFireworksPeriod(ms, cb) {
            let start = Date.now();
            let inter = setInterval(() => {
                if(Date.now()-start > ms) { clearInterval(inter); cb(); }
                createFirework();
            }, 400);
        }

        function startLetter() {
            state = "LETTER";
            const container = document.getElementById('letter-container');
            container.style.display = 'flex';
            setTimeout(() => {
                container.style.opacity = '1';
                let idx = 0, txt = "D∆∞∆°ng ∆°i, h√¥m nay l√† ng√†y 01/03/2026, c·∫≠u tr√≤n 19 tu·ªïi. T·ªõ ch√∫c c·∫≠u ng√†y c√†ng xinh ƒë·∫πp, h·ªçc gi·ªèi, ƒë·∫°t ƒë∆∞·ª£c nh·ªØng ∆∞·ªõc m∆° m√† c·∫≠u mong ∆∞·ªõc. T·ªõ c≈©ng xin l·ªói v√¨ th·ªùi gian qua l√†m c·∫≠u bu·ªìn. Mong c·∫≠u ƒë·ª´ng ƒë·ªÉ b·ª•ng t√≠nh c√°ch 'tr·∫ª tr√¢u' c·ªßa t·ªõ nh√©. C·∫£m ∆°n c·∫≠u r·∫•t nhi·ªÅu!";
                let interval = setInterval(() => {
                    document.getElementById('letter-content').innerHTML = txt.substring(0, idx++) + "<span class='typing-cursor'></span>";
                    if(idx > txt.length) {
                        clearInterval(interval);
                        document.getElementById('letter-signature').innerHTML = "Ng∆∞·ªùi g·ª≠i: NGUY·ªÑN B·∫ÆC S∆†N<br>Ng∆∞·ªùi nh·∫≠n: TR∆Ø∆†NG TH·ªä D∆Ø∆†NG";
                        document.getElementById('letter-signature').style.opacity = '1';
                    }
                }, 70);
            }, 1000);
        }

        const sBox = document.getElementById('stars');
        let sCss = ''; for(let i=0; i<150; i++) sCss += `${Math.random()*2000}px ${Math.random()*2000}px #FFF, `;
        sBox.style.boxShadow = sCss.slice(0,-2);
        animate();
    </script>
</body>
</html>
