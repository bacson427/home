<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HPBD Tr∆∞∆°ng Th·ªã D∆∞∆°ng (V9 Matrix)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=VT323&family=Roboto+Mono:wght@500&display=swap');
        
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; }
        
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: none; z-index: 100;
        }

        .btn {
            pointer-events: auto; background: #0F0; color: #000; border: 2px solid #0F0;
            padding: 15px 40px; font-size: 20px; cursor: pointer; 
            font-family: 'VT323', monospace; text-transform: uppercase;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            transition: all 0.3s;
        }
        .btn:hover { background: #000; color: #0F0; }
        
        #loading-text { color: #0F0; font-family: 'VT323', monospace; font-size: 24px; margin-bottom: 20px; }

        /* M√†n t√¢m th∆∞ */
        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; 
            display: none; justify-content: center; align-items: center; 
            z-index: 200; opacity: 0; transition: opacity 2s ease;
            padding: 20px; box-sizing: border-box;
        }
        
        #letter-content { 
            color: #0F0; font-family: 'VT323', monospace;
            font-size: clamp(18px, 4vw, 22px); line-height: 1.6; text-align: justify;
            max-width: 650px; border: 1px solid #0F0; padding: 30px;
            background: #000; box-shadow: 0 0 30px rgba(0, 255, 0, 0.2);
        }
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="loading-text">SYSTEM INITIALIZING...</div>
        <button id="start-btn" class="btn" style="display:none">ACCESS SYSTEM</button>
    </div>

    <div id="letter-container">
        <div id="letter-content"></div>
    </div>

    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" loop crossorigin="anonymous"></audio>

<script>
    // --- K·ªäCH B·∫¢N CH√çNH (D√πng \n ƒë·ªÉ xu·ªëng d√≤ng) ---
    const SCRIPT = [
        { text: "G·ª¨I ƒê·∫æN\nTR∆Ø∆†NG TH·ªä D∆Ø∆†NG", color: "#FF0055" },
        { text: "CH√öC M·ª™NG\nNƒÇM M·ªöI 2026", color: "#FFD700" },
        { text: "XU√ÇN B√çNH NG·ªå\nTH√ÄNH C√îNG R·ª∞C R·ª† üê¥", color: "#00FFFF" }, // Th√™m √Ω cho ƒë·ªß 4-5 ch·ªØ
        { text: "HAPPY VALENTINE\n14/02 NG·ªåT NG√ÄO", color: "#FF69B4" },
        { text: "QU·ªêC T·∫æ PH·ª§ N·ªÆ\nXINH ƒê·∫∏P R·∫†NG NG·ªúI", color: "#FF0055" },
        { text: "HAPPY BIRTHDAY\nSINH NH·∫¨T VUI V·∫∫", color: "#FFD700" },
        { text: "CH√öC M·ª™NG\nTU·ªîI 19 R·ª∞C R·ª†", color: "#00FFFF" },
        { action: "LETTER" }
    ];

    const CONFIG = {
        SCENE_DURATION: 10000, // 10 gi√¢y m·ªói c·∫£nh
        COUNTDOWN_START: 10
    };

    const isMobile = window.innerWidth < 768;
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;

    // State Variables
    let state = "IDLE"; // IDLE, MATRIX, DRONE, LETTER
    let drones = [];
    let fireworks = [];
    let particles = [];
    
    // Matrix Variables
    let matrixColumns = [];
    let countdownVal = CONFIG.COUNTDOWN_START;
    let countdownTimer = null;

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        initMatrix();
    }
    window.addEventListener('resize', resize);

    // --- KH·ªûI T·∫†O ---
    window.onload = () => {
        resize();
        document.getElementById('loading-text').style.display = 'none';
        const btn = document.getElementById('start-btn');
        btn.style.display = 'block';
        
        btn.onclick = () => {
            btn.style.display = 'none';
            const audio = document.getElementById('bg-music');
            audio.play().catch(e => console.log("Audio blocked"));
            
            // B·∫ÆT ƒê·∫¶U GIAI ƒêO·∫†N 1: MATRIX COUNTDOWN
            startMatrixCountdown();
        };
    };

    // --- PHASE 1: MATRIX EFFECT ---
    function initMatrix() {
        matrixColumns = [];
        const fontSize = 16;
        const columns = width / fontSize;
        for(let i=0; i<columns; i++) {
            matrixColumns[i] = Math.floor(Math.random() * -50); // Start above screen
        }
    }

    function drawMatrix() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; // Fade effect
        ctx.fillRect(0, 0, width, height);
        
        ctx.fillStyle = '#0F0'; // Green text
        ctx.font = '16px monospace';
        
        for(let i=0; i<matrixColumns.length; i++) {
            const text = String.fromCharCode(0x30A0 + Math.random() * 96); // Random Katakana
            const x = i * 16;
            const y = matrixColumns[i] * 16;
            
            ctx.fillText(text, x, y);
            
            if(y > height && Math.random() > 0.975) {
                matrixColumns[i] = 0;
            }
            matrixColumns[i]++;
        }

        // V·∫Ω s·ªë ƒë·∫øm ng∆∞·ª£c to ·ªü gi·ªØa
        if(countdownVal >= 0) {
            ctx.save();
            ctx.shadowBlur = 20;
            ctx.shadowColor = "#0F0";
            ctx.fillStyle = "#FFF";
            ctx.font = "bold 150px 'VT323'";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(countdownVal, width/2, height/2);
            ctx.restore();
        }
    }

    function startMatrixCountdown() {
        state = "MATRIX";
        countdownTimer = setInterval(() => {
            countdownVal--;
            if(countdownVal < 0) {
                clearInterval(countdownTimer);
                // CHUY·ªÇN SANG GIAI ƒêO·∫†N 2: DRONE SHOW
                state = "DRONE";
                startDroneShow();
            }
        }, 1000);
    }

    // --- PHASE 2: DRONE SHOW ---
    let scriptIndex = 0;
    
    function startDroneShow() {
        // B·∫Øt ƒë·∫ßu b·∫Øn ph√°o hoa
        setInterval(() => {
            if(state === "DRONE") shootFirework();
        }, 600);
        
        nextScene();
    }

    function nextScene() {
        if(scriptIndex >= SCRIPT.length) return;
        
        let scene = SCRIPT[scriptIndex];
        scriptIndex++;

        if(scene.action === "LETTER") {
            setTimeout(showLetter, 2000);
            return;
        }

        formMultiLineText(scene.text, scene.color);

        setTimeout(nextScene, CONFIG.SCENE_DURATION);
    }

    function formMultiLineText(text, color) {
        // T√°ch d√≤ng b·∫±ng k√Ω t·ª± \n
        const lines = text.split('\n');
        const offCv = document.createElement('canvas');
        const offCtx = offCv.getContext('2d');
        
        // Font size v·ª´a ph·∫£i ƒë·ªÉ 2 d√≤ng kh√¥ng b·ªã tr√†n
        let fontSize = isMobile ? 60 : 100;
        let lineHeight = fontSize * 1.2;
        
        // T√≠nh to√°n k√≠ch th∆∞·ªõc canvas t·∫°m
        offCtx.font = `900 ${fontSize}px "Montserrat"`;
        let maxWidth = 0;
        lines.forEach(line => {
            let m = offCtx.measureText(line);
            if(m.width > maxWidth) maxWidth = m.width;
        });

        offCv.width = maxWidth + 40;
        offCv.height = (lines.length * lineHeight) + 40;

        // V·∫Ω t·ª´ng d√≤ng l√™n canvas t·∫°m
        offCtx.fillStyle = '#fff';
        offCtx.font = `900 ${fontSize}px "Montserrat"`;
        offCtx.textAlign = 'center';
        offCtx.textBaseline = 'middle';
        
        let startY = (offCv.height - ((lines.length-1) * lineHeight)) / 2;
        
        lines.forEach((line, i) => {
            offCtx.fillText(line, offCv.width/2, startY + (i * lineHeight));
        });

        processDronePoints(offCv, color);
    }

    function processDronePoints(offCv, color) {
        let points = [];
        let data = offCv.getContext('2d').getImageData(0,0, offCv.width, offCv.height).data;
        
        // Scale ƒë·ªÉ v·ª´a m√†n h√¨nh (gi·ªØ l·ªÅ)
        let maxW = width * 0.9;
        let scale = Math.min(maxW / offCv.width, (height * 0.7) / offCv.height);
        
        let startX = (width - offCv.width * scale) / 2;
        let startY = (height - offCv.height * scale) / 2;

        let step = isMobile ? 4 : 3; // M·∫≠t ƒë·ªô ƒëi·ªÉm ·∫£nh

        for(let y=0; y<offCv.height; y+=step) {
            for(let x=0; x<offCv.width; x+=step) {
                if(data[(y*offCv.width + x)*4 + 3] > 128) {
                    points.push({
                        x: startX + x * scale,
                        y: startY + y * scale
                    });
                }
            }
        }
        updateDrones(points, color);
    }

    function updateDrones(points, color) {
        // Shuffle points
        points.sort(() => Math.random() - 0.5);

        if(drones.length < points.length) {
            let add = points.length - drones.length;
            for(let i=0; i<add; i++) {
                drones.push({
                    x: Math.random() * width, y: height + 50,
                    tx: width/2, ty: height/2,
                    color: color,
                    size: isMobile ? 2.5 : 2
                });
            }
        }

        drones.forEach((d, i) => {
            if(i < points.length) {
                d.tx = points[i].x;
                d.ty = points[i].y;
                d.color = color;
            } else {
                // Drone th·ª´a bay ra ngo√†i (Scattering effect)
                d.tx = Math.random() * width;
                d.ty = Math.random() * height;
                d.color = "rgba(255,255,255,0)";
            }
        });
    }

    // --- PH√ÅO HOA ---
    function shootFirework() {
        let x = Math.random() * width;
        let ty = Math.random() * height * 0.5;
        let colors = ['#F00', '#0F0', '#00F', '#FF0', '#0FF', '#F0F'];
        fireworks.push({
            x: x, y: height, tx: x, ty: ty,
            vx: 0, vy: -12 - Math.random()*5,
            color: colors[Math.floor(Math.random()*colors.length)],
            state: "RISE"
        });
    }

    function explode(fw) {
        let count = 30;
        for(let i=0; i<count; i++) {
            let a = Math.random() * Math.PI * 2;
            let s = Math.random() * 4 + 1;
            particles.push({
                x: fw.x, y: fw.y, vx: Math.cos(a)*s, vy: Math.sin(a)*s,
                color: fw.color, life: 1, gravity: 0.1
            });
        }
    }

    // --- T√ÇM TH∆Ø ---
    function showLetter() {
        state = "LETTER";
        const div = document.getElementById('letter-container');
        const content = document.getElementById('letter-content');
        div.style.display = 'flex';
        setTimeout(() => div.style.opacity = 1, 100);

        let text = "G·ª¨I T·ªöI: TR∆Ø∆†NG TH·ªä D∆Ø∆†NG\n\nNƒÉm m·ªõi 2026, ch√∫c c·∫≠u lu√¥n r·∫°ng r·ª°, xinh ƒë·∫πp v√† ƒë·∫°t ƒë∆∞·ª£c m·ªçi ƒëi·ªÅu ∆∞·ªõc. C·∫£m ∆°n v√¨ ƒë√£ xu·∫•t hi·ªán trong cu·ªôc s·ªëng c·ªßa t·ªõ. Nh·ªØng l√∫c t·ªõ \"tr·∫ª tr√¢u\", c·∫£m ∆°n c·∫≠u ƒë√£ bao dung. Ch√∫c m·ª´ng sinh nh·∫≠t tu·ªïi 19 th·∫≠t √Ω nghƒ©a!\n\nK√Ω t√™n: Nguy·ªÖn B·∫Øc S∆°n";
        
        let idx = 0;
        let timer = setInterval(() => {
            content.innerText = text.substring(0, idx) + "_";
            idx++;
            if(idx > text.length) clearInterval(timer);
        }, 50);
    }

    // --- RENDER LOOP ---
    function animate() {
        requestAnimationFrame(animate);

        if(state === "MATRIX") {
            drawMatrix();
            return;
        }

        // X√≥a n·ªÅn cho Drone Show (C√≥ ƒëu√¥i m·ªù)
        if(state === "DRONE" || state === "LETTER") {
            ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
            ctx.fillRect(0, 0, width, height);
        }

        // 1. DRONE
        if(state === "DRONE") {
            drones.forEach(d => {
                d.x += (d.tx - d.x) * 0.08;
                d.y += (d.ty - d.y) * 0.08;
                ctx.fillStyle = d.color;
                ctx.fillRect(d.x, d.y, d.size, d.size);
            });
        }

        // 2. PH√ÅO HOA
        for(let i=fireworks.length-1; i>=0; i--) {
            let fw = fireworks[i];
            fw.y += fw.vy; fw.vy += 0.2;
            ctx.fillStyle = fw.color; ctx.fillRect(fw.x, fw.y, 3, 3);
            if(fw.vy >= 0) { explode(fw); fireworks.splice(i, 1); }
        }

        // 3. H·∫†T
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.life -= 0.02;
            if(p.life <= 0) particles.splice(i, 1);
            else {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 2, 2); ctx.globalAlpha = 1;
            }
        }
    }
    
    animate();
</script>
</body>
</html>
