<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday Tr∆∞∆°ng Th·ªã D∆∞∆°ng</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Montserrat:wght@800&family=Dancing+Script:wght@700&display=swap');
        
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Cinzel', serif; touch-action: none; }
        
        .galaxy-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); z-index: 0;
        }
        .stars { width: 1px; height: 1px; background: transparent; animation: animStar 100s linear infinite; }
        @keyframes animStar { from { transform: translateY(0px); } to { transform: translateY(-2000px); } }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: none; z-index: 100;
        }

        .btn {
            pointer-events: auto; background: rgba(255, 255, 255, 0.05);
            color: #d4af37; border: 1px solid rgba(212, 175, 55, 0.5);
            padding: 15px 40px; font-size: 18px; cursor: wait; transition: all 0.5s;
            text-transform: uppercase; letter-spacing: 4px; font-family: 'Cinzel', serif;
            font-weight: 900; margin-top: 30px; border-radius: 30px; backdrop-filter: blur(4px); opacity: 0.5;
        }
        .btn.ready { cursor: pointer; opacity: 1; border-color: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); animation: pulse 3s infinite; }
        .btn.ready:hover { background: rgba(255, 215, 0, 0.2); transform: scale(1.05); color: #fff; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 50% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }

        .hint { font-family: 'Montserrat', sans-serif; font-size: 11px; color: rgba(255, 255, 255, 0.4); margin-top: 20px; letter-spacing: 2px; text-transform: uppercase; text-align: center; line-height: 1.5; }
        #loading-text { margin-top: 15px; font-size: 12px; color: #d4af37; font-family: 'Montserrat', sans-serif; }

        /* M√†n t√¢m t∆∞ */
        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 10, 15, 0.95); color: white; display: none;
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 200; font-family: 'Arial', sans-serif; padding: 20px; box-sizing: border-box;
            opacity: 0; transition: opacity 2s ease-in-out;
        }
        #letter-content { max-width: 600px; text-align: center; font-size: clamp(16px, 4vw, 24px); line-height: 1.8; opacity: 1; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .typing-cursor { display: inline-block; width: 2px; height: 1em; background-color: #ffd700; animation: blink 1s infinite; vertical-align: middle; margin-left: 2px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        #letter-signature { margin-top: 40px; font-size: clamp(20px, 5vw, 26px); font-family: 'Dancing Script', cursive; color: #ffd700; opacity: 0; transition: opacity 1.5s; text-align: center; }
    </style>
</head>
<body>
    <div class="galaxy-bg"><div id="stars" class="stars"></div></div>
    <canvas id="mainCanvas"></canvas>
    
    <div id="ui-layer">
        <button id="start-btn" class="btn">ƒêANG T·∫¢I...</button>
        <div id="loading-text">VUI L√íNG ƒê·ª¢I...</div>
        <div id="hint-text" class="hint" style="display:none">ƒêeo tai nghe ƒë·ªÉ c√≥ tr·∫£i nghi·ªám t·ªët nh·∫•t<br>B·∫•m n√∫t b√™n tr√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
        <button id="next-phase-btn" class="btn ready" style="display:none">TI·∫æP T·ª§C</button>
    </div>

    <div id="letter-container">
        <div id="letter-content"></div>
        <div id="letter-signature"></div>
    </div>

    <audio id="bg-music" src="https://nguyenbacson.io.vn/miss-you-happy-birthday.mp3" crossorigin="anonymous" loop></audio>

<script>
    const CONFIG = {
        NAME: "Tr∆∞∆°ng Th·ªã D∆∞∆°ng",
        DATE: "01/03/2026",
        COLORS: {
            GOLD: { h: 48, s: 100, l: 60 },
            RED: { h: 350, s: 100, l: 60 },
            CYAN: { h: 190, s: 100, l: 70 },
            WHITE: { h: 0, s: 0, l: 100 },
            PINK: { h: 320, s: 100, l: 70 },
            BLUE: { h: 240, s: 100, l: 65 }
        }
    };

    const isMobile = window.innerWidth < 768;
    const PARTICLE_SIZE = isMobile ? 2.5 : 2;
    // Gi·∫£m t·ªëc ƒë·ªô drone ƒë·ªÉ m∆∞·ª£t h∆°n
    const DRONE_SPEED = 0.03; 
    const SCAN_STEP = isMobile ? 6 : 4; 

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { alpha: true });
    const music = document.getElementById('bg-music');
    let width, height;

    // Audio Context Variables
    let audioCtx, analyser, dataArray;
    let isAudioSetup = false;

    // Letter Elements
    const letterContainer = document.getElementById('letter-container');
    const letterContent = document.getElementById('letter-content');
    const letterSignature = document.getElementById('letter-signature');
    let letterText = "D∆∞∆°ng ∆°i, h√¥m nay l√† ng√†y 01/03/2026, c·∫≠u c≈©ng tr√≤n 19 tu·ªïi. T·ªõ ch√∫c c·∫≠u ng√†y c√†ng xinh ƒë·∫πp, h·ªçc gi·ªèi, ƒë·∫°t ƒë∆∞·ª£c k·∫øt qu·∫£ cao trong h·ªçc t·∫≠p, s·ªõm ƒë·∫°t ƒë∆∞·ª£c nh·ªØng ∆∞·ªõc m∆° m√† c·∫≠u ƒë√£ t·ª´ng mong ∆∞·ªõc. T·ªõ c≈©ng xin l·ªói, th·ªùi gian v·ª´a qua ƒë√£ l√†m c·∫≠u ph·∫£i bu·ªìn, gi·∫≠n, ch√°n gh√©t t·ªõ. Th√¥i c≈©ng ƒë√£ qua nƒÉm m·ªõi t·ªõ mong r·∫±ng c·∫≠u c√≥ th·ªÉ kh√¥ng ƒë·ªÉ b·ª•ng ƒë·∫øn t√≠nh c√°ch \"tr·∫ª tr√¢u\" c·ªßa t·ªõ. T·ªõ c·∫£m ∆°n c·∫≠u!";
    let letterIndex = 0;
    
    // Core Variables
    let state = "IDLE"; 
    let fireworks = [], particles = [], drones = [];
    let globalHue = 0;
    let countdownVal = 10;
    let transitionAlpha = 0;
    let shockwaves = [];
    let countdownTimer = null;

    const startBtn = document.getElementById('start-btn');
    const nextBtn = document.getElementById('next-phase-btn');
    const hintText = document.getElementById('hint-text');

    function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    document.fonts.ready.then(() => {
        startBtn.innerText = "KHAI TI·ªÜC"; startBtn.classList.add('ready');
        document.getElementById('loading-text').style.display = 'none';
        hintText.style.display = 'block';
        startBtn.onclick = triggerAction;
    });

    function setupAudio() {
        if (isAudioSetup) return;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaElementSource(music);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 64; // L·∫•y m·∫´u th·∫•p ƒë·ªÉ b·∫Øt Bass
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            isAudioSetup = true;
        } catch (e) {
            console.log("Audio API Error (likely CORS):", e);
        }
    }

    function getBassScale() {
        if (!isAudioSetup) return 1;
        analyser.getByteFrequencyData(dataArray);
        // L·∫•y trung b√¨nh c√°c t·∫ßn s·ªë th·∫•p (Bass)
        let sum = 0;
        for(let i=0; i<5; i++) sum += dataArray[i];
        let avg = sum / 5;
        // Map t·ª´ 0-255 sang 0.8-2.5
        return 0.8 + (avg / 255) * 2.0; 
    }

    function triggerAction() {
        if (state === "IDLE") {
            setupAudio();
            music.play().then(() => {
                state = "FIREWORKS";
                startBtn.style.display = hintText.style.display = 'none';
                launchFireworksPeriod(8000, () => { 
                    state = "WAITING_1"; 
                    nextBtn.style.display = hintText.style.display = 'block'; 
                    hintText.innerText = "S·∫µn s√†ng ƒë·∫øm ng∆∞·ª£c ch∆∞a?";
                    nextBtn.innerText = "B·∫ÆT ƒê·∫¶U ƒê·∫æM";
                });
            }).catch(e => {
                alert("Vui l√≤ng ch·∫°m v√†o m√†n h√¨nh ƒë·ªÉ ph√°t nh·∫°c!");
            });
        } else if (state === "WAITING_1") {
            state = "COUNTDOWN";
            nextBtn.style.display = hintText.style.display = 'none';
            countdownVal = 10;
            resetCinematicNumber(); 
            countdownTimer = setInterval(() => {
                countdownVal--;
                if (countdownVal > 0) { 
                    resetCinematicNumber();
                    if(countdownVal % 2 == 0) createShapedFirework();
                } else { 
                    clearInterval(countdownTimer); 
                    startTransitionSequence();
                }
            }, 1000);
        }
    }

    function startTransitionSequence() {
        state = "TRANSITION";
        // B·∫Øn ph√°o hoa d·ªìn d·∫≠p
        let barrage = setInterval(() => {
            createFirework(Math.random()*width, height*0.5);
        }, 100);
        setTimeout(() => { clearInterval(barrage); state = "DRONE"; startDroneSequence(); }, 3500);
    }

    function renderTransitionText() {
        if(transitionAlpha < 1) transitionAlpha += 0.02;
        ctx.save(); ctx.translate(width/2, height/2);
        let dynamicFontSize = Math.min(width * 0.1, 70);
        ctx.globalAlpha = transitionAlpha;
        ctx.font = `900 ${dynamicFontSize}px "Cinzel"`;
        ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
        ctx.shadowBlur = 20; ctx.shadowColor = '#FFD700';
        ctx.fillText("CH√ÄO ƒê√ìN", 0, -dynamicFontSize/2);
        ctx.fillText(CONFIG.NAME.split(' ').pop().toUpperCase(), 0, dynamicFontSize/1.5);
        ctx.restore();
    }

    function resetCinematicNumber() { shockwaves.push({ r: 0, alpha: 1, speed: 8 }); }

    function renderCinematicCountdown() {
        const cx = width / 2, cy = height / 2;
        for(let i = shockwaves.length - 1; i >= 0; i--) {
            let sw = shockwaves[i]; sw.r += sw.speed; sw.alpha -= 0.02;
            if(sw.alpha <= 0) shockwaves.splice(i, 1);
            else {
                ctx.beginPath(); ctx.arc(cx, cy, sw.r, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 215, 0, ${sw.alpha})`; ctx.stroke();
            }
        }
        if(countdownVal > 0) {
            ctx.save(); ctx.translate(cx, cy);
            ctx.font = '900 120px "Cinzel"'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillStyle = '#ffd700'; ctx.fillText(countdownVal, 0, 0);
            ctx.restore();
        }
    }

    function launchFireworksPeriod(duration, callback) {
        let start = Date.now();
        let interval = setInterval(() => {
            if(Date.now() - start > duration) { clearInterval(interval); if(callback) callback(); }
            createFirework();
        }, 400); // Th∆∞a h∆°n x√≠u ƒë·ªÉ ƒë·ª° lag
    }

    function createFirework(x, y, shape = 'NORMAL') {
        let colors = ['#FFD700', '#FF0055', '#00FFFF', '#FFFFFF', '#FF3300'];
        // T·ªëc ƒë·ªô b·∫Øn l√™n nhanh h∆°n x√≠u
        fireworks.push({ x: x || Math.random() * width, y: height, ty: y || height * 0.2 + Math.random() * (height * 0.3), color: colors[Math.floor(Math.random() * colors.length)], exploded: false, speed: 6, shape: shape });
    }

    function createShapedFirework(type) {
        let shapes = ['HEART', 'STAR'];
        let shape = type || shapes[Math.floor(Math.random()*shapes.length)];
        createFirework(width/2 + (Math.random()-0.5)*width*0.5, height*0.3, shape);
    }

    function explodeFirework(fw) {
        fw.exploded = true;
        // Audio reactivity: K√≠ch th∆∞·ªõc n·ªï ph·ª• thu·ªôc v√†o nh·∫°c
        let scale = getBassScale(); 
        let count = isMobile ? 30 : 50; 
        // N·∫øu bass m·∫°nh, n·ªï to h∆°n v√† nhi·ªÅu h·∫°t h∆°n
        if(scale > 1.5) count += 20;

        // X·ª≠ l√Ω h√¨nh d√°ng ph√°o hoa
        if(fw.shape === 'HEART') {
            for(let i=0; i<count*1.5; i++) {
                let t = (i/(count*1.5)) * Math.PI * 2;
                // Ph∆∞∆°ng tr√¨nh tr√°i tim
                let dx = 16 * Math.pow(Math.sin(t), 3);
                let dy = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                // Scale nh·ªè l·∫°i cho v·ª´a m√†n h√¨nh
                dx *= (scale * 0.15); dy *= (scale * 0.15);
                particles.push(createParticle(fw.x, fw.y, dx, dy, fw.color));
            }
        } else if (fw.shape === 'STAR') {
            for(let i=0; i<count*1.5; i++) {
                 let angle = (i / (count*1.5)) * Math.PI * 2;
                 let r = 2 * (2 + Math.sin(5 * angle)); // H√¨nh sao 5 c√°nh
                 let s = scale * 0.5; // T·ªëc ƒë·ªô
                 particles.push(createParticle(fw.x, fw.y, Math.cos(angle)*r*s, Math.sin(angle)*r*s, fw.color));
            }
        } else {
            // N·ªï tr√≤n th∆∞·ªùng
            for(let i=0; i<count; i++) {
                let angle = Math.random() * Math.PI * 2;
                let speed = (Math.random() * 3 + 1) * scale;
                particles.push(createParticle(fw.x, fw.y, Math.cos(angle)*speed, Math.sin(angle)*speed, fw.color));
            }
        }
    }

    function createParticle(x, y, vx, vy, color) {
        return { x: x, y: y, vx: vx, vy: vy, color: color, life: 1, decay: Math.random() * 0.015 + 0.01, gravity: 0.05 };
    }

    function startDroneSequence() {
        // Th·ªùi gian ƒë∆∞·ª£c k√©o d√†i ƒë·ªÉ drone bay ch·∫≠m (DRONE_SPEED nh·ªè)
        const sequence = [
            { t: 1000, txt: "CH√öC M·ª™NG", color: CONFIG.COLORS.RED, mode: 'shift' },
            { t: 8000, txt: "NƒÇM M·ªöI 2026", color: CONFIG.COLORS.GOLD, mode: 'shift' },
            { t: 16000, txt: "XU√ÇN B√çNH NG·ªå", color: CONFIG.COLORS.CYAN, mode: 'static' },
            
            { t: 24000, txt: "HAPPY VALENTINE", color: CONFIG.COLORS.PINK, mode: 'shift' },
            { t: 32000, txt: "QU·ªêC T·∫æ PH·ª§ N·ªÆ 8/3", color: CONFIG.COLORS.RED, mode: 'rainbow' },
                
            { t: 40000, txt: "SINH NH·∫¨T VUI V·∫∫", color: CONFIG.COLORS.GOLD, mode: 'shift' },
            { t: 48000, txt: "TU·ªîI 19 R·ª∞C R·ª†", color: CONFIG.COLORS.BLUE, mode: 'shift' },
            { t: 56000, txt: CONFIG.NAME.toUpperCase(), color: CONFIG.COLORS.PINK, font: 'Dancing Script', mode: 'rainbow' },
            
            // M√†n ƒë·∫∑c bi·ªát: B√°nh sinh nh·∫≠t + Tr√°i tim c√πng l√∫c
            { t: 64000, shp: "CAKE_HEART", color: CONFIG.COLORS.GOLD, mode: 'rainbow' },
            { t: 75000, action: "startLetter" }
        ];

        sequence.forEach(s => {
            setTimeout(() => {
                if(s.txt) formText(s.txt, s.color, s.font || 'Cinzel', s.mode);
                if(s.shp) formShape(s.shp, s.color, s.mode);
                if(s.action === "startLetter") startLetterSequence();
                
                // M·ªói khi ƒë·ªïi h√¨nh drone, b·∫Øn th√™m ph√°o hoa h√¨nh th√π
                if(state === "DRONE" && !s.action) createShapedFirework();
            }, s.t);
        });
    }

    function startLetterSequence() {
        state = "LETTER";
        drones = []; fireworks = []; particles = [];
        letterContainer.style.display = 'flex';
        setTimeout(() => {
            letterContainer.style.opacity = '1';
            setTimeout(startTyping, 1000);
        }, 100);
    }

    function startTyping() {
        let index = 0;
        letterContent.innerHTML = '';
        let interval = setInterval(() => {
            if (index < letterText.length) {
                letterContent.innerHTML = letterText.substring(0, index + 1) + '<span class="typing-cursor"></span>';
                index++;
            } else {
                clearInterval(interval);
                letterContent.innerHTML = letterText; // X√≥a cursor
                setTimeout(() => {
                    letterSignature.innerHTML = `Ng∆∞·ªùi g·ª≠i: Nguy·ªÖn B·∫Øc S∆°n<br>G·ª≠i ƒë·∫øn: ${CONFIG.NAME}<br>‚ù§Ô∏è`;
                    letterSignature.style.opacity = '1';
                }, 1000);
            }
        }, 50);
    }

    function formText(text, hslColor, fontName, mode) {
        const offCv = document.createElement('canvas');
        const offCtx = offCv.getContext('2d');
        
        // T·ª± ƒë·ªông t√≠nh font size ƒë·ªÉ kh√¥ng b·ªã tr√†n m√†n h√¨nh
        let idealFontSize = Math.min(150, (width * 0.95) / (text.length * 0.7)); 
        if(isMobile) idealFontSize = Math.min(80, (width * 0.95) / (text.length * 0.6));

        offCtx.font = `900 ${idealFontSize}px "${fontName}"`;
        const measure = offCtx.measureText(text);
        offCv.width = measure.width + 50; offCv.height = idealFontSize * 2;
        
        offCtx.font = `900 ${idealFontSize}px "${fontName}"`;
        offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';
        offCtx.fillStyle = '#fff';
        offCtx.fillText(text, offCv.width/2, offCv.height/2);

        processCanvasToDrones(offCv, hslColor, mode);
    }

    function formShape(type, hslColor, mode) {
        if (type === "CAKE_HEART") {
            // V·∫Ω l√™n canvas ·∫©n ƒë·ªÉ l·∫•y ƒëi·ªÉm ·∫£nh cho d·ªÖ (Thay v√¨ d√πng c√¥ng th·ª©c to√°n ph·ª©c t·∫°p)
            const offCv = document.createElement('canvas');
            const offCtx = offCv.getContext('2d');
            let s = Math.min(width, height) * (isMobile ? 0.8 : 0.6); // K√≠ch th∆∞·ªõc t·ªïng
            offCv.width = s; offCv.height = s/1.5;
            
            offCtx.fillStyle = '#fff';
            offCtx.textAlign = 'center'; offCtx.textBaseline = 'middle';
            
            // V·∫Ω B√°nh b√™n tr√°i (d·∫°ng text emoji ho·∫∑c v·∫Ω h√¨nh kh·ªëi ƒë∆°n gi·∫£n)
            // D√πng font c·ª±c l·ªõn ƒë·ªÉ v·∫Ω üéÇ v√† ‚ù§Ô∏è
            let iconSize = s/2.5;
            offCtx.font = `${iconSize}px Arial`;
            offCtx.fillText("üéÇ", s*0.25, s/3);
            offCtx.fillText("‚ù§Ô∏è", s*0.75, s/3);
            
            processCanvasToDrones(offCv, hslColor, mode);
            return;
        }

         
        // C√°c h√¨nh h·ªçc to√°n h·ªçc c≈© (gi·ªØ nguy√™n n·∫øu c·∫ßn d√πng l·∫°i tim ƒë∆°n l·∫ª)
        let points = [], cx = width/2, cy = height/2, size = Math.min(width, height) * 0.4;
        let count = isMobile ? 600 : 1200;
        for (let i = 0; i < count; i++) {
            let t = (i / count) * Math.PI * 2;
            // H√¨nh tr√°i tim m·∫∑c ƒë·ªãnh
            let x = 16 * Math.pow(Math.sin(t), 3);
            let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
            points.push({ x: cx + x * (size/30), y: cy + y * (size/30) });
        }
        updateDrones(points, hslColor, mode);
    }

    function processCanvasToDrones(offCv, hslColor, mode) {
        const scale = Math.min(width * 0.95 / offCv.width, height * 0.7 / offCv.height);
        const data = offCv.getContext('2d').getImageData(0,0, offCv.width, offCv.height).data;
        let points = [];
        
        // Qu√©t pixel
        for(let y=0; y<offCv.height; y+=SCAN_STEP) {
            for(let x=0; x<offCv.width; x+=SCAN_STEP) {
                if(data[(y*offCv.width + x)*4 + 3] > 128) {
                    points.push({ 
                        x: (width - offCv.width * scale)/2 + x * scale, 
                        y: (height - offCv.height * scale)/2 + y * scale 
                    });
                }
            }
        }
        updateDrones(points, hslColor, mode);
    }

    function updateDrones(points, hslColor, mode) {
        // N·∫øu thi·∫øu drone th√¨ th√™m v√†o
        while(drones.length < points.length) {
            drones.push({ 
                x: width/2 + (Math.random()-0.5)*100, 
                y: height + 100, 
                tx: width/2, ty: height, 
                speed: DRONE_SPEED, // Speed ch·∫≠m
                size: PARTICLE_SIZE 
            });
        }
        
        // G√°n m·ª•c ti√™u bay
        points.forEach((p, i) => {
            if(drones[i]) {
                drones[i].tx = p.x; drones[i].ty = p.y;
                drones[i].baseHsl = hslColor; drones[i].colorMode = mode;
                // Random nh·∫π t·ªëc ƒë·ªô ƒë·ªÉ kh√¥ng bay ƒë·ªÅu tƒÉm t·∫Øp
                drones[i].speed = DRONE_SPEED + Math.random() * 0.01; 
            }
        });

        // Drone th·ª´a th√¨ bay ƒëi ch·ªó kh√°c
        for(let i = points.length; i < drones.length; i++) {
            drones[i].tx = Math.random() * width;
            drones[i].ty = height + 500;
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        if (state === "LETTER") return;

        ctx.fillStyle = "rgba(0, 0, 0, 0.2)"; // T·∫°o ƒëu√¥i m·ªù (motion trail)
        ctx.fillRect(0, 0, width, height); 
        globalHue += 0.5;

        // Visualizer n·ªÅn n·∫øu ƒëang c√≥ nh·∫°c v√† ·ªü m√†n h√¨nh Drone
        if(state === "DRONE" && isAudioSetup) {
             // C√≥ th·ªÉ v·∫Ω th√™m s√≥ng nh·∫°c n·ªÅn ·ªü ƒë√¢y n·∫øu th√≠ch
        }

        if (state === "COUNTDOWN") renderCinematicCountdown();
        if (state === "TRANSITION") renderTransitionText();

        ctx.globalCompositeOperation = 'lighter';
        
        // X·ª≠ l√Ω Ph√°o hoa
        fireworks.forEach((fw, i) => {
            if (!fw.exploded) {
                fw.y -= fw.speed;
                ctx.fillStyle = fw.color; ctx.beginPath(); ctx.arc(fw.x, fw.y, 2, 0, Math.PI*2); ctx.fill();
                if (fw.y <= fw.ty) explodeFirework(fw);
            } else fireworks.splice(i, 1);
        });

        // X·ª≠ l√Ω H·∫°t n·ªï
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.life -= p.decay;
            if (p.life <= 0) particles.splice(i, 1);
            else { 
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life; 
                ctx.beginPath(); ctx.arc(p.x, p.y, 1.5, 0, Math.PI*2); ctx.fill();
            }
        });

        // X·ª≠ l√Ω Drone
        if (state === "DRONE") {
            // Audio reactive cho drone: Rung nh·∫π theo nh·∫°c
            let shake = (isAudioSetup && getBassScale() > 1.2) ? 2 : 0;

            drones.forEach(d => {
                // Easing function (bay t·ª´ t·ª´)
                d.x += (d.tx - d.x) * d.speed; 
                d.y += (d.ty - d.y) * d.speed;

                let h = d.baseHsl?.h || 0;
                if (d.colorMode === 'rainbow') h = (d.x / width * 360 + globalHue) % 360;
                if (d.colorMode === 'shift') h = (h + globalHue) % 360;
                
                ctx.fillStyle = `hsl(${h}, 100%, 60%)`;
                
                // V·∫Ω drone (c√≥ rung n·∫øu bass m·∫°nh)
                let drawX = d.x + (Math.random()-0.5)*shake;
                let drawY = d.y + (Math.random()-0.5)*shake;
                
                ctx.fillRect(drawX, drawY, d.size, d.size);
            });
        }

        ctx.globalAlpha = 1;
        ctx.globalCompositeOperation = 'source-over';
    }

    // T·∫°o sao n·ªÅn
    const starBox = document.getElementById('stars');
    let starsCss = '';
    for(let i=0; i<200; i++) starsCss += `${Math.random()*2000}px ${Math.random()*2000}px #FFF, `;
    starBox.style.boxShadow = starsCss.slice(0, -2);

    nextBtn.onclick = triggerAction;
    animate();
</script>
</body>
</html>