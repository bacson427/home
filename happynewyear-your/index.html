<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pháo Hoa Tặng Trương Thị Dương</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        canvas {
            display: block;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s;
        }
    </style>
</head>
<body>

<audio id="boomSound" src="boom.mp3" preload="auto"></audio>

<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const boomSound = document.getElementById('boomSound');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let fireworks = [];
    let particles = [];
    
    // Cấu hình
    const GRAVITY = 0.04;
    const FRICTION = 0.96; // Độ bay xa của hạt (càng nhỏ càng gần)
    
    // Hàm phát âm thanh (Clone node để có thể phát chồng tiếng lên nhau)
    function playSound() {
        if(boomSound) {
            const sound = boomSound.cloneNode();
            sound.volume = 0.3; // Chỉnh âm lượng vừa phải
            sound.play().catch(e => {}); // Bắt lỗi nếu trình duyệt chặn auto-play
        }
    }

    // Class tạo viên pháo bay lên
    class Firework {
        constructor(x, y, targetX, targetY, type, text = "") {
            this.x = x;
            this.y = y;
            this.targetX = targetX;
            this.targetY = targetY;
            this.type = type; // 'normal' hoặc 'text'
            this.text = text;
            this.distanceToTarget = Math.sqrt(Math.pow(targetX - x, 2) + Math.pow(targetY - y, 2));
            this.distanceTraveled = 0;
            this.coordinates = [];
            this.coordinateCount = 3;
            
            // Tính góc và tốc độ
            const angle = Math.atan2(targetY - y, targetX - x);
            this.speed = 12; // Tốc độ bay lên
            this.vx = Math.cos(angle) * this.speed;
            this.vy = Math.sin(angle) * this.speed;
            this.brightness = Math.random() * 50 + 50;
        }

        update(index) {
            this.coordinates.pop();
            this.coordinates.unshift([this.x, this.y]);

            this.vx *= 0.98; // Giảm tốc nhẹ khi bay lên
            this.vy *= 0.98;
            
            this.x += this.vx;
            this.y += this.vy;

            // Kiểm tra xem đã đến đích chưa
            if (this.vy >= -1 || this.y <= this.targetY + 50) {
                createExplosion(this.x, this.y, this.type, this.text);
                fireworks.splice(index, 1);
            }
        }

        draw() {
            ctx.beginPath();
            ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
            ctx.lineTo(this.x, this.y);
            ctx.strokeStyle = `hsl(${Math.random() * 360}, 100%, ${this.brightness}%)`;
            ctx.stroke();
        }
    }

    // Class tạo hạt nổ
    class Particle {
        constructor(x, y, color, speed, angle, friction) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.angle = angle;
            this.speed = speed;
            this.vx = Math.cos(this.angle) * this.speed;
            this.vy = Math.sin(this.angle) * this.speed;
            this.friction = friction;
            this.gravity = GRAVITY;
            this.alpha = 1;
            this.decay = Math.random() * 0.015 + 0.005; // Độ tan biến
        }

        update(index) {
            this.vx *= this.friction;
            this.vy *= this.friction;
            this.vy += this.gravity;
            this.x += this.vx;
            this.y += this.vy;
            this.alpha -= this.decay;

            if (this.alpha <= 0) {
                particles.splice(index, 1);
            }
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
    }

    // Hàm lấy tọa độ pixel của chữ để tạo hình
    function getTextCoordinates(text) {
        // Tạo một canvas ảo để vẽ chữ và lấy dữ liệu pixel
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d');
        offCanvas.width = window.innerWidth;
        offCanvas.height = 400;
        
        // Cấu hình font chữ to và đậm
        let fontSize = 80;
        if (window.innerWidth < 600) fontSize = 40; // Mobile thì chữ bé hơn
        
        offCtx.font = `bold ${fontSize}px Arial`;
        offCtx.fillStyle = 'white';
        offCtx.textAlign = 'center';
        offCtx.textBaseline = 'middle';
        offCtx.fillText(text, offCanvas.width / 2, offCanvas.height / 2);

        const imageData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
        const data = imageData.data;
        const coords = [];
        
        // Quét pixel (giảm độ phân giải để đỡ lag - gap = 4 hoặc 5)
        const gap = 4; 
        for (let y = 0; y < offCanvas.height; y += gap) {
            for (let x = 0; x < offCanvas.width; x += gap) {
                const alpha = data[(y * offCanvas.width + x) * 4 + 3];
                if (alpha > 128) { // Nếu pixel không trong suốt
                    coords.push({x: x, y: y});
                }
            }
        }
        return coords;
    }

    // Hàm tạo nổ
    function createExplosion(x, y, type, text) {
        playSound();
        
        if (type === 'text') {
            // Nổ ra chữ
            const coords = getTextCoordinates(text);
            const hueStart = Math.random() * 360;
            
            // Dịch chuyển toạ độ chữ về vị trí nổ
            // Tính offset để tâm chữ trùng với x, y
            // Mặc định chữ vẽ ở (width/2, height/2) của offCanvas
            
            // Điều chỉnh một chút màu sắc
            let colorStr = `hsl(${Math.random() * 360}, 100%, 70%)`;
            if (text.includes("DƯƠNG")) colorStr = `hsl(330, 100%, 70%)`; // Màu hồng đậm cho tên
            if (text.includes("NĂM MỚI")) colorStr = `hsl(45, 100%, 60%)`; // Màu vàng cho năm mới

            coords.forEach(coord => {
                // Tính toán vị trí tương đối
                let targetX = coord.x; 
                let targetY = coord.y - 200 + y; // Dịch chuyển theo Y của vụ nổ

                // Tạo hạt đứng yên tại vị trí chữ, chỉ rơi nhẹ
                const p = new Particle(targetX, targetY, colorStr, 0, 0, 0.9);
                p.vx = (Math.random() - 0.5) * 0.5; // Rung nhẹ
                p.vy = (Math.random() - 0.5) * 0.5;
                p.decay = 0.008; // Tan chậm hơn để đọc được chữ
                particles.push(p);
            });

            // Thêm vài hạt nổ tung tóe xung quanh cho đẹp
            for(let i=0; i<30; i++) {
                 const angle = Math.random() * Math.PI * 2;
                 const speed = Math.random() * 3;
                 particles.push(new Particle(x, y, colorStr, speed, angle, 0.95));
            }

        } else {
            // Nổ bình thường (Hình tròn)
            const particleCount = 100;
            const hue = Math.random() * 360;
            for (let i = 0; i < particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 6 + 1;
                const color = `hsl(${hue}, 100%, 60%)`;
                particles.push(new Particle(x, y, color, speed, angle, 0.95));
            }
        }
    }

    // Vòng lặp chính
    function loop() {
        requestAnimationFrame(loop);
        
        // Tạo hiệu ứng vệt mờ (trails)
        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // Tăng số này lên để pháo tan nhanh hơn (giảm lag)
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.globalCompositeOperation = 'lighter';

        // Update pháo bay lên
        for (let i = fireworks.length - 1; i >= 0; i--) {
            fireworks[i].draw();
            fireworks[i].update(i);
        }

        // Update hạt nổ
        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].draw();
            particles[i].update(i);
        }
    }

    // KỊCH BẢN CHẠY
    // 1. Chờ click chuột để bắt đầu (Do chính sách trình duyệt chặn âm thanh)
    let hasStarted = false;
    
    function startShow() {
        if(hasStarted) return;
        hasStarted = true;
        
        // Ẩn hướng dẫn click (nếu có)
        
        // Đợt 1: CHÚC MỪNG NĂM MỚI (Sau 1 giây)
        setTimeout(() => {
            fireworks.push(new Firework(canvas.width / 2, canvas.height, canvas.width / 2, canvas.height / 3, 'text', "CHÚC MỪNG NĂM MỚI"));
        }, 1000);

        // Đợt 2: TRƯƠNG THỊ DƯƠNG (Sau 5 giây - chờ đợt 1 tan)
        setTimeout(() => {
             // Bắn 2 quả phụ 2 bên trước
             fireworks.push(new Firework(canvas.width / 4, canvas.height, canvas.width / 4, canvas.height / 4, 'normal'));
             fireworks.push(new Firework(canvas.width * 3/4, canvas.height, canvas.width * 3/4, canvas.height / 4, 'normal'));
             
             // Bắn tên chính giữa
             setTimeout(() => {
                 fireworks.push(new Firework(canvas.width / 2, canvas.height, canvas.width / 2, canvas.height / 3, 'text', "TRƯƠNG THỊ DƯƠNG"));
             }, 800);
        }, 5000);

        // Đợt 3: Bắn tự do liên tục (Sau 10 giây)
        setTimeout(() => {
            setInterval(() => {
                const x = Math.random() * canvas.width;
                const targetY = Math.random() * (canvas.height / 2);
                fireworks.push(new Firework(x, canvas.height, x, targetY, 'normal'));
            }, 800); // 0.8 giây bắn 1 quả
        }, 10000);
    }

    // Lắng nghe sự kiện click để bắt đầu
    window.addEventListener('click', startShow);
    window.addEventListener('touchstart', startShow);
    
    // Resize canvas khi đổi kích thước màn hình
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });

    loop();

    // Vẽ chữ hướng dẫn ban đầu
    ctx.font = "20px Arial";
    ctx.fillStyle = "white";
    ctx.textAlign = "center";
    ctx.fillText("Chạm vào màn hình để bắt đầu", canvas.width/2, canvas.height/2);

</script>
</body>
</html>
