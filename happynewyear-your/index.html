<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy New Year - Truong Thi Duong</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #020202;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        canvas {
            display: block;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            z-index: 999;
            cursor: pointer;
            text-align: center;
            user-select: none;
            transition: opacity 1s ease;
        }
        #overlay h1 {
            color: #ffcc00;
            margin-bottom: 15px;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px #ff6600;
        }
        #overlay p {
            color: #ccc;
            font-size: 14px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.05); opacity: 1; }
        }
    </style>
</head>
<body>

<div id="overlay">
    <h1>✨ Gửi: Trương Thị Dương ✨</h1>
    <p>(Chạm vào màn hình để mở quà)</p>
</div>

<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let fireworks = [];
    let particles = [];
    let frame = 0;
    let isPlaying = false;
    let currentStage = -1;
    
    // Danh sách các giai đoạn bắn
    const stages = [
        'start_single', // Bắn mở màn
        'text1',        // Chúc Mừng Năm Mới
        'mix_1',        // Hỗn hợp nhỏ
        'text2',        // Trương Thị Dương
        'mix_2',        // Hỗn hợp to
        'finale'        // Cao trào (Chùm dài)
    ];

    // --- CẤU HÌNH KÍCH THƯỚC ---
    function getScreenConfig() {
        const area = canvas.width * canvas.height;
        if (area < 300000) { // Mobile
            return { scale: 0.5, countMult: 0.6, fontSize: 18, textGap: 5 };
        } else if (area < 1000000) { // Tablet
            return { scale: 0.8, countMult: 0.8, fontSize: 30, textGap: 4 };
        } else { // Desktop
            return { scale: 1.0, countMult: 1.0, fontSize: 45, textGap: 4 };
        }
    }

    // --- ÂM THANH ---
    // Sử dụng link từ website của bạn
    const sounds = {
        launch: new Audio('https://nguyenbacson.io.vn/moi-ban.mp3'),
        short: new Audio('https://nguyenbacson.io.vn/no-ngan.mp3'),
        small: new Audio('https://nguyenbacson.io.vn/chum-be.mp3'),
        big: new Audio('https://nguyenbacson.io.vn/chum-to.mp3'),
        long: new Audio('https://nguyenbacson.io.vn/chum-dai.mp3') // Finale
    };

    // Điều chỉnh âm lượng
    sounds.launch.volume = 0.3;
    sounds.short.volume = 0.5;
    sounds.small.volume = 0.5;
    sounds.big.volume = 0.7;
    sounds.long.volume = 0.8;

    function playSound(type) {
        if (!isPlaying) return;
        
        // Riêng âm thanh dài (finale) chỉ phát 1 lần
        if (type === 'long') {
            sounds.long.currentTime = 0;
            sounds.long.play().catch(() => {});
            return;
        }

        const sound = sounds[type];
        if (sound) {
            // Clone để có thể phát chồng lên nhau
            const clone = sound.cloneNode();
            clone.volume = sound.volume;
            clone.play().catch(() => {});
        }
    }

    function random(min, max) {
        return Math.random() * (max - min) + min;
    }

    function getRandomColor() {
        // Các bảng màu đẹp thay vì random hoàn toàn
        const palettes = [
            [30, 60],   // Vàng/Cam (Tết)
            [0, 20],    // Đỏ
            [180, 220], // Xanh dương/Cyan
            [280, 320], // Tím/Hồng
            [0, 360]    // Multicolor
        ];
        const palette = palettes[Math.floor(Math.random() * palettes.length)];
        return random(palette[0], palette[1]);
    }

    // --- CLASS PHÁO BAY LÊN ---
    class Firework {
        constructor(x, y, targetX, targetY, type, text = '') {
            this.x = x;
            this.y = y;
            this.targetX = targetX;
            this.targetY = targetY;
            this.type = type; // 'text', 'short', 'small', 'big'
            this.text = text;
            
            const angle = Math.atan2(targetY - y, targetX - x);
            const speed = random(13, 17); // Tốc độ bay
            
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            
            this.hue = random(0, 360);
            this.brightness = random(50, 80);
            this.trail = [];
            
            playSound('launch');
        }

        update(index) {
            // Lưu vết
            this.trail.push({x: this.x, y: this.y});
            if(this.trail.length > 4) this.trail.shift();

            this.x += this.vx;
            this.y += this.vy;
            
            // Trọng lực nhẹ khi bay
            this.vy += 0.05;

            // Tính khoảng cách để nổ
            const dist = Math.sqrt(Math.pow(this.x - this.targetX, 2) + Math.pow(this.y - this.targetY, 2));
            
            // Nổ khi gần đích hoặc bắt đầu rơi xuống
            if (dist < 20 || (this.vy >= 0 && this.y < canvas.height - 100)) {
                createExplosion(this.x, this.y, this.type, this.text);
                fireworks.splice(index, 1);
            }
        }

        draw() {
            ctx.beginPath();
            ctx.moveTo(this.trail[0]?.x || this.x, this.trail[0]?.y || this.y);
            ctx.lineTo(this.x, this.y);
            ctx.strokeStyle = `hsl(${this.hue}, 100%, 60%)`;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        }
    }

    // --- CLASS HẠT NỔ ---
    class Particle {
        constructor(x, y, hue, type, destX = 0, destY = 0) {
            this.x = x;
            this.y = y;
            this.hue = hue;
            this.type = type; // 'text', 'sparkle', 'normal'
            this.alpha = 1;
            this.decay = random(0.008, 0.015);
            
            const config = getScreenConfig();

            if (this.type === 'text') {
                this.destX = destX;
                this.destY = destY;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.ease = 0.08;
                this.size = config.scale * 1.5;
                this.decay = 0; // Chữ không mờ đi ngay
                this.life = 0;
            } else {
                // Vật lý cho hạt nổ
                const speed = type === 'big' ? random(4, 8) : random(2, 5);
                const angle = random(0, Math.PI * 2);
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.friction = 0.95;
                this.gravity = 0.05;
                this.size = random(1, 3) * config.scale;
                
                if (type === 'big') {
                    this.friction = 0.93; // Rơi chậm hơn, bung rộng hơn
                    this.sparkle = Math.random() < 0.3; // 30% hạt lấp lánh
                }
            }
        }

        update(index) {
            if (this.type === 'text') {
                // Di chuyển hạt về vị trí tạo hình chữ
                this.x += (this.destX - this.x) * this.ease;
                this.y += (this.destY - this.y) * this.ease;
                
                // Hiệu ứng lung linh cho chữ
                this.life++;
                if (this.life > 150) this.alpha -= 0.02; // Chữ biến mất sau một lúc
            } else {
                this.vx *= this.friction;
                this.vy *= this.friction;
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.alpha -= this.decay;

                if (this.type === 'big' && this.sparkle) {
                    this.alpha = random(0.4, 1); // Nhấp nháy
                }
            }

            if (this.alpha <= 0.01) particles.splice(index, 1);
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.fillStyle = `hsl(${this.hue}, 100%, 60%)`;
            
            if (this.type === 'text') {
                // Vẽ chữ rực rỡ hơn
                ctx.shadowBlur = 5;
                ctx.shadowColor = `hsl(${this.hue}, 100%, 50%)`;
            }
            
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
    }

    // --- TẠO CHỮ TỪ ĐIỂM ẢNH ---
    function getTextPoints(text) {
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d');
        const config = getScreenConfig();
        
        offCanvas.width = canvas.width;
        offCanvas.height = 200; // Chiều cao vùng chữ
        
        let fontSize = config.fontSize;
        if (text.length > 10 && canvas.width < 500) fontSize = fontSize * 0.7; // Giảm size nếu tên dài trên mobile

        offCtx.font = `900 ${fontSize}px Arial`;
        offCtx.fillStyle = '#fff';
        offCtx.textAlign = 'center';
        offCtx.textBaseline = 'middle';
        offCtx.fillText(text, offCanvas.width / 2, offCanvas.height / 2);

        const imageData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
        const data = imageData.data;
        const points = [];
        const gap = config.textGap; // Khoảng cách lấy mẫu để giảm lag

        for (let y = 0; y < offCanvas.height; y += gap) {
            for (let x = 0; x < offCanvas.width; x += gap) {
                // Nếu điểm ảnh có màu (alpha > 128)
                if (data[(y * offCanvas.width + x) * 4 + 3] > 128) {
                    points.push({ x, y });
                }
            }
        }
        return { points, width: offCanvas.width, height: offCanvas.height };
    }

    // --- XỬ LÝ NỔ ---
    function createExplosion(x, y, type, text) {
        const config = getScreenConfig();
        
        if (type === 'text') {
            playSound('short'); // Tiếng nổ gọn cho chữ
            const data = getTextPoints(text);
            const points = data.points;
            const hue = random(0, 360);
            
            // Giới hạn số lượng hạt tối đa để tránh crash
            const maxParticles = 1500;
            const step = Math.ceil(points.length / maxParticles);
            
            for (let i = 0; i < points.length; i += step) {
                const p = points[i];
                // Căn giữa chữ vào vị trí nổ
                const destX = x + (p.x - data.width / 2);
                const destY = y + (p.y - data.height / 2);
                particles.push(new Particle(x, y, hue, 'text', destX, destY));
            }
        } else {
            playSound(type); // small, big, short
            
            let count = 20;
            let pType = 'normal';
            
            if (type === 'big') {
                count = 60 * config.countMult;
                pType = 'big';
            } else if (type === 'small') {
                count = 30 * config.countMult;
            } else {
                count = 15 * config.countMult;
            }

            const hue = getRandomColor();
            
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, hue + random(-15, 15), pType));
            }
        }
    }

    // --- KỊCH BẢN ---
    function nextStage() {
        if (!isPlaying) return;
        currentStage++;

        // Reset stage nếu hết vòng (trừ finale)
        if (currentStage >= stages.length) {
            currentStage = 0; 
        }

        const stage = stages[currentStage];
        let delayNext = 2000;

        switch(stage) {
            case 'start_single':
                // 3 phát bắn rời rạc
                for(let i=0; i<3; i++) {
                    setTimeout(() => {
                        fireworks.push(new Firework(
                            random(width*0.2, width*0.8), height,
                            random(width*0.3, width*0.7), random(height*0.2, height*0.5),
                            'short'
                        ));
                    }, i * 800);
                }
                delayNext = 3000;
                break;

            case 'text1':
                // Chữ Chúc Mừng Năm Mới
                fireworks.push(new Firework(
                    canvas.width/2, canvas.height,
                    canvas.width/2, canvas.height * 0.25,
                    'text', 'CHÚC MỪNG NĂM MỚI'
                ));
                delayNext = 5000; // Đợi chữ tan
                break;

            case 'mix_1':
                // Hỗn hợp chùm bé
                for(let i=0; i<5; i++) {
                    setTimeout(() => {
                        fireworks.push(new Firework(
                            random(0, canvas.width), canvas.height,
                            random(canvas.width*0.1, canvas.width*0.9), random(canvas.height*0.1, canvas.height*0.6),
                            'small'
                        ));
                    }, i * 500);
                }
                delayNext = 4000;
                break;

            case 'text2':
                // Chữ Tên Riêng
                fireworks.push(new Firework(
                    canvas.width/2, canvas.height,
                    canvas.width/2, canvas.height * 0.4,
                    'text', 'TRƯƠNG THỊ DƯƠNG'
                ));
                delayNext = 6000;
                break;

            case 'mix_2':
                // Chùm to đẹp
                for(let i=0; i<3; i++) {
                    setTimeout(() => {
                        fireworks.push(new Firework(
                            random(canvas.width*0.3, canvas.width*0.7), canvas.height,
                            random(canvas.width*0.2, canvas.width*0.8), random(canvas.height*0.2, canvas.height*0.5),
                            'big'
                        ));
                    }, i * 1500);
                }
                delayNext = 5000;
                break;

            case 'finale':
                // Chùm dài 25s liên tục
                playSound('long');
                const duration = 25000; // 25s
                const interval = setInterval(() => {
                    const type = Math.random() < 0.4 ? 'big' : 'small';
                    fireworks.push(new Firework(
                        random(0, canvas.width), canvas.height,
                        random(0, canvas.width), random(canvas.height*0.1, canvas.height*0.7),
                        type
                    ));
                }, 400); // Bắn dày đặc

                setTimeout(() => {
                    clearInterval(interval);
                    // Sau finale quay lại loop nhẹ nhàng
                    setTimeout(nextStage, 5000); 
                }, duration);
                
                return; // Không gọi setTimeOut nextStage ở cuối switch vì đã xử lý ở trên
        }

        if (stage !== 'finale') {
            setTimeout(nextStage, delayNext);
        }
    }

    // --- MAIN LOOP ---
    function loop() {
        requestAnimationFrame(loop);
        frame++;

        // Hiệu ứng mờ đuôi (trail effect)
        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; // Mờ dần
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.globalCompositeOperation = 'lighter';

        for (let i = fireworks.length - 1; i >= 0; i--) {
            fireworks[i].update(i);
            fireworks[i].draw();
        }
        
        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update(i);
            particles[i].draw();
        }
    }

    // --- SETUP ---
    overlay.addEventListener('click', () => {
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 1000);
        
        isPlaying = true;
        // Unlock audio context mobile
        const silence = new Audio();
        silence.play().catch(()=>{});
        
        nextStage(); // Bắt đầu kịch bản
    });

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });

    // Helper vars
    const width = canvas.width;
    const height = canvas.height;

    loop();

</script>
</body>
</html>
