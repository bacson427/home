<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nguyen Bac Son - LED DISCOVERY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: white;
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            user-select: none;
        }
        
        .container {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0,0,0,0.85);
            padding: 20px 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
            box-shadow: 0 0 30px rgba(255,0,128,0.3);
        }
        
        .title {
            font-size: 28px;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #ff0080, #00ffcc, #ff0080);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255,0,128,0.5);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        button {
            background: linear-gradient(45deg, #ff0080, #00ffcc);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 140px;
            box-shadow: 0 0 20px rgba(255,0,128,0.3);
        }
        
        button:hover {
            transform: scale(1.08);
            box-shadow: 0 0 30px rgba(255,0,128,0.6);
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .status {
            margin-top: 12px;
            font-size: 14px;
            color: #00ffcc;
            opacity: 0.9;
            font-weight: 500;
        }
        
        /* Canvas t·ªëi ∆∞u */
        #visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* LED strips */
        .led-container {
            position: absolute;
            left: 0;
            width: 100%;
            z-index: 2;
            display: flex;
            justify-content: space-around;
            padding: 0 20px;
        }
        
        .led-top {
            top: 120px;
        }
        
        .led-bottom {
            bottom: 80px;
        }
        
        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #1a1a1a;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform, background-color;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* Disco ball */
        .disco-ball {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #fff, #666 60%, #333 90%);
            z-index: 2;
            animation: rotate 8s linear infinite;
            box-shadow: 
                0 0 30px rgba(255,255,255,0.4),
                inset -5px -5px 10px rgba(0,0,0,0.6);
        }
        
        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Hi·ªáu ·ª©ng n·ªÅn */
        .bg-effect {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, transparent 10%, rgba(255,0,128,0.1) 40%);
            animation: bgPulse 4s ease-in-out infinite alternate;
            z-index: 0;
        }
        
        @keyframes bgPulse {
            0% { transform: scale(1); opacity: 0.3; }
            100% { transform: scale(1.5); opacity: 0.1; }
        }
        
        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffcc;
            font-size: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        /* Equalizer bars */
        .eq-bar {
            position: absolute;
            bottom: 0;
            width: 8px;
            background: linear-gradient(to top, #ff0080, #00ffcc);
            border-radius: 4px 4px 0 0;
            transition: height 0.15s ease-out;
            will-change: height;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="title">QU·∫∫ B√ìI - LED V≈® TR∆Ø·ªúNG</div>
            <div class="button-group">
                <button id="playBtn">üéµ B·∫¨T NH·∫†C</button>
                <button id="stopBtn">Stop</button>
            </div>
            <div class="status" id="status">Start</div>
        </div>
        
        <div class="loading" id="loading">üéµ Loadings...</div>
        
        <canvas id="visualizer"></canvas>
        
        <div class="led-container led-top" id="ledTop"></div>
        <div class="led-container led-bottom" id="ledBottom"></div>
        
        <div class="disco-ball"></div>
        
        <!-- Hi·ªáu ·ª©ng n·ªÅn -->
        <div class="bg-effect" style="top:20%;left:10%;width:300px;height:300px;animation-delay:0s;"></div>
        <div class="bg-effect" style="top:60%;left:70%;width:400px;height:400px;animation-delay:2s;"></div>
        
        <!-- Equalizer bars container -->
        <div id="eqContainer"></div>
    </div>

    <audio id="audio" preload="metadata">
        <source src="https://nguyenbacson.io.vn/nguyenbacson.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ===== C·∫§U H√åNH T·ªêI ∆ØU =====
        const config = {
            fftSize: 128,
            smoothing: 0.8,        // TƒÉng smoothing ƒë·ªÉ m∆∞·ª£t h∆°n
            ledCount: 24,
            barCount: 40,          // S·ªë thanh c·ªë ƒë·ªãnh
            maxFPS: 30,
            historySize: 5         // L√†m m∆∞·ª£t b·∫±ng history
        };

        // Cache DOM elements
        const el = {
            audio: document.getElementById('audio'),
            playBtn: document.getElementById('playBtn'),
            stopBtn: document.getElementById('stopBtn'),
            status: document.getElementById('status'),
            loading: document.getElementById('loading'),
            canvas: document.getElementById('visualizer'),
            ledTop: document.getElementById('ledTop'),
            ledBottom: document.getElementById('ledBottom'),
            eqContainer: document.getElementById('eqContainer')
        };

        const ctx = el.canvas.getContext('2d', { 
            alpha: false,
            desynchronized: true 
        });

        // State v·ªõi history ƒë·ªÉ l√†m m∆∞·ª£t
        let state = {
            audioContext: null,
            analyser: null,
            dataArray: null,
            animationId: null,
            isPlaying: false,
            lastFrameTime: 0,
            volumeHistory: new Array(config.historySize).fill(0),
            historyIndex: 0,
            eqBars: []
        };

        // ===== KH·ªûI T·∫†O =====
        function init() {
            setupCanvas();
            createLEDs();
            createEqualizerBars();
            preloadAudio();
            setupEventListeners();
        }

        function setupCanvas() {
            el.canvas.width = window.innerWidth;
            el.canvas.height = window.innerHeight;
            // N·ªÅn gradient tƒ©nh
            const gradient = ctx.createLinearGradient(0, 0, el.canvas.width, el.canvas.height);
            gradient.addColorStop(0, '#0f0c29');
            gradient.addColorStop(0.5, '#302b63');
            gradient.addColorStop(1, '#24243e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, el.canvas.width, el.canvas.height);
        }

        function createLEDs() {
            createLEDStrip(el.ledTop);
            createLEDStrip(el.ledBottom);
        }

        function createLEDStrip(container) {
            container.innerHTML = '';
            const count = config.ledCount;
            
            for (let i = 0; i < count; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                container.appendChild(led);
            }
        }

        function createEqualizerBars() {
            el.eqContainer.innerHTML = '';
            state.eqBars = [];
            const barWidth = 8;
            const spacing = 4;
            const totalWidth = (barWidth + spacing) * config.barCount - spacing;
            const startX = (window.innerWidth - totalWidth) / 2;
            
            for (let i = 0; i < config.barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'eq-bar';
                bar.style.left = (startX + i * (barWidth + spacing)) + 'px';
                bar.style.height = '10px';
                el.eqContainer.appendChild(bar);
                state.eqBars.push(bar);
            }
        }

        function preloadAudio() {
            el.audio.load();
            setTimeout(() => {
                el.loading.style.display = 'none';
            }, 1500);
        }

        function setupEventListeners() {
            el.playBtn.addEventListener('click', handlePlay);
            el.stopBtn.addEventListener('click', handleStop);
            window.addEventListener('resize', handleResize);
        }

        // ===== X·ª¨ L√ù AUDIO =====
        function initAudio() {
            try {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                state.analyser = state.audioContext.createAnalyser();
                const source = state.audioContext.createMediaElementSource(el.audio);
                
                source.connect(state.analyser);
                state.analyser.connect(state.audioContext.destination);
                
                state.analyser.fftSize = config.fftSize;
                state.analyser.smoothingTimeConstant = config.smoothing;
                
                const bufferLength = state.analyser.frequencyBinCount;
                state.dataArray = new Uint8Array(bufferLength);
                
                return true;
            } catch (error) {
                console.error('L·ªói audio:', error);
                updateStatus('‚ùå L·ªói kh·ªüi t·∫°o audio', '#ff0080');
                return false;
            }
        }

        // ===== RENDER M∆Ø·ª¢T M√Ä =====
        function render(currentTime) {
            if (!state.isPlaying) return;
            
            // Gi·ªõi h·∫°n FPS
            if (currentTime - state.lastFrameTime < 1000 / config.maxFPS) {
                state.animationId = requestAnimationFrame(render);
                return;
            }
            state.lastFrameTime = currentTime;

            if (!state.analyser || !state.dataArray) return;
            
            state.analyser.getByteFrequencyData(state.dataArray);
            drawSmoothVisualizer();
            updateLEDs();
            updateEqualizer();
            
            state.animationId = requestAnimationFrame(render);
        }

        function drawSmoothVisualizer() {
            // N·ªÅn gradient
            const gradient = ctx.createLinearGradient(0, 0, el.canvas.width, el.canvas.height);
            gradient.addColorStop(0, 'rgba(15, 12, 41, 0.3)');
            gradient.addColorStop(1, 'rgba(36, 36, 62, 0.3)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, el.canvas.width, el.canvas.height);
            
            const centerY = el.canvas.height / 2;
            const maxAmplitude = el.canvas.height * 0.4;
            
            // V·∫Ω s√≥ng √¢m thanh m∆∞·ª£t m√†
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            
            for (let i = 0; i < state.dataArray.length; i++) {
                const value = state.dataArray[i];
                
                // L√†m m∆∞·ª£t b·∫±ng c√°ch l·∫•y trung b√¨nh
                const smoothValue = getSmoothedValue(value);
                const x = (i / state.dataArray.length) * el.canvas.width;
                const y = centerY + (smoothValue / 255 - 0.5) * maxAmplitude;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            // T·∫°o gradient cho s√≥ng
            const waveGradient = ctx.createLinearGradient(0, 0, el.canvas.width, 0);
            waveGradient.addColorStop(0, '#ff0080');
            waveGradient.addColorStop(0.5, '#00ffcc');
            waveGradient.addColorStop(1, '#ff0080');
            
            ctx.strokeStyle = waveGradient;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ƒê·ªï b√≥ng cho s√≥ng
            ctx.shadowColor = '#00ffcc';
            ctx.shadowBlur = 20;
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function getSmoothedValue(currentValue) {
            // C·∫≠p nh·∫≠t history
            state.volumeHistory[state.historyIndex] = currentValue;
            state.historyIndex = (state.historyIndex + 1) % config.historySize;
            
            // T√≠nh trung b√¨nh
            let sum = 0;
            for (let i = 0; i < config.historySize; i++) {
                sum += state.volumeHistory[i];
            }
            return sum / config.historySize;
        }

        function updateLEDs() {
            updateLEDStrip(el.ledTop);
            updateLEDStrip(el.ledBottom);
        }

        function updateLEDStrip(container) {
            const leds = container.children;
            const ledCount = leds.length;
            
            for (let i = 0; i < ledCount; i++) {
                const led = leds[i];
                const dataIndex = Math.floor((i / ledCount) * state.dataArray.length);
                const intensity = getSmoothedValue(state.dataArray[dataIndex]) / 255;
                
                if (intensity > 0.15) {
                    const hue = (i * 15 + Date.now() * 0.03) % 360;
                    const saturation = 80 + intensity * 20;
                    const lightness = 40 + intensity * 30;
                    
                    led.style.background = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    led.style.transform = `scale(${1 + intensity * 0.4})`;
                    led.style.boxShadow = `0 0 ${10 + intensity * 20}px hsl(${hue}, 100%, 50%)`;
                } else {
                    led.style.background = '#1a1a1a';
                    led.style.transform = 'scale(1)';
                    led.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
                }
            }
        }

        function updateEqualizer() {
            const bars = state.eqBars;
            const barCount = bars.length;
            
            for (let i = 0; i < barCount; i++) {
                const bar = bars[i];
                const dataIndex = Math.floor((i / barCount) * state.dataArray.length);
                const intensity = getSmoothedValue(state.dataArray[dataIndex]) / 255;
                const height = 10 + intensity * 150;
                
                bar.style.height = `${height}px`;
                
                // Gradient m√†u theo c∆∞·ªùng ƒë·ªô
                const hue = (i * 18 + Date.now() * 0.02) % 360;
                bar.style.background = `linear-gradient(to top, 
                    hsl(${hue}, 100%, 50%), 
                    hsl(${hue + 60}, 100%, 50%))`;
            }
        }

        // ===== X·ª¨ L√ù S·ª∞ KI·ªÜN =====
        async function handlePlay() {
            if (state.isPlaying) return;
            
            try {
                if (!state.audioContext && !initAudio()) return;
                
                if (state.audioContext.state === 'suspended') {
                    await state.audioContext.resume();
                }
                
                await el.audio.play();
                state.isPlaying = true;
                updateStatus('üé∂ Nguyen Bac Son - LED NH·∫§P NH√ÅY', '#00ffcc');
                
                state.lastFrameTime = performance.now();
                state.animationId = requestAnimationFrame(render);
                
            } catch (error) {
                console.error('L·ªói ph√°t nh·∫°c:', error);
                updateStatus('‚ùå L·ªói ph√°t nh·∫°c', '#ff0080');
            }
        }

        function handleStop() {
            if (!state.isPlaying) return;
            
            el.audio.pause();
            el.audio.currentTime = 0;
            state.isPlaying = false;
            
            if (state.animationId) {
                cancelAnimationFrame(state.animationId);
                state.animationId = null;
            }
            
            updateStatus('Continue ', '#ff0080');
            resetVisuals();
        }

        function handleResize() {
            setupCanvas();
            createLEDs();
            createEqualizerBars();
        }

        // ===== TI·ªÜN √çCH =====
        function updateStatus(text, color) {
            el.status.textContent = text;
            el.status.style.color = color;
        }

        function resetVisuals() {
            // Reset canvas
            const gradient = ctx.createLinearGradient(0, 0, el.canvas.width, el.canvas.height);
            gradient.addColorStop(0, '#0f0c29');
            gradient.addColorStop(0.5, '#302b63');
            gradient.addColorStop(1, '#24243e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, el.canvas.width, el.canvas.height);
            
            // Reset LEDs
            const allLEDs = document.querySelectorAll('.led');
            allLEDs.forEach(led => {
                led.style.background = '#1a1a1a';
                led.style.transform = 'scale(1)';
                led.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
            });
            
            // Reset equalizer
            state.eqBars.forEach(bar => {
                bar.style.height = '10px';
            });
        }

        // ===== KH·ªûI CH·∫†Y =====
        window.addEventListener('load', init);

        // D·ªçn d·∫πp
        window.addEventListener('beforeunload', () => {
            if (state.animationId) cancelAnimationFrame(state.animationId);
            if (el.audio) {
                el.audio.pause();
                el.audio.src = '';
            }
        });

        // H·ªó tr·ª£ mobile
        document.addEventListener('touchstart', function() {
            if (state.audioContext && state.audioContext.state === 'suspended') {
                state.audioContext.resume();
            }
        });
    </script>
</body>
</html>
