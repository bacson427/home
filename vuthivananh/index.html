<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Công và Sản lượng</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        h1 {
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .login-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            max-width: 400px;
            margin: 20px auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background-color: #1e5799;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        button:hover {
            background-color: #154275;
        }
        
        .main-section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -8px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 8px;
            min-width: 200px;
            margin-bottom: 10px;
        }
        
        .image-upload {
            border: 2px dashed #ddd;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .image-upload:hover {
            border-color: #1e5799;
            background-color: #f8f9fa;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .image-preview img {
            width: 80px;
            height: 80px;
            border-radius: 5px;
            object-fit: cover;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        
        .image-preview img:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            font-weight: 600;
            font-size: 13px;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-export {
            background-color: #28a745;
        }
        
        .btn-export:hover {
            background-color: #218838;
        }
        
        .btn-logout {
            background-color: #dc3545;
        }
        
        .btn-logout:hover {
            background-color: #c82333;
        }
        
        .hidden {
            display: none;
        }
        
        .error-message {
            color: #dc3545;
            margin-top: 5px;
            font-size: 13px;
            text-align: center;
        }
        
        .success-message {
            color: #28a745;
            margin-top: 5px;
            font-size: 13px;
            text-align: center;
        }
        
        .btn-delete {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }
        
        .btn-delete:hover {
            background-color: #c82333;
        }
        
        .btn-view {
            background-color: #17a2b8;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
            margin-right: 5px;
        }
        
        .btn-view:hover {
            background-color: #138496;
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            flex: 1;
            min-width: 150px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #1e5799;
        }
        
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }
        
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            margin-top: 2%;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .image-gallery img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .main-section, .login-section {
                padding: 15px;
            }
            
            .form-col {
                min-width: 100%;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 6px;
            }
            
            .export-options {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .image-preview img {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>HỆ THỐNG TÍNH CÔNG VÀ SẢN LƯỢNG</h1>
            <p>Quản lý dữ liệu công việc và sản lượng sản phẩm</p>
        </header>
        
        <section id="loginSection" class="login-section">
            <h2>Đăng nhập hệ thống</h2>
            <div class="form-group">
                <label for="userId">ID đăng nhập</label>
                <input type="text" id="userId" placeholder="Nhập ID đăng nhập" value="0388427368">
            </div>
            <div class="form-group">
                <label for="password">Mật khẩu</label>
                <input type="password" id="password" placeholder="Nhập mật khẩu" value="@Van2007">
            </div>
            <button id="loginBtn">Đăng nhập</button>
            <div id="loginMessage" class="error-message"></div>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </section>
    <section id="mainSection" class="main-section">
        <h2>Nhập dữ liệu công việc</h2>
        <form id="workForm">
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="name">Tên nhân viên *</label>
                        <input type="text" id="name" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="date">Ngày tháng năm *</label>
                        <input type="date" id="date" required>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="startImage">Ảnh bắt đầu *</label>
                        <div class="image-upload" id="startImageUpload">
                            <p>📷 Nhấp để tải ảnh lên</p>
                            <input type="file" id="startImage" accept="image/*" class="hidden" multiple>
                        </div>
                        <div id="startImagePreview" class="image-preview"></div>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="endImage">Ảnh kết thúc *</label>
                        <div class="image-upload" id="endImageUpload">
                            <p>📷 Nhấp để tải ảnh lên</p>
                            <input type="file" id="endImage" accept="image/*" class="hidden" multiple>
                        </div>
                        <div id="endImagePreview" class="image-preview"></div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="additionalImage">Ảnh bổ sung (tùy chọn)</label>
                <div class="image-upload" id="additionalImageUpload">
                    <p>📷 Nhấp để tải ảnh bổ sung</p>
                    <input type="file" id="additionalImage" accept="image/*" class="hidden" multiple>
                </div>
                <div id="additionalImagePreview" class="image-preview"></div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="workType">Công việc *</label>
                        <select id="workType" required>
                            <option value="">-- Chọn công việc --</option>
                            <option value="ham_ech_tinh_theo_san_pham">Hàm ếch tính theo sản phẩm</option>
                            <option value="nhap_du_lieu_tinh_theo_to">Nhập dữ liệu tính theo tờ</option>
                            <option value="khac">Khác</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="quantity">Số lượng</label>
                        <input type="number" id="quantity" min="0" step="1" placeholder="0">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes">Ghi chú</label>
                <textarea id="notes" rows="2" placeholder="Nhập ghi chú nếu có..."></textarea>
            </div>
            
            <button type="submit" id="submitBtn">➕ Thêm dữ liệu</button>
            <div id="formMessage" class="success-message"></div>
        </form>
        
        <h2>Dữ liệu đã nhập</h2>
        <div style="overflow-x: auto;">
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th>Tên</th>
                        <th>Ngày</th>
                        <th>Công việc</th>
                        <th>Số lượng</th>
                        <th>Ảnh bắt đầu</th>
                        <th>Ảnh kết thúc</th>
                        <th>Ảnh bổ sung</th>
                        <th>Ghi chú</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Dữ liệu sẽ được thêm vào đây -->
                </tbody>
            </table>
        </div>
        
        <h3>Xuất dữ liệu</h3>
        <div class="export-options">
            <button id="exportExcelBtn" class="btn-export export-btn">📊 Xuất Excel (.xlsx)</button>
            <button id="exportCSVBtn" class="btn-export export-btn" style="background-color: #17a2b8;">📄 Xuất CSV</button>
            <button id="exportPDFBtn" class="btn-export export-btn" style="background-color: #dc3545;">📋 Xuất PDF</button>
        </div>
        
        <div class="action-buttons">
            <button id="clearDataBtn" class="btn-logout" style="background-color: #ffc107; color: #000;">🗑️ Xóa toàn bộ dữ liệu</button>
            <button id="logoutBtn" class="btn-logout">🚪 Đăng xuất</button>
        </div>
    </section>
</div>

<!-- Modal xem ảnh -->
<div id="imageModal" class="image-modal">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

<!-- Modal xem chi tiết ảnh của bản ghi -->
<div id="detailModal" class="image-modal">
    <span class="close-modal">&times;</span>
    <div style="color: white; padding: 20px; max-width: 90%; margin: 0 auto;">
        <h3 id="detailTitle" style="text-align: center; margin-bottom: 20px;"></h3>
        <div class="form-row">
            <div class="form-col">
                <h4>Ảnh bắt đầu</h4>
                <div id="detailStartImages" class="image-gallery"></div>
            </div>
            <div class="form-col">
                <h4>Ảnh kết thúc</h4>
                <div id="detailEndImages" class="image-gallery"></div>
            </div>
        </div>
        <div class="form-group">
            <h4>Ảnh bổ sung</h4>
            <div id="detailAdditionalImages" class="image-gallery"></div>
        </div>
    </div>
</div>
<script>
    // ===== PHẦN JAVASCRIPT =====
    document.addEventListener('DOMContentLoaded', function() {
        // Biến toàn cục
        let workData = [];
        
        // Thông tin đăng nhập
        const ADMIN_ID = '0388427368';
        const ADMIN_PASSWORD = '@Van2007';
        
        // Tham chiếu đến các phần tử DOM
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');
        const debugInfo = document.getElementById('debugInfo');
        const workForm = document.getElementById('workForm');
        const dataTableBody = document.getElementById('dataTableBody');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportCSVBtn = document.getElementById('exportCSVBtn');
        const exportPDFBtn = document.getElementById('exportPDFBtn');
        const submitBtn = document.getElementById('submitBtn');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.querySelectorAll('.close-modal');
        const detailModal = document.getElementById('detailModal');
        const detailTitle = document.getElementById('detailTitle');
        const detailStartImages = document.getElementById('detailStartImages');
        const detailEndImages = document.getElementById('detailEndImages');
        const detailAdditionalImages = document.getElementById('detailAdditionalImages');
        
        // Hiển thị thông tin debug
        function showDebugInfo(message) {
            debugInfo.style.display = 'block';
            debugInfo.innerHTML = '<strong>Debug:</strong> ' + message;
            console.log('Debug:', message);
        }
        
        // Modal xem ảnh
        closeModal.forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                imageModal.style.display = 'none';
                detailModal.style.display = 'none';
            });
        });
        
        imageModal.addEventListener('click', function(e) {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });
        
        detailModal.addEventListener('click', function(e) {
            if (e.target === detailModal) {
                detailModal.style.display = 'none';
            }
        });
        
        // Thiết lập ngày mặc định là hôm nay
        document.getElementById('date').valueAsDate = new Date();
        
        // Xử lý sự kiện đăng nhập
        loginBtn.addEventListener('click', handleLogin);
        
        // Cho phép đăng nhập bằng phím Enter
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        function handleLogin() {
            const userId = userIdInput.value.trim();
            const password = passwordInput.value.trim();
            
            showDebugInfo(`Nhập: ID='${userId}', Password='${password}' | Mong đợi: ID='${ADMIN_ID}', Password='${ADMIN_PASSWORD}'`);
            
            if (userId === ADMIN_ID && password === ADMIN_PASSWORD) {
                showDebugInfo('✅ Đăng nhập THÀNH CÔNG!');
                loginSection.style.display = 'none';
                mainSection.style.display = 'block';
                loginMessage.textContent = '';
                loadWorkData();
            } else {
                let errorMsg = 'ID hoặc mật khẩu không đúng!';
                
                if (userId !== ADMIN_ID) {
                    errorMsg += ' (Sai ID)';
                } else if (password !== ADMIN_PASSWORD) {
                    errorMsg += ' (Sai mật khẩu)';
                }
                
                loginMessage.textContent = errorMsg;
                showDebugInfo('❌ Đăng nhập THẤT BẠI: ' + errorMsg);
                userIdInput.focus();
            }
        }
        
        // Xử lý sự kiện đăng xuất
        logoutBtn.addEventListener('click', function() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                mainSection.style.display = 'none';
                loginSection.style.display = 'block';
                userIdInput.value = '';
                passwordInput.value = '';
                debugInfo.style.display = 'none';
                userIdInput.focus();
            }
        });
        
        // Xử lý xóa toàn bộ dữ liệu
        clearDataBtn.addEventListener('click', function() {
            if (confirm('⚠️ Bạn có CHẮC CHẮN muốn xóa TOÀN BỘ dữ liệu? Hành động này không thể hoàn tác!')) {
                workData = [];
                localStorage.removeItem('workData');
                updateDataTable();
                alert('Đã xóa toàn bộ dữ liệu!');
            }
        });
// Xử lý upload ảnh
const imageUploads = [
    { upload: 'startImageUpload', input: 'startImage', preview: 'startImagePreview', type: 'start' },
    { upload: 'endImageUpload', input: 'endImage', preview: 'endImagePreview', type: 'end' },
    { upload: 'additionalImageUpload', input: 'additionalImage', preview: 'additionalImagePreview', type: 'additional' }
];

let currentImages = {
    start: [],
    end: [],
    additional: []
};

imageUploads.forEach(item => {
    const uploadElement = document.getElementById(item.upload);
    const inputElement = document.getElementById(item.input);
    const previewElement = document.getElementById(item.preview);
    
    uploadElement.addEventListener('click', function() {
        inputElement.click();
    });
    
    inputElement.addEventListener('change', function() {
        previewElement.innerHTML = '';
        currentImages[item.type] = [];
        
        if (inputElement.files) {
            Array.from(inputElement.files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentImages[item.type].push({
                            name: file.name,
                            data: e.target.result,
                            type: file.type,
                            size: file.size
                        });
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.title = file.name;
                        img.onclick = function() {
                            modalImage.src = this.src;
                            imageModal.style.display = 'block';
                        };
                        previewElement.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });
});

// Hàm hiển thị chi tiết ảnh của bản ghi
function showImageDetail(item) {
    detailTitle.textContent = `Ảnh công việc - ${item.name} - ${formatDate(item.date)}`;
    
    // Hiển thị ảnh bắt đầu
    detailStartImages.innerHTML = '';
    if (item.startImages && item.startImages.length > 0) {
        item.startImages.forEach(img => {
            const imgElement = document.createElement('img');
            imgElement.src = img.data;
            imgElement.title = img.name;
            imgElement.onclick = function() {
                modalImage.src = this.src;
                imageModal.style.display = 'block';
            };
            detailStartImages.appendChild(imgElement);
        });
    } else {
        detailStartImages.innerHTML = '<p style="color: #ccc;">Không có ảnh</p>';
    }
    
    // Hiển thị ảnh kết thúc
    detailEndImages.innerHTML = '';
    if (item.endImages && item.endImages.length > 0) {
        item.endImages.forEach(img => {
            const imgElement = document.createElement('img');
            imgElement.src = img.data;
            imgElement.title = img.name;
            imgElement.onclick = function() {
                modalImage.src = this.src;
                imageModal.style.display = 'block';
            };
            detailEndImages.appendChild(imgElement);
        });
    } else {
        detailEndImages.innerHTML = '<p style="color: #ccc;">Không có ảnh</p>';
    }
    
    // Hiển thị ảnh bổ sung
    detailAdditionalImages.innerHTML = '';
    if (item.additionalImages && item.additionalImages.length > 0) {
        item.additionalImages.forEach(img => {
            const imgElement = document.createElement('img');
            imgElement.src = img.data;
            imgElement.title = img.name;
            imgElement.onclick = function() {
                modalImage.src = this.src;
                imageModal.style.display = 'block';
            };
            detailAdditionalImages.appendChild(imgElement);
        });
    } else {
        detailAdditionalImages.innerHTML = '<p style="color: #ccc;">Không có ảnh</p>';
    }
    
    detailModal.style.display = 'block';
}

// Xử lý form thêm dữ liệu
workForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('name').value.trim();
    const date = document.getElementById('date').value;
    const workType = document.getElementById('workType').value;
    const quantity = document.getElementById('quantity').value || '0';
    const notes = document.getElementById('notes').value.trim();
    
    if (currentImages.start.length === 0 || currentImages.end.length === 0) {
        alert('⚠️ Vui lòng tải lên ảnh bắt đầu và ảnh kết thúc!');
        return;
    }
    
    if (!workType) {
        alert('⚠️ Vui lòng chọn loại công việc!');
        return;
    }
    
    // Tạo đối tượng dữ liệu công việc
    const workItem = {
        id: Date.now(),
        name: name,
        date: date,
        workType: workType,
        quantity: quantity,
        notes: notes,
        startImages: currentImages.start,
        endImages: currentImages.end,
        additionalImages: currentImages.additional,
        created_at: new Date().toISOString()
    };
    
    workData.push(workItem);
    saveWorkData();
    updateDataTable();
    
    workForm.reset();
    document.getElementById('startImagePreview').innerHTML = '';
    document.getElementById('endImagePreview').innerHTML = '';
    document.getElementById('additionalImagePreview').innerHTML = '';
    document.getElementById('date').valueAsDate = new Date();
    
    currentImages = {
        start: [],
        end: [],
        additional: []
    };
    
    document.getElementById('formMessage').textContent = '✅ Đã thêm dữ liệu thành công!';
    setTimeout(() => {
        document.getElementById('formMessage').textContent = '';
    }, 3000);
});

// Xuất file Excel
exportExcelBtn.addEventListener('click', function() {
    if (workData.length === 0) {
        alert('📭 Không có dữ liệu để xuất!');
        return;
    }
    
    const wb = XLSX.utils.book_new();
    const wsData = [
        ['DỮ LIỆU CÔNG VIỆC', '', '', '', '', '', '', ''],
        ['Xuất ngày:', new Date().toLocaleDateString('vi-VN'), '', '', '', '', '', ''],
        [],
        ['STT', 'Tên nhân viên', 'Ngày làm việc', 'Công việc', 'Số lượng', 'Số ảnh bắt đầu', 'Số ảnh kết thúc', 'Số ảnh bổ sung', 'Ghi chú']
    ];
    
    workData.forEach((item, index) => {
        wsData.push([
            index + 1,
            item.name,
            formatDate(item.date),
            getWorkTypeLabel(item.workType),
            item.quantity,
            item.startImages.length,
            item.endImages.length,
            item.additionalImages.length,
            item.notes || ''
        ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const colWidths = [
        { wch: 5 }, { wch: 20 }, { wch: 12 }, { wch: 25 }, { wch: 10 },
        { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 30 }
    ];
    ws['!cols'] = colWidths;
    
    XLSX.utils.book_append_sheet(wb, ws, 'CongViec');
    const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
    XLSX.writeFile(wb, `cong_viec_${timestamp}.xlsx`);
    
    alert('✅ Đã xuất file Excel thành công!');
});

// Xuất file CSV
exportCSVBtn.addEventListener('click', function() {
    if (workData.length === 0) {
        alert('📭 Không có dữ liệu để xuất!');
        return;
    }
    
    const BOM = '\uFEFF';
    let csvContent = BOM + "STT,Tên nhân viên,Ngày làm việc,Công việc,Số lượng,Số ảnh bắt đầu,Số ảnh kết thúc,Số ảnh bổ sung,Ghi chú\n";
    
    workData.forEach((item, index) => {
        const row = [
            index + 1,
            `"${item.name}"`,
            `"${formatDate(item.date)}"`,
            `"${getWorkTypeLabel(item.workType)}"`,
            `"${item.quantity}"`,
            `"${item.startImages.length}"`,
            `"${item.endImages.length}"`,
            `"${item.additionalImages.length}"`,
            `"${item.notes || ''}"`
        ].join(',');
        csvContent += row + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
    link.setAttribute('download', `cong_viec_${timestamp}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
            // Xuất file PDF
            exportPDFBtn.addEventListener('click', function() {
                if (workData.length === 0) {
                    alert('📭 Không có dữ liệu để xuất!');
                    return;
                }
                
                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Báo cáo công việc</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #1e5799; text-align: center; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; font-weight: bold; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .footer { margin-top: 30px; text-align: right; font-size: 12px; }
                        </style>
                    </head>
                    <body>
                    <div class="header">
                        <h1>BÁO CÁO CÔNG VIỆC</h1>
                        <p>Ngày xuất: ${new Date().toLocaleDateString('vi-VN')}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên nhân viên</th>
                                <th>Ngày làm việc</th>
                                <th>Công việc</th>
                                <th>Số lượng</th>
                                <th>Ảnh bắt đầu</th>
                                <th>Ảnh kết thúc</th>
                                <th>Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                workData.forEach((item, index) => {
                    htmlContent += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>${formatDate(item.date)}</td>
                            <td>${getWorkTypeLabel(item.workType)}</td>
                            <td>${item.quantity}</td>
                            <td>${item.startImages.length} ảnh</td>
                            <td>${item.endImages.length} ảnh</td>
                            <td>${item.notes || ''}</td>
                        </tr>
                    `;
                });
                
                htmlContent += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>Tổng số bản ghi: ${workData.length}</p>
                    </div>
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.print();
            });
            
            // Hàm lưu dữ liệu vào localStorage
            function saveWorkData() {
                localStorage.setItem('workData', JSON.stringify(workData));
            }
            
            // Hàm tải dữ liệu từ localStorage
            function loadWorkData() {
                const savedData = localStorage.getItem('workData');
                if (savedData) {
                    try {
                        workData = JSON.parse(savedData);
                        updateDataTable();
                    } catch (e) {
                        console.error('Lỗi đọc dữ liệu:', e);
                        workData = [];
                    }
                }
            }
            
            // Hàm cập nhật bảng dữ liệu
            function updateDataTable() {
                dataTableBody.innerHTML = '';
                
                if (workData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px; color: #666;">📝 Chưa có dữ liệu nào được thêm</td>`;
                    dataTableBody.appendChild(row);
                    return;
                }
                
                workData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                workData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const startImagesHtml = item.startImages.length > 0 ? 
                        `<div>${item.startImages.length} ảnh</div>` : 
                        '0 ảnh';
                        
                    const endImagesHtml = item.endImages.length > 0 ? 
                        `<div>${item.endImages.length} ảnh</div>` : 
                        '0 ảnh';
                        
                    const additionalImagesHtml = item.additionalImages.length > 0 ? 
                        `<div>${item.additionalImages.length} ảnh</div>` : 
                        '0 ảnh';
                    
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>${getWorkTypeLabel(item.workType)}</td>
                        <td style="text-align: center;">${item.quantity}</td>
                        <td style="text-align: center;">${startImagesHtml}</td>
                        <td style="text-align: center;">${endImagesHtml}</td>
                        <td style="text-align: center;">${additionalImagesHtml}</td>
                        <td>${item.notes || 'Không có'}</td>
                        <td style="text-align: center;">
                            <button class="btn-view" data-id="${item.id}">👁️ Xem</button>
                            <button class="btn-delete" data-id="${item.id}">🗑️ Xóa</button>
                        </td>
                    `;
                    
                    dataTableBody.appendChild(row);
                });
                
                // Thêm sự kiện xem chi tiết
                document.querySelectorAll('.btn-view').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        const item = workData.find(item => item.id === id);
                        showImageDetail(item);
                    });
                });
                
                // Thêm sự kiện xóa
                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        const item = workData.find(item => item.id === id);
                        if (confirm(`Bạn có chắc muốn xóa dữ liệu của "${item.name}" ngày ${formatDate(item.date)}?`)) {
                            workData = workData.filter(item => item.id !== id);
                            saveWorkData();
                            updateDataTable();
                        }
                    });
                });
            }
            
            // Hàm chuyển đổi mã công việc thành nhãn
            function getWorkTypeLabel(workType) {
                const workTypes = {
                    'ham_ech_tinh_theo_san_pham': 'Hàm ếch tính theo sản phẩm',
                    'nhap_du_lieu_tinh_theo_to': 'Nhập dữ liệu tính theo tờ',
                    'khac': 'Khác'
                };
                return workTypes[workType] || workType;
            }
            
            // Hàm định dạng ngày
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            }
            
            // Tự động đăng nhập nếu đã đăng nhập trước đó
            function checkAutoLogin() {
                const savedData = localStorage.getItem('workData');
                if (savedData) {
                    showDebugInfo('Đã tìm thấy dữ liệu cũ, có thể tự động đăng nhập...');
                }
            }
            
            // Kiểm tra auto login khi trang load
            checkAutoLogin();
        });
    </script>
    
    <!-- Thêm thư viện SheetJS để xuất Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>