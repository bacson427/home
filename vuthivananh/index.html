<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω C√¥ng v√† S·∫£n l∆∞·ª£ng</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        h1 {
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .login-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            max-width: 400px;
            margin: 20px auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background-color: #1e5799;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        button:hover {
            background-color: #154275;
        }
        
        .main-section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -8px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 8px;
            min-width: 200px;
            margin-bottom: 10px;
        }
        
        .image-upload {
            border: 2px dashed #ddd;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .image-upload:hover {
            border-color: #1e5799;
            background-color: #f8f9fa;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .image-preview img {
            width: 80px;
            height: 80px;
            border-radius: 5px;
            object-fit: cover;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        
        .image-preview img:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            font-weight: 600;
            font-size: 13px;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-export {
            background-color: #28a745;
        }
        
        .btn-export:hover {
            background-color: #218838;
        }
        
        .btn-logout {
            background-color: #dc3545;
        }
        
        .btn-logout:hover {
            background-color: #c82333;
        }
        
        .hidden {
            display: none;
        }
        
        .error-message {
            color: #dc3545;
            margin-top: 5px;
            font-size: 13px;
            text-align: center;
        }
        
        .success-message {
            color: #28a745;
            margin-top: 5px;
            font-size: 13px;
            text-align: center;
        }
        
        .btn-delete {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }
        
        .btn-delete:hover {
            background-color: #c82333;
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            flex: 1;
            min-width: 150px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #1e5799;
        }
        
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }
        
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            margin-top: 2%;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .main-section, .login-section {
                padding: 15px;
            }
            
            .form-col {
                min-width: 100%;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 6px;
            }
            
            .export-options {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .image-preview img {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>H·ªÜ TH·ªêNG T√çNH C√îNG V√Ä S·∫¢N L∆Ø·ª¢NG</h1>
            <p>Qu·∫£n l√Ω d·ªØ li·ªáu c√¥ng vi·ªác v√† s·∫£n l∆∞·ª£ng s·∫£n ph·∫©m</p>
        </header>
        
        <section id="loginSection" class="login-section">
            <h2>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h2>
            <div class="form-group">
                <label for="userId">ID ƒëƒÉng nh·∫≠p</label>
                <input type="text" id="userId" placeholder="Nh·∫≠p ID ƒëƒÉng nh·∫≠p" value="0388427368">
            </div>
            <div class="form-group">
                <label for="password">M·∫≠t kh·∫©u</label>
                <input type="password" id="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" value="@Van2007">
            </div>
            <button id="loginBtn">ƒêƒÉng nh·∫≠p</button>
            <div id="loginMessage" class="error-message"></div>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </section>
    <section id="mainSection" class="main-section">
        <h2>Nh·∫≠p d·ªØ li·ªáu c√¥ng vi·ªác</h2>
        <form id="workForm">
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="name">T√™n nh√¢n vi√™n *</label>
                        <input type="text" id="name" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="date">Ng√†y th√°ng nƒÉm *</label>
                        <input type="date" id="date" required>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="startImage">·∫¢nh b·∫Øt ƒë·∫ßu *</label>
                        <div class="image-upload" id="startImageUpload">
                            <p>üì∑ Nh·∫•p ƒë·ªÉ t·∫£i ·∫£nh l√™n</p>
                            <input type="file" id="startImage" accept="image/*" class="hidden" multiple>
                        </div>
                        <div id="startImagePreview" class="image-preview"></div>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="endImage">·∫¢nh k·∫øt th√∫c *</label>
                        <div class="image-upload" id="endImageUpload">
                            <p>üì∑ Nh·∫•p ƒë·ªÉ t·∫£i ·∫£nh l√™n</p>
                            <input type="file" id="endImage" accept="image/*" class="hidden" multiple>
                        </div>
                        <div id="endImagePreview" class="image-preview"></div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="additionalImage">·∫¢nh b·ªï sung (t√πy ch·ªçn)</label>
                <div class="image-upload" id="additionalImageUpload">
                    <p>üì∑ Nh·∫•p ƒë·ªÉ t·∫£i ·∫£nh b·ªï sung</p>
                    <input type="file" id="additionalImage" accept="image/*" class="hidden" multiple>
                </div>
                <div id="additionalImagePreview" class="image-preview"></div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="workType">C√¥ng vi·ªác *</label>
                        <select id="workType" required>
                            <option value="">-- Ch·ªçn c√¥ng vi·ªác --</option>
                            <option value="nhap_du_lieu">Nh·∫≠p d·ªØ li·ªáu</option>
                            <option value="ham_ech">H√†m ·∫øch</option>
                            <option value="san_luong">S·∫£n l∆∞·ª£ng</option>
                            <option value="them">Th√™m</option>
                            <option value="ham_ech_tinh_theo_san_pham">H√†m ·∫øch t√≠nh theo s·∫£n ph·∫©m</option>
                            <option value="nhap_du_lieu_tinh_theo_to">Nh·∫≠p d·ªØ li·ªáu t√≠nh theo t·ªù</option>
                            <option value="khac">Kh√°c</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="quantity">S·ªë l∆∞·ª£ng</label>
                        <input type="number" id="quantity" min="0" step="1" placeholder="0">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes">Ghi ch√∫</label>
                <textarea id="notes" rows="2" placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."></textarea>
            </div>
            
            <div id="uploadLoading" class="loading" style="display: none;">
                <p>üîÑ ƒêang t·∫£i ·∫£nh l√™n ƒë√°m m√¢y... Vui l√≤ng ch·ªù</p>
            </div>
            
            <button type="submit" id="submitBtn">‚ûï Th√™m d·ªØ li·ªáu</button>
            <div id="formMessage" class="success-message"></div>
        </form>
        
        <h2>D·ªØ li·ªáu ƒë√£ nh·∫≠p</h2>
        <div style="overflow-x: auto;">
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th>T√™n</th>
                        <th>Ng√†y</th>
                        <th>C√¥ng vi·ªác</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>·∫¢nh b·∫Øt ƒë·∫ßu</th>
                        <th>·∫¢nh k·∫øt th√∫c</th>
                        <th>·∫¢nh b·ªï sung</th>
                        <th>Ghi ch√∫</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>
        
        <h3>Xu·∫•t d·ªØ li·ªáu</h3>
        <div class="export-options">
            <button id="exportExcelBtn" class="btn-export export-btn">üìä Xu·∫•t Excel (.xlsx)</button>
            <button id="exportCSVBtn" class="btn-export export-btn" style="background-color: #17a2b8;">üìÑ Xu·∫•t CSV</button>
            <button id="exportPDFBtn" class="btn-export export-btn" style="background-color: #dc3545;">üìã Xu·∫•t PDF</button>
        </div>
        
        <div class="action-buttons">
            <button id="clearDataBtn" class="btn-logout" style="background-color: #ffc107; color: #000;">üóëÔ∏è X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
            <button id="logoutBtn" class="btn-logout">üö™ ƒêƒÉng xu·∫•t</button>
        </div>
    </section>
</div>

<!-- Modal xem ·∫£nh -->
<div id="imageModal" class="image-modal">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImage">
</div>
<script>
    // ===== PH·∫¶N JAVASCRIPT =====
    document.addEventListener('DOMContentLoaded', function() {
        // Bi·∫øn to√†n c·ª•c
        let workData = [];
        
        // Th√¥ng tin ƒëƒÉng nh·∫≠p
        const ADMIN_ID = '0388427368';
        const ADMIN_PASSWORD = '@Van2007';
        
        // API Key ImgBB - MI·ªÑN PH√ç, ·∫£nh t·ª± ƒë·ªông x√≥a sau 60 ng√†y
        const IMGBB_API_KEY = '6d4ce2df8f6b6e47e5c6e86a9e715c0a';
        
        // Tham chi·∫øu ƒë·∫øn c√°c ph·∫ßn t·ª≠ DOM
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');
        const debugInfo = document.getElementById('debugInfo');
        const workForm = document.getElementById('workForm');
        const dataTableBody = document.getElementById('dataTableBody');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportCSVBtn = document.getElementById('exportCSVBtn');
        const exportPDFBtn = document.getElementById('exportPDFBtn');
        const uploadLoading = document.getElementById('uploadLoading');
        const submitBtn = document.getElementById('submitBtn');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.querySelector('.close-modal');
        
        // Hi·ªÉn th·ªã th√¥ng tin debug
        function showDebugInfo(message) {
            debugInfo.style.display = 'block';
            debugInfo.innerHTML = '<strong>Debug:</strong> ' + message;
            console.log('Debug:', message);
        }
        
        // Modal xem ·∫£nh
        closeModal.addEventListener('click', function() {
            imageModal.style.display = 'none';
        });
        
        imageModal.addEventListener('click', function(e) {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });
        
        // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
        document.getElementById('date').valueAsDate = new Date();
        
        // X·ª≠ l√Ω s·ª± ki·ªán ƒëƒÉng nh·∫≠p
        loginBtn.addEventListener('click', handleLogin);
        
        // Cho ph√©p ƒëƒÉng nh·∫≠p b·∫±ng ph√≠m Enter
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        function handleLogin() {
            const userId = userIdInput.value.trim();
            const password = passwordInput.value.trim();
            
            showDebugInfo(`Nh·∫≠p: ID='${userId}', Password='${password}' | Mong ƒë·ª£i: ID='${ADMIN_ID}', Password='${ADMIN_PASSWORD}'`);
            
            if (userId === ADMIN_ID && password === ADMIN_PASSWORD) {
                showDebugInfo('‚úÖ ƒêƒÉng nh·∫≠p TH√ÄNH C√îNG!');
                loginSection.style.display = 'none';
                mainSection.style.display = 'block';
                loginMessage.textContent = '';
                loadWorkData();
            } else {
                let errorMsg = 'ID ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                
                if (userId !== ADMIN_ID) {
                    errorMsg += ' (Sai ID)';
                } else if (password !== ADMIN_PASSWORD) {
                    errorMsg += ' (Sai m·∫≠t kh·∫©u)';
                }
                
                loginMessage.textContent = errorMsg;
                showDebugInfo('‚ùå ƒêƒÉng nh·∫≠p TH·∫§T B·∫†I: ' + errorMsg);
                userIdInput.focus();
            }
        }
        
        // X·ª≠ l√Ω s·ª± ki·ªán ƒëƒÉng xu·∫•t
        logoutBtn.addEventListener('click', function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                mainSection.style.display = 'none';
                loginSection.style.display = 'block';
                userIdInput.value = '';
                passwordInput.value = '';
                debugInfo.style.display = 'none';
                userIdInput.focus();
            }
        });
        
        // X·ª≠ l√Ω x√≥a to√†n b·ªô d·ªØ li·ªáu
        clearDataBtn.addEventListener('click', function() {
            if (confirm('‚ö†Ô∏è B·∫°n c√≥ CH·∫ÆC CH·∫ÆN mu·ªën x√≥a TO√ÄN B·ªò d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                workData = [];
                localStorage.removeItem('workData');
                updateDataTable();
                alert('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!');
            }
        });
/ X·ª≠ l√Ω upload ·∫£nh
            const imageUploads = [
                { upload: 'startImageUpload', input: 'startImage', preview: 'startImagePreview', type: 'start' },
                { upload: 'endImageUpload', input: 'endImage', preview: 'endImagePreview', type: 'end' },
                { upload: 'additionalImageUpload', input: 'additionalImage', preview: 'additionalImagePreview', type: 'additional' }
            ];
            
            let currentImages = {
                start: [],
                end: [],
                additional: []
            };
            
            imageUploads.forEach(item => {
                const uploadElement = document.getElementById(item.upload);
                const inputElement = document.getElementById(item.input);
                const previewElement = document.getElementById(item.preview);
                
                uploadElement.addEventListener('click', function() {
                    inputElement.click();
                });
                
                inputElement.addEventListener('change', function() {
                    previewElement.innerHTML = '';
                    currentImages[item.type] = [];
                    
                    if (inputElement.files) {
                        Array.from(inputElement.files).forEach(file => {
                            if (file.type.startsWith('image/')) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    currentImages[item.type].push({
                                        name: file.name,
                                        data: e.target.result,
                                        type: file.type,
                                        size: file.size,
                                        file: file
                                    });
                                    
                                    const img = document.createElement('img');
                                    img.src = e.target.result;
                                    img.title = file.name;
                                    img.onclick = function() {
                                        modalImage.src = this.src;
                                        imageModal.style.display = 'block';
                                    };
                                    previewElement.appendChild(img);
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                    }
                });
            });
            
            // H√†m upload ·∫£nh l√™n ImgBB
            async function uploadImageToCloud(imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);
                
                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        return {
                            url: data.data.url,
                            delete_url: data.data.delete_url,
                            thumb: data.data.thumb.url,
                            name: imageFile.name,
                            size: imageFile.size,
                            upload_time: new Date().toISOString()
                        };
                    } else {
                        throw new Error(data.error.message || 'Upload failed');
                    }
                } catch (error) {
                    console.error('L·ªói upload ·∫£nh:', error);
                    throw error;
                }
            }
            
            // X·ª≠ l√Ω form th√™m d·ªØ li·ªáu
            workForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('name').value.trim();
                const date = document.getElementById('date').value;
                const workType = document.getElementById('workType').value;
                const quantity = document.getElementById('quantity').value || '0';
                const notes = document.getElementById('notes').value.trim();
                
                if (currentImages.start.length === 0 || currentImages.end.length === 0) {
                    alert('‚ö†Ô∏è Vui l√≤ng t·∫£i l√™n ·∫£nh b·∫Øt ƒë·∫ßu v√† ·∫£nh k·∫øt th√∫c!');
                    return;
                }
                
                if (!workType) {
                    alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn lo·∫°i c√¥ng vi·ªác!');
                    return;
                }
                
                // Hi·ªÉn th·ªã loading
                uploadLoading.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.textContent = 'üîÑ ƒêang t·∫£i ·∫£nh l√™n...';
                
                try {
      // Upload t·∫•t c·∫£ ·∫£nh l√™n cloud
                    const uploadPromises = {
                        start: Promise.all(currentImages.start.map(img => uploadImageToCloud(img.file))),
                        end: Promise.all(currentImages.end.map(img => uploadImageToCloud(img.file))),
                        additional: currentImages.additional.length > 0 ? 
                            Promise.all(currentImages.additional.map(img => uploadImageToCloud(img.file))) : 
                            Promise.resolve([])
                    };
                    
                    const [startImages, endImages, additionalImages] = await Promise.all([
                        uploadPromises.start,
                        uploadPromises.end,
                        uploadPromises.additional
                    ]);
                    
                    // T·∫°o ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu c√¥ng vi·ªác
                    const workItem = {
                        id: Date.now(),
                        name: name,
                        date: date,
                        workType: workType,
                        quantity: quantity,
                        notes: notes,
                        startImages: startImages,
                        endImages: endImages,
                        additionalImages: additionalImages,
                        created_at: new Date().toISOString()
                    };
                    
                    workData.push(workItem);
                    saveWorkData();
                    updateDataTable();
                    
                    workForm.reset();
                    document.getElementById('startImagePreview').innerHTML = '';
                    document.getElementById('endImagePreview').innerHTML = '';
                    document.getElementById('additionalImagePreview').innerHTML = '';
                    document.getElementById('date').valueAsDate = new Date();
                    
                    currentImages = {
                        start: [],
                        end: [],
                        additional: []
                    };
                    
                    document.getElementById('formMessage').textContent = '‚úÖ ƒê√£ th√™m d·ªØ li·ªáu th√†nh c√¥ng! ·∫¢nh ƒë√£ ƒë∆∞·ª£c l∆∞u l√™n ƒë√°m m√¢y (60 ng√†y)';
                    setTimeout(() => {
                        document.getElementById('formMessage').textContent = '';
                    }, 5000);
                    
                } catch (error) {
                    console.error('L·ªói khi th√™m d·ªØ li·ªáu:', error);
                    alert('‚ùå L·ªói khi t·∫£i ·∫£nh l√™n ƒë√°m m√¢y. Vui l√≤ng th·ª≠ l·∫°i!');
                } finally {
                    // ·∫®n loading
                    uploadLoading.style.display = 'none';
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚ûï Th√™m d·ªØ li·ªáu';
                }
            });
            
            // Xu·∫•t file Excel
            exportExcelBtn.addEventListener('click', function() {
                if (workData.length === 0) {
                    alert('üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ['D·ªÆ LI·ªÜU C√îNG VI·ªÜC', '', '', '', '', '', '', '', ''],
                    ['Xu·∫•t ng√†y:', new Date().toLocaleDateString('vi-VN'), '', '', '', '', '', '', ''],
                    [],
                    ['STT', 'T√™n nh√¢n vi√™n', 'Ng√†y l√†m vi·ªác', 'C√¥ng vi·ªác', 'S·ªë l∆∞·ª£ng', 'Link ·∫£nh b·∫Øt ƒë·∫ßu', 'Link ·∫£nh k·∫øt th√∫c', 'Link ·∫£nh b·ªï sung', 'Ghi ch√∫']
                ];
                
                workData.forEach((item, index) => {
                    const startImageLinks = item.startImages.map(img => img.url).join('\n');
                    const endImageLinks = item.endImages.map(img => img.url).join('\n');
                    const additionalImageLinks = item.additionalImages.map(img => img.url).join('\n');
                    
                    wsData.push([
                        index + 1,
                        item.name,
                        formatDate(item.date),
                        getWorkTypeLabel(item.workType),
                        item.quantity,
                        startImageLinks,
                        endImageLinks,
                        additionalImageLinks,
                        item.notes || ''
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const colWidths = [
                    { wch: 5 }, { wch: 20 }, { wch: 12 }, { wch: 25 }, { wch: 10 },
                    { wch: 30 }, { wch: 30 }, { wch: 30 }, { wch: 30 }
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'CongViec');
                const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
                XLSX.writeFile(wb, `cong_viec_${timestamp}.xlsx`);
                
                alert('‚úÖ ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!\n\nüìù File ch·ª©a link ·∫£nh tr·ª±c ti·∫øp t·ª´ ƒë√°m m√¢y');
            });
            
            // Xu·∫•t file CSV
            exportCSVBtn.addEventListener('click', function() {
                if (workData.length === 0) {
                    alert('üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                    return;
                }
                
                const BOM = '\uFEFF';
                let csvContent = BOM + "STT,T√™n nh√¢n vi√™n,Ng√†y l√†m vi·ªác,C√¥ng vi·ªác,S·ªë l∆∞·ª£ng,Link ·∫£nh b·∫Øt ƒë·∫ßu,Link ·∫£nh k·∫øt th√∫c,Link ·∫£nh b·ªï sung,Ghi ch√∫\n";
                
                workData.forEach((item, index) => {
                    const startImageLinks = item.startImages.map(img => img.url).join(' | ');
                    const endImageLinks = item.endImages.map(img => img.url).join(' | ');
                    const additionalImageLinks = item.additionalImages.map(img => img.url).join(' | ');
                    
                    const row = [
                        index + 1,
                        `"${item.name}"`,
                        `"${formatDate(item.date)}"`,
                        `"${getWorkTypeLabel(item.workType)}"`,
                        `"${item.quantity}"`,
                        `"${startImageLinks}"`,
                        `"${endImageLinks}"`,
                        `"${additionalImageLinks}"`,
                        `"${item.notes || ''}"`
                    ].join(',');
                    csvContent += row + '\n';
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
                link.setAttribute('download', `cong_viec_${timestamp}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // Xu·∫•t file PDF
            exportPDFBtn.addEventListener('click', function() {
                if (workData.length === 0) {
                    alert('üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                    return;
                }
                
                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>B√°o c√°o c√¥ng vi·ªác</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #1e5799; text-align: center; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; font-weight: bold; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .footer { margin-top: 30px; text-align: right; font-size: 12px; }
                            .image-links { font-size: 10px; color: #666; }
                        </style>
                    </head>
                    <body>
                    <div class="header">
                        <h1>B√ÅO C√ÅO C√îNG VI·ªÜC</h1>
                        <p>Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}</p>
                        <p><em>·∫¢nh ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông tr√™n ƒë√°m m√¢y (60 ng√†y)</em></p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>T√™n nh√¢n vi√™n</th>
                                <th>Ng√†y l√†m vi·ªác</th>
                                <th>C√¥ng vi·ªác</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>·∫¢nh b·∫Øt ƒë·∫ßu</th>
                                <th>·∫¢nh k·∫øt th√∫c</th>
                                <th>Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                workData.forEach((item, index) => {
                    htmlContent += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>${formatDate(item.date)}</td>
                            <td>${getWorkTypeLabel(item.workType)}</td>
                            <td>${item.quantity}</td>
                            <td class="image-links">${item.startImages.length} ·∫£nh</td>
                            <td class="image-links">${item.endImages.length} ·∫£nh</td>
                            <td>${item.notes || ''}</td>
                        </tr>
                    `;
                });
                
                htmlContent += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>T·ªïng s·ªë b·∫£n ghi: ${workData.length}</p>
                        <p><em>Link ·∫£nh chi ti·∫øt xem trong file Excel/CSV</em></p>
                    </div>
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.print();
            });
            
            // H√†m l∆∞u d·ªØ li·ªáu v√†o localStorage
            function saveWorkData() {
                localStorage.setItem('workData', JSON.stringify(workData));
            }
            
            // H√†m t·∫£i d·ªØ li·ªáu t·ª´ localStorage
            function loadWorkData() {
                const savedData = localStorage.getItem('workData');
                if (savedData) {
                    try {
                        workData = JSON.parse(savedData);
                        updateDataTable();
                    } catch (e) {
                        console.error('L·ªói ƒë·ªçc d·ªØ li·ªáu:', e);
                        workData = [];
                    }
                }
            }
            
            // H√†m c·∫≠p nh·∫≠t b·∫£ng d·ªØ li·ªáu
            function updateDataTable() {
                dataTableBody.innerHTML = '';
                
                if (workData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px; color: #666;">üìù Ch∆∞a c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c th√™m</td>`;
                    dataTableBody.appendChild(row);
                    return;
                }
                
                workData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                workData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // T·∫°o HTML cho ·∫£nh v·ªõi link xem
                    const startImagesHtml = item.startImages.length > 0 ? 
                        `<div>${item.startImages.length} ·∫£nh<br><small><a href="${item.startImages[0].url}" target="_blank">Xem ·∫£nh</a></small></div>` : 
                        '0 ·∫£nh';
                        
                    const endImagesHtml = item.endImages.length > 0 ? 
                        `<div>${item.endImages.length} ·∫£nh<br><small><a href="${item.endImages[0].url}" target="_blank">Xem ·∫£nh</a></small></div>` : 
                        '0 ·∫£nh';
                        
                    const additionalImagesHtml = item.additionalImages.length > 0 ? 
                        `<div>${item.additionalImages.length} ·∫£nh<br><small><a href="${item.additionalImages[0].url}" target="_blank">Xem ·∫£nh</a></small></div>` : 
                        '0 ·∫£nh';
                    
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>${getWorkTypeLabel(item.workType)}</td>
                        <td style="text-align: center;">${item.quantity}</td>
                        <td style="text-align: center;">${startImagesHtml}</td>
                        <td style="text-align: center;">${endImagesHtml}</td>
                        <td style="text-align: center;">${additionalImagesHtml}</td>
                        <td>${item.notes || 'Kh√¥ng c√≥'}</td>
                        <td style="text-align: center;">
                            <button class="btn-delete" data-id="${item.id}">üóëÔ∏è X√≥a</button>
                        </td>
                    `;
                    
                    dataTableBody.appendChild(row);
                });
                
                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        const item = workData.find(item => item.id === id);
                        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ªØ li·ªáu c·ªßa "${item.name}" ng√†y ${formatDate(item.date)}?`)) {
                            workData = workData.filter(item => item.id !== id);
                            saveWorkData();
                            updateDataTable();
                        }
                    });
                });
            }
            
            // H√†m chuy·ªÉn ƒë·ªïi m√£ c√¥ng vi·ªác th√†nh nh√£n
            function getWorkTypeLabel(workType) {
                const workTypes = {
                    'nhap_du_lieu': 'Nh·∫≠p d·ªØ li·ªáu',
                    'ham_ech': 'H√†m ·∫øch',
                    'san_luong': 'S·∫£n l∆∞·ª£ng',
                    'them': 'Th√™m',
                    'ham_ech_tinh_theo_san_pham': 'H√†m ·∫øch t√≠nh theo s·∫£n ph·∫©m',
                    'nhap_du_lieu_tinh_theo_to': 'Nh·∫≠p d·ªØ li·ªáu t√≠nh theo t·ªù',
                    'khac': 'Kh√°c'
                };
                return workTypes[workType] || workType;
            }
            
            // H√†m ƒë·ªãnh d·∫°ng ng√†y
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            }
            
            // T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë√≥
            function checkAutoLogin() {
                const savedData = localStorage.getItem('workData');
                if (savedData) {
                    showDebugInfo('ƒê√£ t√¨m th·∫•y d·ªØ li·ªáu c≈©, c√≥ th·ªÉ t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p...');
                }
            }
            
            // Ki·ªÉm tra auto login khi trang load
            checkAutoLogin();
        });
    </script>
    
    <!-- Th√™m th∆∞ vi·ªán SheetJS ƒë·ªÉ xu·∫•t Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>