<!DOCTYPE html>
<html>
<head>
    <title>Hiệu Ứng Hạt Sáng Theo Nhạc</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            position: relative;
        }

        /* Biểu tượng phát nhạc (thay cho đĩa CD) */
        .cd-icon {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            z-index: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cd-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Nút Play/Pause */
        #playPauseBtn {
            padding: 10px 25px;
            font-size: 18px;
            background-color: #8a2be2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 3;
            margin-top: 100px; /* Đặt nút phía dưới trung tâm */
        }
        
        /* Vùng chứa Canvas cho các hạt */
        #particleCanvas {
            position: fixed; /* Cố định trên toàn màn hình */
            top: 0;
            left: 0;
            z-index: 0;
        }

    </style>
</head>
<body>

    <h2 style="text-align: center; z-index: 2;">Hiệu Ứng Hạt Sáng</h2>

    <canvas id="particleCanvas"></canvas>

    <div class="cd-icon" id="cdIcon">
        <span id="playState" style="font-size: 30px;">▶</span>
    </div>

    <button id="playPauseBtn" style="display: none;">Play/Pause</button> 

    <script>
        // --- Cấu hình ---
        const musicUrl = 'https://nguyenbacson.io.vn/nguyenbacson.mp3';
        const numParticles = 100; // Số lượng hạt lớn hơn
        const particles = [];
        let audio;
        let audioContext;
        let analyser;
        let source;
        let animationFrameId;
        let isPlaying = false;

        // --- Thiết lập Canvas ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // --- Thiết lập Hạt Sáng (Particle) ---
        class Particle {
            constructor(maxSize) {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.radius = Math.random() * 1 + 0.5; // Kích thước cơ bản nhỏ
                this.maxRadius = Math.random() * maxSize + 2; // Kích thước tối đa khi phóng to
                this.color = `hsl(${Math.random() * 360}, 100%, 70%)`; // Màu ngẫu nhiên
                this.velocity = {
                    x: (Math.random() - 0.5) * 0.5,
                    y: (Math.random() - 0.5) * 0.5
                };
                this.opacity = 0;
                this.life = 0;
                this.maxLife = Math.random() * 300 + 100; // Thời gian sống ngẫu nhiên
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = this.radius * 2; // Hiệu ứng phát sáng
                ctx.globalAlpha = this.opacity;
                ctx.fill();
            }

            update(averageAmplitude) {
                // Di chuyển
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                
                // Giữ hạt trong màn hình (tùy chọn)
                if (this.x < 0 || this.x > canvas.width) this.velocity.x *= -1;
                if (this.y < 0 || this.y > canvas.height) this.velocity.y *= -1;

                this.life++;

                // --- Phóng to kích thước theo nhạc ---
                // Tăng kích thước theo cường độ âm thanh, giới hạn ở maxRadius
                const sizeFactor = 1 + (averageAmplitude / 300); // 300 là một hệ số điều chỉnh
                this.radius = Math.min(this.maxRadius, this.maxRadius * sizeFactor);

                // --- Nháy sáng (Thay đổi Opacity) theo thời gian sống ---
                if (this.life < this.maxLife * 0.2) {
                    // Xuất hiện
                    this.opacity += 0.02; 
                } else if (this.life > this.maxLife * 0.8) {
                    // Biến mất
                    this.opacity -= 0.01;
                } else {
                    // Giữ ổn định và nhấp nháy nhẹ (làm nó "nháy sáng")
                    this.opacity = 0.5 + (Math.sin(this.life * 0.1) * 0.5); // Dao động nhẹ
                }
                
                this.opacity = Math.max(0, Math.min(1, this.opacity)); // Đảm bảo opacity trong khoảng 0-1

                // Tái tạo hạt nếu hết đời
                if (this.life >= this.maxLife) {
                    this.reset();
                }
            }

            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.life = 0;
                this.opacity = 0;
                this.maxLife = Math.random() * 300 + 100;
                this.maxRadius = Math.random() * 4 + 2;
                this.color = `hsl(${Math.random() * 360}, 100%, 70%)`;
            }
        }

        // Tạo các hạt
        for (let i = 0; i < numParticles; i++) {
            particles.push(new Particle(4)); // Kích thước hạt tối đa là 4
        }

        // --- Logic Xử lý Âm thanh ---
        function setupAudio() {
            audio = new Audio(musicUrl);
            audio.crossOrigin = "anonymous"; // Rất quan trọng để Web Audio API hoạt động
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256; 

            source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
        }

        // Vòng lặp chính để vẽ và cập nhật
        function animate() {
            animationFrameId = requestAnimationFrame(animate);

            // Xóa Canvas cho khung hình mới
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.globalAlpha = 1; // Đảm bảo độ trong suốt ban đầu là 1

            if (isPlaying) {
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const averageAmplitude = sum / dataArray.length; // Độ lớn âm thanh trung bình

                particles.forEach(p => {
                    p.update(averageAmplitude);
                    p.draw();
                });
            } else {
                 // Khi tạm dừng, chỉ vẽ các hạt nhưng không cập nhật kích thước theo nhạc
                 particles.forEach(p => {
                    p.draw();
                 });
            }
        }

        // --- Điều khiển Play/Pause ---
        const cdIcon = document.getElementById('cdIcon');
        const playState = document.getElementById('playState');

        function togglePlayback() {
            if (!audioContext) {
                setupAudio(); // Thiết lập Audio lần đầu
                animate(); // Bắt đầu vòng lặp animation
            }

            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                playState.textContent = '▶';
                cdIcon.classList.remove('playing');
            } else {
                // Phải bắt đầu AudioContext từ sự kiện tương tác của người dùng
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                audio.play();
                isPlaying = true;
                playState.textContent = '⏸';
                cdIcon.classList.add('playing');
            }
        }

        cdIcon.addEventListener('click', togglePlayback);
        // Bắt đầu vòng lặp animation ngay cả khi chưa play để thấy các hạt tĩnh
        // Tuy nhiên, logic chỉ được cập nhật kích thước khi isPlaying = true
        animate(); 

    </script>
</body>
</html>
